define(["jquery","storage","plugins/md5","eventer"],function(e,t,n,r){var i,s;typeof exports!="undefined"?(i=require("xmlhttprequest").XMLHttpRequest,s=require("underscore"),btoa=require("btoa")):s=window._,typeof window!="undefined"&&typeof window.XMLHttpRequest!="undefined"&&(i=window.XMLHttpRequest);var o="https://api.github.com",u=function(e){function f(r,s,u,f,l,c){function h(){var e=s.indexOf("//")>=0?s:o+s;return e}a._trigger("request",r,s,u,l,c);var p=new i,d=h();p.open(r,d,!c);if(e.cache===!0){var v=n(r+s+(u?JSON.stringify(u):"")),m=t.get(v+":ETag");m&&p.setRequestHeader("If-None-Match",m)}c||(p.onreadystatechange=function(){a._trigger("response",this);if(this.readyState==4)if(this.status===304)f(null,e.cache?t.get(v,{json:!0}):"",this);else if(this.status>=200&&this.status<300){var n=l?this.responseText:this.responseText?JSON.parse(this.responseText):!0;if(e.cache===!0){var r=e.cacheDaysExpire*24*60*60*60;t.set(v+":ETag",this.getResponseHeader("ETag"),{expires:r}),t.set(v,n,{json:!0,expires:r})}f(null,n,this)}else f({path:s,request:this,error:this.status})}),l?p.setRequestHeader("Accept","application/vnd.github.v3.raw+json"):(p.dataType="json",p.setRequestHeader("Accept","application/vnd.github.v3+json")),p.setRequestHeader("Content-Type","application/json;charset=UTF-8");if(e.token||e.username&&e.password){var g=e.token?"token "+e.token:"Basic "+btoa(e.username+":"+e.password);p.setRequestHeader("Authorization",g)}u?p.send(JSON.stringify(u)):p.send();if(c)return p.response}function l(e,t){var n=[];(function r(){f("GET",e,null,function(i,o,u){if(i)return t(i);n.push.apply(n,o);var a=(u.getResponseHeader("link")||"").split(/\s*,\s*/g),f=s.find(a,function(e){return/rel="next"/.test(e)});f&&(f=(/<(.*)>/.exec(f)||[])[1]),f?(e=f,r()):t(i,n)})})()}e=e||{},e.cache=e.cache||!0,e.cacheDaysExpire=e.cacheDaysExpire||30,r("github",this);var a=this;this._defineEvent("request"),this._defineEvent("response"),this.setOption=function(t,n){e[t]=n},this.setAccessToken=function(t){e.token=t},this.setUsername=function(t){e.username=t},this.setPassword=function(t){e.password=t},this.setAuth=function(t){e.auth=t},this.getOptions=function(){return e},u.User=function(){this.repos=function(e){l("/user/repos?type=all&per_page=1000&sort=updated",function(t,n){e(t,n)})},this.orgs=function(e){f("GET","/user/orgs",null,function(t,n,r){e(t,n,r)})},this.gists=function(e){f("GET","/gists",null,function(t,n){e(t,n)})},this.notifications=function(e){f("GET","/notifications",null,function(t,n){e(t,n)})},this.show=function(e,t){var n=e?"/users/"+e:"/user";f("GET",n,null,function(e,n){t(e,n)})},this.userRepos=function(e,t){l("/users/"+e+"/repos?type=all&per_page=1000&sort=updated",function(e,n){t(e,n)})},this.userGists=function(e,t){f("GET","/users/"+e+"/gists",null,function(e,n){t(e,n)})},this.orgRepos=function(e,t){l("/orgs/"+e+"/repos?type=all&&page_num=1000&sort=updated&direction=desc",function(e,n){t(e,n)})},this.follow=function(e,t){f("PUT","/user/following/"+e,null,function(e,n){t(e,n)})},this.unfollow=function(e,t){f("DELETE","/user/following/"+e,null,function(e,n){t(e,n)})},this.createRepo=function(e,t){f("POST","/user/repos",e,t)}},u.Repository=function(e){function a(e,t){if(e===o.branch&&o.sha)return t(null,o.sha);r.getRef("heads/"+e,function(n,r){o.branch=e,o.sha=r,t(n,r)})}var t=e.name,n=e.user,r=this,i="/repos/"+n+"/"+t,o={branch:null,sha:null};this.deleteRepo=function(t){f("DELETE",i,e,t)},this.getRef=function(e,t){f("GET",i+"/git/refs/"+e,null,function(e,n){if(e)return t(e);t(null,n.object.sha)})},this.createRef=function(e,t){f("POST",i+"/git/refs",e,t)},this.deleteRef=function(t,n){f("DELETE",i+"/git/refs/"+t,e,n)},this.createRepo=function(e,t){f("POST","/user/repos",e,t)},this.deleteRepo=function(t){f("DELETE",i,e,t)},this.listTags=function(e){f("GET",i+"/tags",null,function(t,n){if(t)return e(t);e(null,n)})},this.listPulls=function(e,t){f("GET",i+"/pulls"+(e?"?state="+e:""),null,function(e,n){if(e)return t(e);t(null,n)})},this.getPull=function(e,t){f("GET",i+"/pulls/"+e,null,function(e,n){if(e)return t(e);t(null,n)})},this.compare=function(e,t,n){f("GET",i+"/compare/"+e+"..."+t,null,function(e,t){if(e)return n(e);n(null,t)})},this.listBranches=function(e){f("GET",i+"/git/refs/heads",null,function(t,n){if(t)return e(t);e(null,s.map(n,function(e){return s.last(e.ref.split("/"))}))})},this.getBlob=function(e,t){f("GET",i+"/git/blobs/"+e,null,t,"raw")},this.getCommit=function(e,t,n){f("GET",i+"/git/commits/"+t,null,function(e,t){if(e)return n(e);n(null,t)})},this.getSha=function(e,t,n){if(!t||t==="")return r.getRef("heads/"+e,n);f("GET",i+"/contents/"+t,{ref:e},function(e,t){if(e)return n(e);n(null,t.sha)})},this.getTree=function(e,t){f("GET",i+"/git/trees/"+e,null,function(e,n){if(e)return t(e);t(null,n.tree)})},this.postBlob=function(e,t){typeof e=="string"?e={content:e,encoding:"utf-8"}:e={content:btoa(String.fromCharCode.apply(null,new Uint8Array(e))),encoding:"base64"},f("POST",i+"/git/blobs",e,function(e,n){if(e)return t(e);t(null,n.sha)})},this.updateTree=function(e,t,n,r){var s={base_tree:e,tree:[{path:t,mode:"100644",type:"blob",sha:n}]};f("POST",i+"/git/trees",s,function(e,t){if(e)return r(e);r(null,t.sha)})},this.postTree=function(e,t){f("POST",i+"/git/trees",{tree:e},function(e,n){if(e)return t(e);t(null,n.sha)})},this.commit=function(t,n,r,s){var a=new u.User;a.show(null,function(u,a){if(u)return s(u);var l={message:r,author:{name:e.user,email:a.email},parents:[t],tree:n};f("POST",i+"/git/commits",l,function(e,t){if(e)return s(e);o.sha=t.sha,s(null,t.sha)})})},this.updateHead=function(e,t,n){f("PATCH",i+"/git/refs/heads/"+e,{sha:t},function(e,t){n(e)})},this.show=function(e){f("GET",i,null,e)},this.contents=function(e,t,n){f("GET",i+"/contents/"+t,{ref:e},n)},this.fork=function(e){f("POST",i+"/forks",null,e)},this.branch=function(e,t,n){arguments.length===2&&typeof arguments[1]=="function"&&(n=t,t=e,e="master"),this.getRef("heads/"+e,function(e,i){if(e&&n)return n(e);r.createRef({ref:"refs/heads/"+t,sha:i},n)})},this.createPullRequest=function(e,t){f("POST",i+"/pulls",e,t)},this.listHooks=function(e){f("GET",i+"/hooks",null,e)},this.getHook=function(e,t){f("GET",i+"/hooks/"+e,null,t)},this.createHook=function(e,t){f("POST",i+"/hooks",e,t)},this.editHook=function(e,t,n){f("PATCH",i+"/hooks/"+e,t,n)},this.deleteHook=function(e,t){f("DELETE",i+"/hooks/"+e,null,t)},this.read=function(e,t,n){f("GET",i+"/contents/"+t,{ref:e},function(e,t){if(e&&e.error===404)return n("not found",null,null);if(e)return n(e);n(null,t)},!0)},this.remove=function(e,t,n){r.getSha(e,t,function(r,s){if(r)return n(r);f("DELETE",i+"/contents/"+t,{message:t+" is removed",sha:s,branch:e},n)})},this.delete=function(e,t,n){r.getSha(e,t,function(r,s){if(!s)return n("not found",null);var o=i+"/contents/"+t,u={message:"Deleted "+t,sha:s};o+="?message="+encodeURIComponent(u.message),o+="&sha="+encodeURIComponent(u.sha),o+="&branch="+encodeURIComponent(e),f("DELETE",o,null,n)})},this.move=function(e,t,n,i){a(e,function(o,u){r.getTree(u+"?recursive=true",function(o,a){s.each(a,function(e){e.path===t&&(e.path=n),e.type==="tree"&&delete e.sha}),r.postTree(a,function(n,s){r.commit(u,s,"Deleted "+t,function(t,n){r.updateHead(e,n,function(e){i(e)})})})})})},this.write=function(e,t,n,s,o){r.getSha(e,t,function(r,u){if(r&&r.error!=404)return o(r);f("PUT",i+"/contents/"+t,{path:t,message:s,content:btoa(n),branch:e,sha:u},o)})},this.getCommits=function(e,t){e=e||{};var n=i+"/commits",r=[];e.sha&&r.push("sha="+encodeURIComponent(e.sha)),e.path&&r.push("path="+encodeURIComponent(e.path));if(e.since){var s=e.since;s.constructor===Date&&(s=s.toISOString()),r.push("since="+encodeURIComponent(s))}if(e.until){var o=e.until;o.constructor===Date&&(o=o.toISOString()),r.push("until="+encodeURIComponent(o))}e.page&&r.push("page="+e.page),e.perpage&&r.push("per_page="+e.perpage),r.length>0&&(n+="?"+r.join("&")),f("GET",n,null,t)}},u.Gist=function(e){var t=e.id,n="/gists/"+t;this.read=function(e){f("GET",n,null,function(t,n){e(t,n)})},this.create=function(e,t){f("POST","/gists",e,t)},this.delete=function(e){f("DELETE",n,null,function(t,n){e(t,n)})},this.fork=function(e){f("POST",n+"/fork",null,function(t,n){e(t,n)})},this.update=function(e,t){f("PATCH",n,e,function(e,n){t(e,n)})},this.star=function(e){f("PUT",n+"/star",null,function(t,n){e(t,n)})},this.unstar=function(e){f("DELETE",n+"/star",null,function(t,n){e(t,n)})},this.isStarred=function(e){f("GET",n+"/star",null,function(t,n){e(t,n)})}},u.Issue=function(e){var t="/repos/"+e.user+"/"+e.repo+"/issues";this.list=function(e,n){f("GET",t,e,n)}},this.getIssues=function(e,t){return new u.Issue({user:e,repo:t})},this.getRepo=function(e,t){return new u.Repository({user:e,name:t})},this.getUser=function(){return new u.User},this.getGist=function(e){return new u.Gist({id:e})}};return u});