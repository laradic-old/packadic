define(["jquery","theme","templates/codepad","plugins/bs-select"],function(e,t,n){function r(t){return _.isUndefined(t)&&(t="div"),e(document.createElement(t))}function i(i,s){this.id=i,s=s||{},this.options=_.merge(this.defaults,s),this.$codepad=e(n({id:i})).hide(),e("body").append(this.$codepad),this.$editorContainer=this.$codepad.find(".codepad-editor-container").append(this.$editor=r("pre").attr("id","codepad-editor-"+this.id)),this.options.deferRequireModules===!1&&this.__requireModules(function(e){this.reqs=e}.bind(this)),t.on("resize",function(){setTimeout(function(){this.adjustHeightToMatch()}.bind(this),200)}.bind(this))}return function(){}.call(),i.prototype={options:{},defaults:{deferRequireModules:!0},Constructor:i,reqs:[],editor:null,themelist:{},modelist:{},__requireModules:function(e){return require(["ace-editor"],function(t){this.themelist=t.themelist,this.modelist=t.modelist,e([t.ace,t.beautify,t.emmet,t.searchbox,t.settings_menu,t.modelist,t.themelist,t.language_tools])}.bind(this)),this},__setupEditor:function(e,t,n,r,i,s,o,u){this.adjustHeightToMatch(),this.$editorContainer.html("").append(this.$editor);var a=this.editor=e.edit(this.$editor.attr("id"));return i.init(a),a.setTheme("ace/theme/kuroir"),a.setOption("enableEmmet",!0),a.setFontSize(14),a.session.setMode("ace/mode/markdown"),a.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!1}),a.commands.addCommands([{name:"showSettingsMenu",bindKey:{win:"Ctrl-q",mac:"Command-q"},exec:function(e){e.showSettingsMenu()},readOnly:!0}]),this},adjustHeightToMatch:function(t){return t=t||parseInt(e("main").css("min-height").replace("px",""))-e("main > header.content").outerHeight()-parseInt(e("main > div.content").css("padding-top").replace("px",""))-parseInt(e("main > div.content").css("padding-bottom").replace("px",""))-e("section#top").outerHeight()-e("section#bottom").outerHeight(),this.$editor.css({height:t}),!_.isUndefined(this.editor)&&this.editor&&this.editor.resize(),this},isInitialized:!1,init:function(t){return this.isInitialized?(_.isFunction(t)&&t(),this):(this.__requireModules(function(n){this.__setupEditor.apply(this,n),this.__makeList("theme"),setTimeout(function(){this.__makeList("mode")}.bind(this),400),e.each(this.toolbarButtons,function(e,t){if(t.hasClass("added"))return;t.addClass("added"),this.$codepad.find(".codepad-toolbar .codepad-toolbar-left").append(t)}.bind(this)),this.isInitialized=!0,_.isFunction(t)&&t()}.bind(this)),this)},toTopLine:function(){this.editor.session.selection.clearSelection(),this.editor.navigateTo(0,0)},setContainer:function(e){e.html("").append(this.$codepad)},show:function(){return this.$codepad.show(),this.toTopLine(),this},hide:function(){return this.$codepad.hide(),this},slideUp:function(){return this.$codepad.slideDown.apply(this.$codepad,e.makeArray(arguments)),this},slideDown:function(){return this.$codepad.slideDown.apply(this.$codepad,e.makeArray(arguments)),this},setValue:function(e){this.editor.setValue(e)},getValue:function(){return this.editor.getValue()},setModeForPath:function(e){this.editor.session.setMode(this.modelist.getModeForPath(e).mode),this.__makeList("mode")},toolbarButtons:{},addToolbarButton:function(e,t,n,i){var s=this.toolbarButtons[e]=r("a").addClass("btn "+n||"").attr("id","codepad-toolbar-button-"+e).html(t);return this.isInitialized&&(s.addClass("added"),this.$codepad.find(".codepad-toolbar .codepad-toolbar-left").append(s)),_.isFunction(i)&&i(s),s},enableToolbar:function(){return this.$codepad.find(".codepad-toolbar").removeClass("hide"),this},__makeList:function(t){var n=this.$codepad.find("select.codepad-editor-"+t+"list").html("");return e.each(t=="theme"?this.themelist.themes:this.modelist.modes,function(e,i){n.append(r("option").attr("value",t=="theme"?i.theme:i.mode).text(i.caption))}),n.selectpicker(),n.on("change",function(e){var r=n.selectpicker("val");t=="theme"?this.editor.setTheme(r):this.editor.session.setMode(r)}.bind(this)),t=="theme"?n.selectpicker("val",this.editor.getTheme()):n.selectpicker("val",this.editor.session.getMode().$id),this}},i});