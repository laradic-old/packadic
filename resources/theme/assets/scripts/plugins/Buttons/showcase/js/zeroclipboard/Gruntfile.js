var os=require("os"),path=require("path"),loadGruntTasks=require("load-grunt-tasks");module.exports=function(e){loadGruntTasks(e);var t=e.file.readJSON("package.json"),n=os.tmpdir?os.tmpdir():os.tmpDir(),r=path.join(n,"zcflash"),i=7320,s={jshint:{options:{jshintrc:!0},gruntfile:["Gruntfile.js"],component:["index.js"],js:["src/js/**/*.js","!src/js/start.js","!src/js/end.js"],test:["test/**/*.js"],dist:["dist/*.js","!dist/*.min.js"]},flexpmd:{flash:{src:[r]}},clean:{dist:["ZeroClipboard.*","dist/ZeroClipboard.*"],flash:{options:{force:!0},src:[r]},meta:["bower.json","composer.json","LICENSE"],coveralls:["tmp/","coverage/"]},concat:{options:{stripBanners:!1,process:{data:t}},core:{src:["src/meta/source-banner.tmpl","src/js/start.js","src/js/shared/state.js","src/js/shared/private.js","src/js/core/state.js","src/js/core/private.js","src/js/core/api.js","src/js/end.js"],dest:"dist/ZeroClipboard.Core.js"},client:{src:["src/meta/source-banner.tmpl","src/js/start.js","src/js/shared/state.js","src/js/shared/private.js","src/js/core/state.js","src/js/core/private.js","src/js/core/api.js","src/js/client/state.js","src/js/client/private.js","src/js/client/api.js","src/js/end.js"],dest:"dist/ZeroClipboard.js"},flash:{files:[{src:["src/meta/source-banner.tmpl","src/flash/ZeroClipboard.as"],dest:path.join(r,"ZeroClipboard.as")},{src:["src/meta/source-banner.tmpl","src/flash/ClipboardInjector.as"],dest:path.join(r,"ClipboardInjector.as")},{src:["src/meta/source-banner.tmpl","src/flash/JsProxy.as"],dest:path.join(r,"JsProxy.as")},{src:["src/meta/source-banner.tmpl","src/flash/XssUtils.as"],dest:path.join(r,"XssUtils.as")}]}},uglify:{options:{report:"min"},js:{options:{preserveComments:function(e,t){return t&&t.type==="comment2"&&/^(!|\*|\*!)\r?\n/.test(t.value)},beautify:{beautify:!0,indent_level:2},mangle:!1,compress:!1},files:[{src:["<%= concat.core.dest %>"],dest:"<%= concat.core.dest %>"},{src:["<%= concat.client.dest %>"],dest:"<%= concat.client.dest %>"}]},minjs:{options:{preserveComments:function(e,t){return t&&t.type==="comment2"&&/^(!|\*!)\r?\n/.test(t.value)},sourceMap:!0,sourceMapName:function(e){return e.replace(".min.js",".min.map")},sourceMapIncludeSources:!0},files:[{src:["<%= concat.core.dest %>"],dest:"dist/ZeroClipboard.Core.min.js"},{src:["<%= concat.client.dest %>"],dest:"dist/ZeroClipboard.min.js"}]}},mxmlc:{options:{rawConfig:"-target-player=11.0.0 -static-link-runtime-shared-libraries=true"},swf:{files:{"dist/ZeroClipboard.swf":["<%= concat.flash.files[0].dest %>"]}}},template:{options:{data:t},bower:{files:{"bower.json":["src/meta/bower.json.tmpl"]}},composer:{files:{"composer.json":["src/meta/composer.json.tmpl"]}},LICENSE:{files:{LICENSE:["src/meta/LICENSE.tmpl"]}}},chmod:{options:{mode:"444"},dist:["dist/ZeroClipboard.*"],meta:["bower.json","composer.json","LICENSE"]},connect:{server:{options:{port:i}}},qunit:{file:["test/shared/private.tests.js.html","test/core/private.tests.js.html","test/core/api.tests.js.html","test/client/private.tests.js.html","test/client/api.tests.js.html","test/built/ZeroClipboard.Core.tests.js.html","test/built/ZeroClipboard.tests.js.html"],http:{options:{urls:e.file.expand(["test/shared/private.tests.js.html","test/core/private.tests.js.html","test/core/api.tests.js.html","test/client/private.tests.js.html","test/client/api.tests.js.html","test/built/ZeroClipboard.Core.tests.js.html","test/built/ZeroClipboard.tests.js.html"]).map(function(e){return"http://localhost:"+i+"/"+e+"?noglobals=true"})}},coveralls:{options:{"--web-security":!1,timeout:1e4,coverage:{baseUrl:".",src:["src/js/**/*.js","!src/js/start.js","!src/js/end.js","dist/*.js","!dist/*.min.js"],instrumentedFiles:"tmp",htmlReport:"coverage/html",lcovReport:"coverage/lcov",statementsThresholdPct:60,disposeCollector:!0},urls:e.file.expand(["test/shared/private.tests.js.html","test/core/private.tests.js.html","test/core/api.tests.js.html","test/client/private.tests.js.html","test/client/api.tests.js.html","test/built/ZeroClipboard.Core.tests.js.html","test/built/ZeroClipboard.tests.js.html"]).map(function(e){return"http://localhost:"+i+"/"+e+"?noglobals=true"})}}},coveralls:{options:{force:!0},all:{src:"<%= qunit.coveralls.options.coverage.lcovReport %>/lcov.info"}},watch:{options:{spawn:!1},gruntfile:{files:"<%= jshint.Gruntfile %>",tasks:["jshint:Gruntfile"]},js:{files:"<%= jshint.js %>",tasks:["jshint:js","unittest"]},test:{files:"<%= jshint.test %>",tasks:["jshint:test","unittest"]}}};e.initConfig(s),e.registerTask("jshint-prebuild",["jshint:gruntfile","jshint:component","jshint:js","jshint:test"]),e.registerTask("prep-flash",["clean:flash","concat:flash"]),e.registerTask("validate",["jshint-prebuild","prep-flash","flexpmd"]),e.registerTask("build",["clean","concat","jshint:dist","uglify","mxmlc","template","chmod"]),e.registerTask("build-travis",["clean","concat","jshint:dist","mxmlc","chmod:dist"]),e.registerTask("test",["connect","qunit:file","qunit:http"]),e.registerTask("default",["validate","build","test"]),e.registerTask("travis",["validate","build-travis","test","qunit:coveralls","coveralls"])};