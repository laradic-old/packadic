(function(e,t){typeof define=="function"&&define.amd?define(["jquery"],t):t(e.jQuery)})(this,function(e){var t=function(e,n){var r=this;return r.id=t.count++,t.lifo.push(r),e&&r.open(e,n),r};t.defaults={prefix:"jqi",classes:{box:"",fade:"",prompt:"",form:"",close:"",title:"",message:"",buttons:"",button:"",defaultButton:""},title:"",closeText:"&times;",buttons:{Ok:!0},loaded:function(e){},submit:function(e,t,n,r){},close:function(e,t,n,r){},statechanging:function(e,t,n){},statechanged:function(e,t){},opacity:.6,zIndex:999,overlayspeed:"slow",promptspeed:"fast",show:"fadeIn",hide:"fadeOut",focus:0,defaultButton:0,useiframe:!1,top:"15%",position:{container:null,x:null,y:null,arrow:null,width:null},persistent:!0,timeout:0,states:{},state:{name:null,title:"",html:"",buttons:{Ok:!0},focus:0,defaultButton:0,position:{container:null,x:null,y:null,arrow:null,width:null},submit:function(e,t,n,r){return!0}}},t.setDefaults=function(n){t.defaults=e.extend({},t.defaults,n)},t.setStateDefaults=function(n){t.defaults.state=e.extend({},t.defaults.state,n)},t.count=0,t.lifo=[],t.getLast=function(){var e=t.lifo.length;return e>0?t.lifo[e-1]:!1},t.removeFromStack=function(e){for(var n=t.lifo.length-1;n>=0;n--)if(t.lifo[n].id===e)return t.lifo.splice(n,1)[0]},t.prototype={id:null,open:function(n,r){var i=this;i.options=e.extend({},t.defaults,r),i.timeout&&clearTimeout(i.timeout),i.timeout=!1;var s=i.options,o=e(document.body),u=e(window),a='<div class="'+s.prefix+"box "+s.classes.box+'">';s.useiframe&&e("object, applet").length>0?a+='<iframe src="javascript:false;" style="display:block;position:absolute;z-index:-1;" class="'+s.prefix+"fade "+s.classes.fade+'"></iframe>':a+='<div class="'+s.prefix+"fade "+s.classes.fade+'"></div>',a+='<div class="'+s.prefix+" "+s.classes.prompt+'">'+'<form action="javascript:false;" onsubmit="return false;" class="'+s.prefix+"form "+s.classes.form+'">'+'<div class="'+s.prefix+"close "+s.classes.close+'">'+s.closeText+"</div>"+'<div class="'+s.prefix+'states"></div>'+"</form>"+"</div>"+"</div>",i.jqib=e(a).appendTo(o),i.jqi=i.jqib.children("."+s.prefix),i.jqif=i.jqib.children("."+s.prefix+"fade"),n.constructor===String&&(n={state0:{title:s.title,html:n,buttons:s.buttons,position:s.position,focus:s.focus,defaultButton:s.defaultButton,submit:s.submit}}),i.options.states={};var f,l;for(f in n)l=e.extend({},t.defaults.state,{name:f},n[f]),i.addState(l.name,l),i.currentStateName===""&&(i.currentStateName=l.name);i.jqi.on("click","."+s.prefix+"buttons button",function(t){var n=e(this),r=n.parents("."+s.prefix+"state"),o=i.options.states[r.data("jqi-name")],u=r.children("."+s.prefix+"message"),a=o.buttons[n.text()]||o.buttons[n.html()],f={};if(a===undefined)for(var l in o.buttons)if(o.buttons[l].title===n.text()||o.buttons[l].title===n.html())a=o.buttons[l].value;e.each(i.jqi.children("form").serializeArray(),function(e,t){f[t.name]===undefined?f[t.name]=t.value:typeof f[t.name]===Array||typeof f[t.name]=="object"?f[t.name].push(t.value):f[t.name]=[f[t.name],t.value]});var c=new e.Event("impromptu:submit");c.stateName=o.name,c.state=r,r.trigger(c,[a,u,f]),c.isDefaultPrevented()||i.close(!0,a,u,f)});var c=function(){if(s.persistent){var t=s.top.toString().indexOf("%")>=0?u.height()*(parseInt(s.top,10)/100):parseInt(s.top,10),n=parseInt(i.jqi.css("top").replace("px",""),10)-t;e("html,body").animate({scrollTop:n},"fast",function(){var e=0;i.jqib.addClass(s.prefix+"warning");var t=setInterval(function(){i.jqib.toggleClass(s.prefix+"warning"),e++>1&&(clearInterval(t),i.jqib.removeClass(s.prefix+"warning"))},100)})}else i.close(!0)},h=function(t){var n=window.event?event.keyCode:t.keyCode;n===27&&c();if(n===13){var r=i.getCurrentState().find("."+s.prefix+"defaultbutton"),o=e(t.target);o.is("textarea,."+s.prefix+"button")===!1&&r.length>0&&(t.preventDefault(),r.click())}if(n===9){var u=e("input,select,textarea,button",i.getCurrentState()),a=!t.shiftKey&&t.target===u[u.length-1],f=t.shiftKey&&t.target===u[0];if(a||f)return setTimeout(function(){if(!u)return;var e=u[f===!0?u.length-1:0];e&&e.focus()},10),!1}};return i.position(),i.style(),i._windowResize=function(e){i.position(e)},u.resize({animate:!1},i._windowResize),i.jqif.click(c),i.jqi.find("."+s.prefix+"close").click(function(){i.close()}),i.jqib.on("keydown",h).on("impromptu:loaded",s.loaded).on("impromptu:close",s.close).on("impromptu:statechanging",s.statechanging).on("impromptu:statechanged",s.statechanged),i.jqif[s.show](s.overlayspeed),i.jqi[s.show](s.promptspeed,function(){var e=i.jqi.find("."+s.prefix+"states ."+s.prefix+"state").eq(0);i.goToState(e.data("jqi-name")),i.jqib.trigger("impromptu:loaded")}),s.timeout>0&&(i.timeout=setTimeout(function(){i.close(!0)},s.timeout)),i},close:function(n,r,i,s){var o=this;return t.removeFromStack(o.id),o.timeout&&(clearTimeout(o.timeout),o.timeout=!1),o.jqib&&o.jqib[o.options.hide]("fast",function(){o.jqib.trigger("impromptu:close",[r,i,s]),o.jqib.remove(),e(window).off("resize",o._windowResize),typeof n=="function"&&n()}),o.currentStateName="",o},addState:function(n,r,i){var s=this,o="",u=null,a="",f="",l=s.options,c=e("."+l.prefix+"states"),h=[],p,d,v,m,g,y=0;r=e.extend({},t.defaults.state,{name:n},r),r.position.arrow!==null&&(a='<div class="'+l.prefix+"arrow "+l.prefix+"arrow"+r.position.arrow+'"></div>'),r.title&&r.title!==""&&(f='<div class="lead '+l.prefix+"title "+l.classes.title+'">'+r.title+"</div>"),p=r.html,typeof r.html=="function"&&(p="Error: html function must return text"),o+='<div class="'+l.prefix+'state" data-jqi-name="'+n+'" style="display:none;">'+a+f+'<div class="'+l.prefix+"message "+l.classes.message+'">'+p+"</div>"+'<div class="'+l.prefix+"buttons "+l.classes.buttons+'"'+(e.isEmptyObject(r.buttons)?'style="display:none;"':"")+">";if(e.isArray(r.buttons))h=r.buttons;else if(e.isPlainObject(r.buttons))for(v in r.buttons)r.buttons.hasOwnProperty(v)&&h.push({title:v,value:r.buttons[v]});for(y=0,g=h.length;y<g;y++)m=h[y],d=r.focus===y||isNaN(r.focus)&&r.defaultButton===y?l.prefix+"defaultbutton "+l.classes.defaultButton:"",o+='<button class="'+l.classes.button+" "+l.prefix+"button "+d,typeof m.classes!="undefined"&&(o+=" "+(e.isArray(m.classes)?m.classes.join(" "):m.classes)+" "),o+='" name="'+l.prefix+"_"+n+"_button"+m.title.replace(/[^a-z0-9]+/gi,"")+'" value="'+m.value+'">'+m.title+"</button>";return o+="</div></div>",u=e(o),u.on("impromptu:submit",r.submit),i!==undefined?c.find('[data-jqi-name="'+i+'"]').after(u):c.append(u),s.options.states[n]=r,u},removeState:function(e,t){var n=this,r=n.getState(e),i=function(){r.remove()};return r.length===0?!1:(r.css("display")!=="none"?t!==undefined&&n.getState(t).length>0?n.goToState(t,!1,i):r.next().length>0?n.nextState(i):r.prev().length>0?n.prevState(i):n.close():r.slideUp("slow",i),!0)},getApi:function(){return this},getBox:function(){return this.jqib},getPrompt:function(){return this.jqi},getState:function(e){return this.jqi.find('[data-jqi-name="'+e+'"]')},getCurrentState:function(){return this.getState(this.getCurrentStateName())},getCurrentStateName:function(){return this.currentStateName},position:function(t){var n=this,r=e.fx.off,i=n.getCurrentState(),s=n.options.states[i.data("jqi-name")],o=s?s.position:undefined,u=e(window),a=document.body.scrollHeight,f=e(window).height(),l=e(document).height(),c=a>f?a:f,h=parseInt(u.scrollTop(),10)+(n.options.top.toString().indexOf("%")>=0?f*(parseInt(n.options.top,10)/100):parseInt(n.options.top,10));t!==undefined&&t.data.animate===!1&&(e.fx.off=!0),n.jqib.css({position:"absolute",height:c,width:"100%",top:0,left:0,right:0,bottom:0}),n.jqif.css({position:"fixed",height:c,width:"100%",top:0,left:0,right:0,bottom:0});if(o&&o.container){var p=e(o.container).offset();e.isPlainObject(p)&&p.top!==undefined&&(n.jqi.css({position:"absolute"}),n.jqi.animate({top:p.top+o.y,left:p.left+o.x,marginLeft:0,width:o.width!==undefined?o.width:null}),h=p.top+o.y-(n.options.top.toString().indexOf("%")>=0?f*(parseInt(n.options.top,10)/100):parseInt(n.options.top,10)),e("html,body").animate({scrollTop:h},"slow","swing",function(){}))}else o&&o.width?(n.jqi.css({position:"absolute",left:"50%"}),n.jqi.animate({top:o.y||h,left:o.x||"50%",marginLeft:o.width/2*-1,width:o.width})):n.jqi.css({position:"absolute",top:h,left:"50%",marginLeft:n.jqi.outerWidth(!1)/2*-1});t!==undefined&&t.data.animate===!1&&(e.fx.off=r)},style:function(){var e=this;e.jqif.css({zIndex:e.options.zIndex,display:"none",opacity:e.options.opacity}),e.jqi.css({zIndex:e.options.zIndex+1,display:"none"}),e.jqib.css({zIndex:e.options.zIndex})},goToState:function(t,n,r){var i=this,s=i.jqi,o=i.options,u=i.getState(t),a=o.states[u.data("jqi-name")],f=new e.Event("impromptu:statechanging"),l=i.options;if(a!==undefined){if(typeof a.html=="function"){var c=a.html;u.find("."+l.prefix+"message ").html(c())}typeof n=="function"&&(r=n,n=!1),i.jqib.trigger(f,[i.getCurrentStateName(),t]),!f.isDefaultPrevented()&&u.length>0&&(i.jqi.find("."+l.prefix+"parentstate").removeClass(l.prefix+"parentstate"),n?(i.jqi.find("."+l.prefix+"substate").not(u).slideUp(o.promptspeed).removeClass("."+l.prefix+"substate").find("."+l.prefix+"arrow").hide(),i.jqi.find("."+l.prefix+"state:visible").addClass(l.prefix+"parentstate"),u.addClass(l.prefix+"substate")):i.jqi.find("."+l.prefix+"state").not(u).slideUp(o.promptspeed).find("."+l.prefix+"arrow").hide(),i.currentStateName=a.name,u.slideDown(o.promptspeed,function(){var n=e(this);typeof a.focus=="string"?n.find(a.focus).eq(0).focus():n.find("."+l.prefix+"defaultbutton").focus(),n.find("."+l.prefix+"arrow").show(o.promptspeed),typeof r=="function"&&i.jqib.on("impromptu:statechanged",r),i.jqib.trigger("impromptu:statechanged",[t]),typeof r=="function"&&i.jqib.off("impromptu:statechanged",r)}),n||i.position())}return u},nextState:function(e){var t=this,n=t.getCurrentState().next();return n.length>0&&t.goToState(n.data("jqi-name"),e),n},prevState:function(e){var t=this,n=t.getCurrentState().prev();return n.length>0&&t.goToState(n.data("jqi-name"),e),n}},e.prompt=function(e,n){var r=new t(e,n);return r.jqi},e.each(t,function(t,n){e.prompt[t]=n}),e.each(t.prototype,function(n,r){e.prompt[n]=function(){var e=t.getLast();if(e&&typeof e[n]=="function")return e[n].apply(e,arguments)}}),e.fn.prompt=function(t){t===undefined&&(t={}),t.withDataAndEvents===undefined&&(t.withDataAndEvents=!1),e.prompt(e(this).clone(t.withDataAndEvents).html(),t)},window.Impromptu=t});