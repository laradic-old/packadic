(function(e,t){"function"==typeof define&&define.amd?define(["jquery"],t):t(e.jQuery)})(this,function(e){var t=function(e,n){var r=this;return r.id=t.count++,t.lifo.push(r),e&&r.open(e,n),r};t.defaults={prefix:"jqi",classes:{box:"",fade:"",prompt:"",form:"",close:"",title:"",message:"",buttons:"",button:"",defaultButton:""},title:"",closeText:"&times;",buttons:{Ok:!0},loaded:function(){},submit:function(){},close:function(){},statechanging:function(){},statechanged:function(){},opacity:.6,zIndex:999,overlayspeed:"slow",promptspeed:"fast",show:"fadeIn",hide:"fadeOut",focus:0,defaultButton:0,useiframe:!1,top:"15%",position:{container:null,x:null,y:null,arrow:null,width:null},persistent:!0,timeout:0,states:{},state:{name:null,title:"",html:"",buttons:{Ok:!0},focus:0,defaultButton:0,position:{container:null,x:null,y:null,arrow:null,width:null},submit:function(){return!0}}},t.setDefaults=function(n){t.defaults=e.extend({},t.defaults,n)},t.setStateDefaults=function(n){t.defaults.state=e.extend({},t.defaults.state,n)},t.count=0,t.lifo=[],t.getLast=function(){var e=t.lifo.length;return e>0?t.lifo[e-1]:!1},t.removeFromStack=function(e){for(var n=t.lifo.length-1;n>=0;n--)if(t.lifo[n].id===e)return t.lifo.splice(n,1)[0]},t.prototype={id:null,open:function(n,r){var i=this;i.options=e.extend({},t.defaults,r),i.timeout&&clearTimeout(i.timeout),i.timeout=!1;var s=i.options,o=e(document.body),u=e(window),a='<div class="'+s.prefix+"box "+s.classes.box+'">';a+=s.useiframe&&e("object, applet").length>0?'<iframe src="javascript:false;" style="display:block;position:absolute;z-index:-1;" class="'+s.prefix+"fade "+s.classes.fade+'"></iframe>':'<div class="'+s.prefix+"fade "+s.classes.fade+'"></div>',a+='<div class="'+s.prefix+" "+s.classes.prompt+'">'+'<form action="javascript:false;" onsubmit="return false;" class="'+s.prefix+"form "+s.classes.form+'">'+'<div class="'+s.prefix+"close "+s.classes.close+'">'+s.closeText+"</div>"+'<div class="'+s.prefix+'states"></div>'+"</form>"+"</div>"+"</div>",i.jqib=e(a).appendTo(o),i.jqi=i.jqib.children("."+s.prefix),i.jqif=i.jqib.children("."+s.prefix+"fade"),n.constructor===String&&(n={state0:{title:s.title,html:n,buttons:s.buttons,position:s.position,focus:s.focus,defaultButton:s.defaultButton,submit:s.submit}}),i.options.states={};var f,l;for(f in n)l=e.extend({},t.defaults.state,{name:f},n[f]),i.addState(l.name,l),""===i.currentStateName&&(i.currentStateName=l.name);i.jqi.on("click","."+s.prefix+"buttons button",function(){var t=e(this),n=t.parents("."+s.prefix+"state"),r=i.options.states[n.data("jqi-name")],o=n.children("."+s.prefix+"message"),u=r.buttons[t.text()]||r.buttons[t.html()],a={};if(void 0===u)for(var f in r.buttons)(r.buttons[f].title===t.text()||r.buttons[f].title===t.html())&&(u=r.buttons[f].value);e.each(i.jqi.children("form").serializeArray(),function(e,t){void 0===a[t.name]?a[t.name]=t.value:typeof a[t.name]===Array||"object"==typeof a[t.name]?a[t.name].push(t.value):a[t.name]=[a[t.name],t.value]});var l=new e.Event("impromptu:submit");l.stateName=r.name,l.state=n,n.trigger(l,[u,o,a]),l.isDefaultPrevented()||i.close(!0,u,o,a)});var c=function(){if(s.persistent){var t=(""+s.top).indexOf("%")>=0?u.height()*(parseInt(s.top,10)/100):parseInt(s.top,10),n=parseInt(i.jqi.css("top").replace("px",""),10)-t;e("html,body").animate({scrollTop:n},"fast",function(){var e=0;i.jqib.addClass(s.prefix+"warning");var t=setInterval(function(){i.jqib.toggleClass(s.prefix+"warning"),e++>1&&(clearInterval(t),i.jqib.removeClass(s.prefix+"warning"))},100)})}else i.close(!0)},h=function(t){var n=window.event?event.keyCode:t.keyCode;if(27===n&&c(),13===n){var r=i.getCurrentState().find("."+s.prefix+"defaultbutton"),o=e(t.target);o.is("textarea,."+s.prefix+"button")===!1&&r.length>0&&(t.preventDefault(),r.click())}if(9===n){var u=e("input,select,textarea,button",i.getCurrentState()),a=!t.shiftKey&&t.target===u[u.length-1],f=t.shiftKey&&t.target===u[0];if(a||f)return setTimeout(function(){if(u){var e=u[f===!0?u.length-1:0];e&&e.focus()}},10),!1}};return i.position(),i.style(),i._windowResize=function(e){i.position(e)},u.resize({animate:!1},i._windowResize),i.jqif.click(c),i.jqi.find("."+s.prefix+"close").click(function(){i.close()}),i.jqib.on("keydown",h).on("impromptu:loaded",s.loaded).on("impromptu:close",s.close).on("impromptu:statechanging",s.statechanging).on("impromptu:statechanged",s.statechanged),i.jqif[s.show](s.overlayspeed),i.jqi[s.show](s.promptspeed,function(){var e=i.jqi.find("."+s.prefix+"states ."+s.prefix+"state").eq(0);i.goToState(e.data("jqi-name")),i.jqib.trigger("impromptu:loaded")}),s.timeout>0&&(i.timeout=setTimeout(function(){i.close(!0)},s.timeout)),i},close:function(n,r,i,s){var o=this;return t.removeFromStack(o.id),o.timeout&&(clearTimeout(o.timeout),o.timeout=!1),o.jqib&&o.jqib[o.options.hide]("fast",function(){o.jqib.trigger("impromptu:close",[r,i,s]),o.jqib.remove(),e(window).off("resize",o._windowResize),"function"==typeof n&&n()}),o.currentStateName="",o},addState:function(n,r,i){var s,o,u,a,f,l=this,c="",h=null,p="",d="",v=l.options,m=e("."+v.prefix+"states"),g=[],y=0;if(r=e.extend({},t.defaults.state,{name:n},r),null!==r.position.arrow&&(p='<div class="'+v.prefix+"arrow "+v.prefix+"arrow"+r.position.arrow+'"></div>'),r.title&&""!==r.title&&(d='<div class="lead '+v.prefix+"title "+v.classes.title+'">'+r.title+"</div>"),s=r.html,"function"==typeof r.html&&(s="Error: html function must return text"),c+='<div class="'+v.prefix+'state" data-jqi-name="'+n+'" style="display:none;">'+p+d+'<div class="'+v.prefix+"message "+v.classes.message+'">'+s+"</div>"+'<div class="'+v.prefix+"buttons "+v.classes.buttons+'"'+(e.isEmptyObject(r.buttons)?'style="display:none;"':"")+">",e.isArray(r.buttons))g=r.buttons;else if(e.isPlainObject(r.buttons))for(u in r.buttons)r.buttons.hasOwnProperty(u)&&g.push({title:u,value:r.buttons[u]});for(y=0,f=g.length;f>y;y++)a=g[y],o=r.focus===y||isNaN(r.focus)&&r.defaultButton===y?v.prefix+"defaultbutton "+v.classes.defaultButton:"",c+='<button class="'+v.classes.button+" "+v.prefix+"button "+o,a.classes!==void 0&&(c+=" "+(e.isArray(a.classes)?a.classes.join(" "):a.classes)+" "),c+='" name="'+v.prefix+"_"+n+"_button"+a.title.replace(/[^a-z0-9]+/gi,"")+'" value="'+a.value+'">'+a.title+"</button>";return c+="</div></div>",h=e(c),h.on("impromptu:submit",r.submit),void 0!==i?m.find('[data-jqi-name="'+i+'"]').after(h):m.append(h),l.options.states[n]=r,h},removeState:function(e,t){var n=this,r=n.getState(e),i=function(){r.remove()};return 0===r.length?!1:("none"!==r.css("display")?void 0!==t&&n.getState(t).length>0?n.goToState(t,!1,i):r.next().length>0?n.nextState(i):r.prev().length>0?n.prevState(i):n.close():r.slideUp("slow",i),!0)},getApi:function(){return this},getBox:function(){return this.jqib},getPrompt:function(){return this.jqi},getState:function(e){return this.jqi.find('[data-jqi-name="'+e+'"]')},getCurrentState:function(){return this.getState(this.getCurrentStateName())},getCurrentStateName:function(){return this.currentStateName},position:function(t){var n=this,r=e.fx.off,i=n.getCurrentState(),s=n.options.states[i.data("jqi-name")],o=s?s.position:void 0,u=e(window),a=document.body.scrollHeight,f=e(window).height(),l=(e(document).height(),a>f?a:f),c=parseInt(u.scrollTop(),10)+((""+n.options.top).indexOf("%")>=0?f*(parseInt(n.options.top,10)/100):parseInt(n.options.top,10));if(void 0!==t&&t.data.animate===!1&&(e.fx.off=!0),n.jqib.css({position:"absolute",height:l,width:"100%",top:0,left:0,right:0,bottom:0}),n.jqif.css({position:"fixed",height:l,width:"100%",top:0,left:0,right:0,bottom:0}),o&&o.container){var h=e(o.container).offset();e.isPlainObject(h)&&void 0!==h.top&&(n.jqi.css({position:"absolute"}),n.jqi.animate({top:h.top+o.y,left:h.left+o.x,marginLeft:0,width:void 0!==o.width?o.width:null}),c=h.top+o.y-((""+n.options.top).indexOf("%")>=0?f*(parseInt(n.options.top,10)/100):parseInt(n.options.top,10)),e("html,body").animate({scrollTop:c},"slow","swing",function(){}))}else o&&o.width?(n.jqi.css({position:"absolute",left:"50%"}),n.jqi.animate({top:o.y||c,left:o.x||"50%",marginLeft:-1*(o.width/2),width:o.width})):n.jqi.css({position:"absolute",top:c,left:"50%",marginLeft:-1*(n.jqi.outerWidth(!1)/2)});void 0!==t&&t.data.animate===!1&&(e.fx.off=r)},style:function(){var e=this;e.jqif.css({zIndex:e.options.zIndex,display:"none",opacity:e.options.opacity}),e.jqi.css({zIndex:e.options.zIndex+1,display:"none"}),e.jqib.css({zIndex:e.options.zIndex})},goToState:function(t,n,r){var i=this,s=(i.jqi,i.options),o=i.getState(t),u=s.states[o.data("jqi-name")],a=new e.Event("impromptu:statechanging"),f=i.options;if(void 0!==u){if("function"==typeof u.html){var l=u.html;o.find("."+f.prefix+"message ").html(l())}"function"==typeof n&&(r=n,n=!1),i.jqib.trigger(a,[i.getCurrentStateName(),t]),!a.isDefaultPrevented()&&o.length>0&&(i.jqi.find("."+f.prefix+"parentstate").removeClass(f.prefix+"parentstate"),n?(i.jqi.find("."+f.prefix+"substate").not(o).slideUp(s.promptspeed).removeClass("."+f.prefix+"substate").find("."+f.prefix+"arrow").hide(),i.jqi.find("."+f.prefix+"state:visible").addClass(f.prefix+"parentstate"),o.addClass(f.prefix+"substate")):i.jqi.find("."+f.prefix+"state").not(o).slideUp(s.promptspeed).find("."+f.prefix+"arrow").hide(),i.currentStateName=u.name,o.slideDown(s.promptspeed,function(){var n=e(this);"string"==typeof u.focus?n.find(u.focus).eq(0).focus():n.find("."+f.prefix+"defaultbutton").focus(),n.find("."+f.prefix+"arrow").show(s.promptspeed),"function"==typeof r&&i.jqib.on("impromptu:statechanged",r),i.jqib.trigger("impromptu:statechanged",[t]),"function"==typeof r&&i.jqib.off("impromptu:statechanged",r)}),n||i.position())}return o},nextState:function(e){var t=this,n=t.getCurrentState().next();return n.length>0&&t.goToState(n.data("jqi-name"),e),n},prevState:function(e){var t=this,n=t.getCurrentState().prev();return n.length>0&&t.goToState(n.data("jqi-name"),e),n}},e.prompt=function(e,n){var r=new t(e,n);return r.jqi},e.each(t,function(t,n){e.prompt[t]=n}),e.each(t.prototype,function(n){e.prompt[n]=function(){var e=t.getLast();return e&&"function"==typeof e[n]?e[n].apply(e,arguments):void 0}}),e.fn.prompt=function(t){void 0===t&&(t={}),void 0===t.withDataAndEvents&&(t.withDataAndEvents=!1),e.prompt(e(this).clone(t.withDataAndEvents).html(),t)},window.Impromptu=t});