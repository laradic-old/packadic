function last(e){return e[e.length-1]}function convertHexEscape(e){var t=!1;return e.forEach(function(e){if(e.type=="charclass")t=!0;else if(e.type=="charclass.end")t=!1;else if(e.type=="charType")if(e.value=="\\h")e.type="text",e.value=t?"\\da-fA-F":"[\\da-fA-F]";else if(e.value=="\\H"){if(t){console.warn("can't convert \\H in charclass");return}e.type="text",e.value="[^\\da-fA-F]"}}),e}function convertNewLinesTo$(e){var t=tokenize(e);for(var n=0;n<t.length;n++){var r=t[n];if(r.type=="char"&&r.value=="\\n"){var i=t[n+1]||{};if(i.type!="quantifier"){r.value="$";while(i.value=="\\n"||i.type=="quantifier")i.value="",i=t[++n+1]||{}}else/\?|\*|{,|{0,/.test(i.value)?r.value=i.value="":i.value=""}}return toStr(t).replace(/[$]+/g,"$")}function convertCharacterTypes(e){var t=tokenize(e);t=convertHexEscape(t);var n=!1;return t.forEach(function(e){if(e.type=="quantifier"){var t=e.value;t.slice(-1)=="+"&&t.length>1&&(e.value=t.slice(0,-1),n=t)}}),n&&console.log("converted possesive quantifier "+n+" to *"),toStr(t)}function removeInlineFlags(e,t){var n=tokenize(e),r=!1;return n.forEach(function(e,t){if(e.type=="group.start"&&/[imsx]/.test(e.value)){/i/.test(e.value)&&(r=!0),e.value=e.value.replace(/[imsx\-]/g,"");var i=n[t+1];i&&i.type=="group.end"&&(e.value=i.value="")}}),r&&t&&(t.caseInsensitive=!0),toStr(n)}function convertToNonCapturingGroups(e){var t=tokenize(e);return t.forEach(function(e,t){e.type=="group.start"&&e.value=="("&&(e.value+="?:")}),toStr(t)}function simplifyNonCapturingGroups(e){function i(e){for(r=0;r<t.length;r++)e(t[r])}function s(e,n){for(var i=r+1;i<t.length;i++){var s=t[i];if(s==e)break;var o=n&&n(s);o>i&&(i=o)}return i}var t=tokenize(e),n=t[0]||{};n.type=="group.start"&&n.value=="(?:"&&n.end==last(t)&&(n.value=n.end.value="");var r=0;return i(function(n){if(n.type=="group.start"&&n.value=="(?:"){if(!n.end)return console.error("malformed regex: "+e);var i=!0,o=t[t.indexOf(n.end,r)+1];if(o&&o.type=="quantifier")return;s(n.end,function(e){if(e.type=="alternation")i=!1;else if(e.type=="group.start"&&e.end)return s(e.end)}),i&&(n.value=n.end.value="")}}),toStr(t)}function removeLookBehinds(e){var t=tokenize(e),n=null;return t.forEach(function(e,t){!n&&e.type=="group.start"&&/</.test(e.value)&&(n=e.end,n.content=[]),n&&(n.content.push(e.value),e.value="");if(e==n){var r=n.content.slice(1,-1).join("");/\^/.test(r)&&(n.value="(?:"+r+")"),n=null}}),toStr(t)}function convertBeginEndBackrefs(e){if(!/\\\d/.test(e.end))return;var t=tokenize(e.begin),n=tokenize(e.end),r={};t.forEach(function(e,n){if(e.number&&e.end&&e.type=="group.start"){var i=t.indexOf(e.end,n+1),s=t.slice(n+1,i);r[e.number]=toStr(s)}}),n.forEach(function(e){if(e.type=="backRef"){var t=e.value.substr(1);r[t]&&(e.value="(?:"+r[t]+")")}}),e.end=toStr(n),console.warn("Begin-End-Backreference is detected",e)}function checkForNamedCaptures(e){var t=tokenize(e);t.forEach(function(t){t.type=="group.start"&&t.name&&console.warn("named capture not implemented",e),t.type=="backRef"&&console.warn("backRef not implemented ",e)})}function fixGroups(e,t,n){function u(){var e={value:"(",type:"group.start",isGroup:!0};i.push(e),r.splice(o++,0,e)}function a(){var e={value:")",type:"group.start"};e.start=i.pop(),e.start.end=e,r.splice(o++,0,e)}function f(){s&&(u(),s=!1)}function l(){i.length&&a()}function c(e){var t=r.indexOf(e.end,o);t>o&&(o=t)}function h(e){return e[e.length-1]}function p(e){for(o=0;o<r.length;o++)e(r[o])}function d(e,t){for(var n=o+1;n<r.length;n++){var i=r[n];if(i==e)break;t(i)}}function v(){return r[o+1]||{}}var r=tokenize(n),i=[],s=!0,o=0;p(function(e){e.type=="group.start"?(l(),s=!0,(!e.hasChildren||e.isSpecial)&&c(e)):e.type=="group.end"?(s=!0,l()):e.type=="alternation"?(s=!0,l()):e.type!="anchor"&&e.type!="quantifier"&&f()}),l();var m=[t];return p(function(t){if(t.type=="group.start"&&!t.isSpecial){var n=e[t.number];if(!t.hasChildren)t.tokenName=n||h(m),c(t);else{var r=!1;d(t.end,function(t){t.type=="group.start"&&e[t.number]&&(r=!0)}),r?(t.value="(?:",n&&(m.push(n),t.isTokenGroup=!0)):(t.tokenName=n||h(m),d(t.end,function(e){e.value=="("&&(e.value="(?:")}))}}else t.type=="group.end"&&t.start.isTokenGroup&&m.pop()}),p(function(e){e.type=="group.end"&&e.start.value=="("&&v().type=="quantifier"&&(v().value+=")",e.start.value+="(?:")}),m=[],r.forEach(function(e){(e.value=="("||e.value=="((?:")&&e.tokenName&&m.push(e.tokenName)}),{names:m,regex:toStr(r)}}function logDebug(e,t){console.log(e,t)}function processRules(e){return e.patterns&&(states.start=processPatterns(e.patterns)),e.repository&&processRepository(e.repository),states}function processRepository(e){for(var t in e){var n=e[t];if(n.begin)var r=[processPattern(e[t])];else if(n.patterns&&!n.repository)var r=processPatterns(n.patterns);else var r=[processPattern(e[t])];r&&(states["#"+t]=r)}}function processPatterns(e){return e.map(processPattern)}function processPattern(e){if(e.end=="(?!\\G)"&&e.patterns&&e.patterns.length==1)var t=processPattern(e.patterns[0]);else if(e.begin!=null&&e.end!=null){convertBeginEndBackrefs(e);var t=simpleRule(e.begin,e.name,e.beginCaptures||e.captures),n=processPatterns(e.patterns||[]),r=simpleRule(e.end,e.name,e.endCaptures||e.captures);r.next="pop",e.applyEndPatternLast?n.push(r):n.unshift(r),(e.name||e.contentName)&&n.push({defaultToken:e.name||e.contentName}),t.push=n,t=removeIncludeSelf(t)}else if(e.match)var t=simpleRule(e.match,e.name,e.captures);else if(e.include)var t={include:e.include};else var t={todo:e};return e.comment&&(t.comment=(t.comment||"")+e.comment),e.repository&&processRepository(e.repository),t}function simpleRule(e,t,n){t=t||"text";var r={token:"",regex:""},i=e;e=transformRegExp(i,r);if(n){var s=[];Object.keys(n).forEach(function(e){s[e]=n[e]&&n[e].name});if(s.length==1)t=s[0];else{var o=fixGroups(s,t,e);t=o.names,e=o.regex,t.length==1&&(t=t[0])}}typeof t=="string"&&(e=convertToNonCapturingGroups(e)),e=simplifyNonCapturingGroups(e);try{new RegExp(e)}catch(u){r.TODO="FIXME: regexp doesn't have js equivalent",r.originalRegex=i}return r.token=t,r.regex=e,r}function removeIncludeSelf(e){if(!e.push)return e;var t=!1,n=null,r=!1;return e.push.forEach(function(e){if(e.include=="$self")t=!0;else{if(e.defaultToken)return;e.next=="pop"?n=e:r=!0}}),t?(console.warn("can't convert include $self"),{todo:e}):e}function removeXFlag(e){var t=tokenize(e);return toStr(t)}function transformRegExp(e,t){return e=convertNewLinesTo$(e),e=removeInlineFlags(e,t),e=e.replace(/(\\[xu]){([a-fA-F\d]+)}/g,"$1$2"),e=convertCharacterTypes(e,t),checkForNamedCaptures(e),e}function extractPatterns(e){return processRules(e)}function detectLoops(e){function i(e,t){e.refs.indexOf(t)==-1&&e.refs.push(t)}function s(t,n){var i=0,s=t;while(r[t]||e[t])t=s+"_"+i++;return t}function o(e,t){return t&&!r[e]&&(r[e]=t),t||r[e]}function h(e,n){var r=t[e];n.push(e),(!r||!r.refs)&&console.log(e);var i=n.indexOf(e);if(i>-1&&i!=n.length-1||e=="$self"||e=="$base"){i!=-1&&(n=n.slice(i));for(var s=0;s<c.length;s++)if(c[s]+""==n+"")return;return c.push(n)}if(!r||!r.refs||!r.refs.length||n.length>30)return;r.refs.forEach(function(e){h(e,n.concat())})}var t={},n=Object.keys(e),r={};for(var u=0;u<n.length;u++){var a=n[u],f=o(a,e[a]),l=t[a]||(t[a]={refs:[]});f.forEach(function(e){var t=e.push||e.next;if(t!="pop")if(typeof t=="string")i(l,t);else if(t){var r=s(a,t);o(r,t),e.push&&i(l,r),n.push(r)}else e.include&&i(l,e.include)})}var c=[];h("start",[]),console.error(c.join("\n"))}function test(e){console.log("testing highlighter");try{var t=require(e),n=t[Object.keys(t)[0]],r=new n;r.getTokenizer().getLineTokens("hello world")}catch(i){console.log(i)}}function guessComment(e){var t={};for(var n in e){var r=e[n];r.forEach(function(e){typeof e.token=="string"&&/\bcomment\b/.test(e.token)&&(t.line=e.regex)})}return t}function fetchAndConvert(e){console.log("Converting "+e);if(/^http/.test(e))return/:\/\/github.com/.test(e)&&(e=e.replace(/\/blob\//,"/").replace("github.com","raw.github.com")),lib.download(e,function(t){convertTmLanguage(e,t)});var t=/^(\/|\w:)/.test(e)?e:process.cwd()+"/"+e,n=fs.readFileSync(t,"utf8");convertTmLanguage(e,n)}function convertTmLanguage(e,t){parseLanguage(t,function(t){var n=lib.snakeCase(t.name).replace(/[^\w]/g,""),r=lib.camelCase(t.name).replace(/[^\w]/g,"");require("./add_mode")(r,(t.fileTypes||[]).join("|"));var i=pathlib.normalize(lib.AceLib+"ace/mode/"+n+"_highlight_rules.js"),s=pathlib.normalize(lib.AceLib+"ace/mode/"+n+".js");devMode&&(console.log(util.inspect(t.patterns,!1,4)),console.log(util.inspect(t.repository,!1,4)));var o=extractPatterns(t);detectLoops(o),delete t.uuid,delete t.patterns,delete t.repository;var u=guessComment(o),a=lib.fillTemplate(modeTemplate,{language:r,languageHighlightFilename:n,lineCommentStart:JSON.stringify(u.line||"//"),blockCommentStart:JSON.stringify(u.start||"/*"),blockCommentEnd:JSON.stringify(u.end||"*/")}),f=lib.fillTemplate(modeHighlightTemplate,{language:r,languageTokens:lib.formatJSON(o,"    ").trim(),uuid:t.uuid,name:e,metaData:lib.formatJSON(t,"    ").trim()});devMode?(console.log(a),console.log(f),console.log("Not writing, 'cause we're in dev mode, baby.")):(fs.writeFileSync(i,f),fs.writeFileSync(s,a),console.log("created file "+i),test(s))})}require("amd-loader");var fs=require("fs"),util=require("util"),lib=require("./lib"),pathlib=require("path"),parseLanguage=lib.parsePlist,tk=require("./regexp_tokenizer"),tokenize=tk.tokenize,toStr=tk.toStr,states={start:[]},modeTemplate=fs.readFileSync(__dirname+"/templates/mode.js","utf8"),modeHighlightTemplate=fs.readFileSync(__dirname+"/templates/highlight_rules.js","utf8");if(!module.parent){var args=process.argv.splice(2),devMode=args[0]=="--dev";devMode&&args.shift(),args.length<1&&(console.error("Usage: node tmlanguage.js [--dev] path/or/url/to/syntax.file ..."),process.exit(1)),args.forEach(fetchAndConvert)}else exports.fetchAndConvert=fetchAndConvert;