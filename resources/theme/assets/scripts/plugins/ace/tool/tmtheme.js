function parseTheme(e,t){parseString(e,function(e,n){t(n[0])})}function extractStyles(e){var t=e.settings[0].settings,n={printMargin:"#e8e8e8",background:parseColor(t.background),foreground:parseColor(t.foreground),gutter:"#e8e8e8",selection:parseColor(t.selection),step:"rgb(198, 219, 174)",bracket:parseColor(t.invisibles),active_line:parseColor(t.lineHighlight),cursor:parseColor(t.caret),invisible:"color: "+parseColor(t.invisibles)+";"};for(var r=1;r<e.settings.length;r++){var i=e.settings[r];if(!i.scope||!i.settings)continue;var s=i.scope.split(/\s*[|,]\s*/g);for(var o=0;o<s.length;o++){var u=s[o],a=parseStyles(i.settings),f=supportedScopes[u];f?n[f]=a:a&&(unsupportedScopes[u]=(unsupportedScopes[u]||0)+1)}}for(var r in fallbackScopes)n[r]||(n[r]=n[fallbackScopes[r]]);if(!n.fold){var l=n["entity.name.function"]||n.keyword;l&&(n.fold=l.match(/\:([^;]+)/)[1])}return n.gutterBg=n.background,n.gutterFg=mix(n.foreground,n.background,.5),n.selected_word_highlight||(n.selected_word_highlight="border: 1px solid "+n.selection+";"),n.isDark=(luma(n.background)<.5)+"",n}function mix(e,t,n,r){return e=rgbColor(e),t=rgbColor(t),r===undefined&&(r=1-n),"rgb("+[Math.round(n*e[0]+r*t[0]),Math.round(n*e[1]+r*t[1]),Math.round(n*e[2]+r*t[2])].join(",")+")"}function rgbColor(e){return typeof e=="object"?e:e[0]=="#"?e.match(/^#(..)(..)(..)/).slice(1).map(function(e){return parseInt(e,16)}):e.match(/\(([^,]+),([^,]+),([^,]+)/).slice(1).map(function(e){return parseInt(e,10)})}function luma(e){var t=rgbColor(e);return(.21*t[0]+.72*t[1]+.07*t[2])/255}function parseColor(e){e.length==4&&(e=e.replace(/[a-fA-F\d]/g,"$&$&"));if(e.length==7)return e;e.match(/^#(..)(..)(..)(..)$/)||console.error("can't parse color",e);var t=e.match(/^#(..)(..)(..)(..)$/).slice(1).map(function(e){return parseInt(e,16)});return t[3]=(t[3]/255).toPrecision(2),"rgba("+t.join(", ")+")"}function parseStyles(e){var t=[],n=e.fontStyle||"";return n.indexOf("underline")!==-1&&t.push("text-decoration:underline;"),n.indexOf("italic")!==-1&&t.push("font-style:italic;"),e.foreground&&t.push("color:"+parseColor(e.foreground)+";"),e.background&&t.push("background-color:"+parseColor(e.background)+";"),t.join("\n")}function fillTemplate(e,t){return e.replace(/%(.+?)%/g,function(e,n){return t[n]||""})}function hyphenate(e){return e.replace(/([A-Z])/g,"-$1").replace(/_/g,"-").toLowerCase()}function quoteString(e){return'"'+e.replace(/\\/,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\\n")+'"'}function normalizeStylesheet(e){for(var t=e.length;t--;){var n=JSON.stringify(e[t].declarations);for(var r=t;r--;)if(n==JSON.stringify(e[r].declarations)){console.log(e[r].selectors,e[t].selectors),console.log(t,r),e[r].selectors=e[t].selectors.concat(e[r].selectors),e.splice(t,1);break}}for(var t=e.length;t--;){var n=e[t].selectors.sort();e[t].selectors=n.filter(function(e,t){return e&&e!=n[t+1]})}return e}function convertBuiltinTheme(e){return convertTheme(e,__dirname+"/tmthemes/"+themes[e]+".tmTheme",__dirname+"/../lib/ace/theme")}function convertTheme(e,t,n){console.log("Converting "+e);var r=fs.readFileSync(t,"utf8");parseTheme(r,function(t){var r=extractStyles(t);r.cssClass="ace-"+hyphenate(e),r.uuid=t.uuid;var i=fillTemplate(cssTemplate,r);i=i.replace(/[^\{\}]+{\s*}/g,"");for(var s in supportedScopes){if(!r[s])continue;i+="."+r.cssClass+" "+s.replace(/^|\./g,".ace_")+"{"+r[s]+"}"}try{var o=fs.readFileSync(n+"/"+e+".css"),u=cssParse(o).stylesheet.rules,a=cssParse(i).stylesheet.rules;for(var s=0;s<a.length;s++){var f=a[s].selectors;for(var l=0;l<u.length;l++){var c=u[l].selectors;f=f.filter(function(e){return c.indexOf(e)==-1});if(!f.length)break}f.length&&(a[s].selectors=f,console.log("Adding NEW rule: ",a[s]),u.splice(s,0,a[s]))}u=normalizeStylesheet(u),i=cssStringify({stylesheet:{rules:u}},{compress:!1})}catch(h){console.log("Creating new file: "+e+".css"),i=cssStringify(cssParse(i),{compress:!1})}var p=fillTemplate(jsTemplate,{name:e,css:'require("../requirejs/text!./'+e+'.css")',cssClass:"ace-"+hyphenate(e),isDark:r.isDark});fs.writeFileSync(n+"/"+e+".js",p),fs.writeFileSync(n+"/"+e+".css",i)})}var fs=require("fs"),path=require("path"),util=require("util"),cssParse=require("css-parse"),cssStringify=require("css-stringify"),parseString=require("plist").parseString,unsupportedScopes={},supportedScopes={keyword:"keyword","keyword.operator":"keyword.operator","keyword.other.unit":"keyword.other.unit",constant:"constant","constant.language":"constant.language","constant.library":"constant.library","constant.numeric":"constant.numeric","constant.character":"constant.character","constant.character.escape":"constant.character.escape","constant.character.entity":"constant.character.entity","constant.other":"constant.other",support:"support","support.function":"support.function","support.function.dom":"support.function.dom","support.function.firebug":"support.firebug","support.function.constant":"support.function.constant","support.constant":"support.constant","support.constant.property-value":"support.constant.property-value","support.class":"support.class","support.type":"support.type","support.other":"support.other","function":"function","function.buildin":"function.buildin",storage:"storage","storage.type":"storage.type",invalid:"invalid","invalid.illegal":"invalid.illegal","invalid.deprecated":"invalid.deprecated",string:"string","string.regexp":"string.regexp",comment:"comment","comment.documentation":"comment.doc","comment.documentation.tag":"comment.doc.tag",variable:"variable","variable.language":"variable.language","variable.parameter":"variable.parameter",meta:"meta","meta.tag.sgml.doctype":"xml-pe","meta.tag":"meta.tag","meta.selector":"meta.selector","entity.other.attribute-name":"entity.other.attribute-name","entity.name.function":"entity.name.function","entity.name":"entity.name","entity.name.tag":"entity.name.tag","markup.heading":"markup.heading","markup.heading.1":"markup.heading.1","markup.heading.2":"markup.heading.2","markup.heading.3":"markup.heading.3","markup.heading.4":"markup.heading.4","markup.heading.5":"markup.heading.5","markup.heading.6":"markup.heading.6","markup.list":"markup.list","collab.user1":"collab.user1"},fallbackScopes={keyword:"meta","support.type":"storage.type",variable:"entity.name.function"},cssTemplate=fs.readFileSync(__dirname+"/templates/theme.css","utf8"),jsTemplate=fs.readFileSync(__dirname+"/templates/theme.js","utf8"),themes={clouds:"Clouds",clouds_midnight:"Clouds Midnight",cobalt:"Cobalt",dawn:"Dawn",idle_fingers:"idleFingers",kr_theme:"krTheme",merbivore:"Merbivore",merbivore_soft:"Merbivore Soft",mono_industrial:"monoindustrial",monokai:"Monokai",pastel_on_dark:"Pastels on Dark",solarized_dark:"Solarized-dark",solarized_light:"Solarized-light",katzenmilch:"Katzenmilch",kuroir:"Kuroir Theme",tomorrow:"Tomorrow",tomorrow_night:"Tomorrow-Night",tomorrow_night_blue:"Tomorrow-Night-Blue",tomorrow_night_bright:"Tomorrow-Night-Bright",tomorrow_night_eighties:"Tomorrow-Night-Eighties",twilight:"Twilight",vibrant_ink:"Vibrant Ink",xcode:"Xcode_default"};if(process.argv.length>1){var args=process.argv.splice(2);args.length<3&&(console.error("Usage: node tmtheme.js [theme_name, path/to/theme.tmTheme path/to/output/directory]"),process.exit(1));var name=args[0],themePath=args[1],outputDirectory=args[2];convertTheme(name,themePath,outputDirectory)}else for(var name in themes)convertBuiltinTheme(name);var sortedUnsupportedScopes={};for(var u in unsupportedScopes){var value=unsupportedScopes[u];sortedUnsupportedScopes[value]===undefined&&(sortedUnsupportedScopes[value]=[]),sortedUnsupportedScopes[value].push(u)}console.log("I found these unsupported scopes:"),console.log(sortedUnsupportedScopes),console.log("It's safe to ignore these, but they may affect your syntax highlighting if your mode depends on any of these rules."),console.log("Refer to the docs on ace.ajax.org for information on how to add a scope to the CSS generator.");