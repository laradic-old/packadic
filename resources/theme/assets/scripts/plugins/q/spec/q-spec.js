typeof Q=="undefined"&&typeof require!="undefined"&&(global.Q=require("../q"),require("./lib/jasmine-promise"));var REASON="this is not an error, but it might show up in the console",calledAsFunctionThis=function(){return this}();afterEach(function(){Q.onerror=null}),describe("computing sum of integers using promises",function(){it("should compute correct result without blowing stack",function(){var e=[],t=1e3;for(var n=1;n<=t;n++)e.push(n);var r=Q.fulfill(0),i=e.reduce(function(e,t){return e.then(function(e){return Q.fulfill(e+t)})},r);return i.then(function(e){expect(e).toEqual(t*(t+1)/2)})})}),describe("Q function",function(){it("should result in a fulfilled promise when given a value",function(){expect(Q(5).isFulfilled()).toBe(!0)}),it("should be the identity when given promise",function(){var e=Q.fulfill(5),t=Q.reject(new Error("aaargh")),n=Q.promise(function(){});expect(Q(e)).toBe(e),expect(Q(t)).toBe(t),expect(Q(n)).toBe(n)})}),describe("defer and when",function(){it("resolve before when",function(){var e=0,t=Q.defer();t.resolve(10);var n=Q.when(t.promise,function(t){expect(e).toEqual(1),expect(t).toEqual(10)});return e++,n}),it("reject before when",function(){var e=0,t=Q.defer();t.reject(-1);var n=Q.when(t.promise,function(){expect(!0).toBe(!1)},function(t){expect(e).toEqual(1),expect(t).toEqual(-1)});return e++,n}),it("when before resolve",function(){var e=0,t=Q.defer(),n=t.promise.then(function(t){expect(e).toEqual(2),expect(t).toEqual(10),e++});return Q.nextTick(function(){expect(e).toEqual(1),t.resolve(10),e++}),e++,n}),it("when before reject",function(){var e=0,t=Q.defer(),n=t.promise.then(function(){expect(!0).toBe(!1)},function(t){expect(e).toEqual(2),expect(t).toEqual(-1),e++});return Q.nextTick(function(){expect(e).toEqual(1),t.reject(-1),e++}),e++,n}),it("resolves multiple observers",function(e){function o(r){s++,expect(r).toBe(n),expect(t).toBe(!0),s===i&&e()}var t=!1,n="Taram pam param!",r=Q.defer(),i=10,s=0;while(++s<=i)Q.when(r.promise,o);r.resolve(n),s=0,t=!0}),it("observers called even after throw",function(){var e=!1,t=Q.defer();Q.when(t.promise,function(){throw e=!0,new Error(REASON)});var n=Q.when(t.promise,function(e){expect(e).toEqual(10)},function(){expect("not").toEqual("here")});return t.resolve(10),n}),it("returns `undefined` from the deferred's methods",function(){expect(Q.defer().resolve()).toBe(undefined),expect(Q.defer().reject()).toBe(undefined)})}),describe("always next tick",function(){it("generated by `resolve`",function(){var e=0,t=Q.when(Q(),function(){expect(e).toEqual(1)});return e++,t}),it("generated by `reject`",function(){var e=0,t=Q.when(Q.reject(),function(){expect(!0).toBe(!1)},function(){expect(e).toEqual(1)});return e++,t})}),describe("progress",function(){it("calls a single progress listener",function(){var e=!1,t=Q.defer(),n=Q.when(t.promise,function(){expect(e).toBe(!0)},function(){expect(!0).toBe(!1)},function(){e=!0});return t.notify(),t.resolve(),n}),it("calls multiple progress listeners",function(){var e=!1,t=!1,n=Q.defer(),r=Q.when(n.promise,function(){expect(e).toBe(!0),expect(t).toBe(!0)},function(){expect(!0).toBe(!1)},function(){e=!0});return Q.when(n.promise,null,null,function(){t=!0}),n.notify(),n.resolve(),r}),it("calls all progress listeners even if one throws",function(){var e=!1,t=!1,n=!1,r=Q.defer(),i=Q.when(r.promise,function(){expect(e).toBe(!0),expect(t).toBe(!0),expect(n).toBe(!0)},function(){expect(!0).toBe(!1)},function(){e=!0});return Q.onerror=function(){},Q.when(r.promise,null,null,function(){throw t=!0,new Error("just a test, ok if it shows up in the console")}),Q.when(r.promise,null,null,function(){n=!0}),r.notify(),r.resolve(),i}),it("calls the progress listener even if later rejected",function(){var e=!1,t=Q.defer(),n=Q.when(t.promise,function(){expect(!0).toBe(!1)},function(){expect(e).toEqual(!0)},function(){e=!0});return t.notify(),t.reject(),n}),it("calls the progress listener with the notify values",function(){var e=[],t=[{},{},"foo",5],n=Q.defer(),r=Q.when(n.promise,function(){for(var n=0;n<t.length;++n){var r=t[n],i=e[n];expect(i).toBe(r)}},function(){expect(!0).toBe(!1)},function(t){e.push(t)});for(var i=0;i<t.length;++i)n.notify(t[i]);return n.resolve(),r}),it("does not call the progress listener if notify is called after fulfillment",function(){var e=Q.defer(),t=!1;return Q.when(e.promise,null,null,function(){t=!0}),e.resolve(),e.notify(),Q.delay(10).then(function(){expect(t).toBe(!1)})}),it("does not call the progress listener if notify is called after rejection",function(){var e=Q.defer(),t=!1;return Q.when(e.promise,null,null,function(){t=!0}),e.reject(),e.notify(),Q.delay(10).then(function(){expect(t).toBe(!1)})}),it("should not save and re-emit progress notifications",function(){var e=Q.defer(),t=[];e.notify(1);var n=Q.when(e.promise,function(){expect(t).toEqual([2])},function(){expect(!0).toBe(!1)},function(e){t.push(e)});return e.notify(2),e.resolve(),n}),it("should allow attaching progress listeners w/ .progress",function(){var e=!1,t=Q.defer();return t.promise.progress(function(){e=!0}),t.notify(),t.resolve(),t.promise}),it("should allow attaching progress listeners w/ Q.progress",function(){var e=!1,t=Q.defer();return Q.progress(t.promise,function(){e=!0}),t.notify(),t.resolve(),t.promise}),it("should call the progress listener with undefined context",function(){var e=!1,t={},n=Q.defer(),r=Q.when(n.promise,function(){expect(e).toBe(!0),expect(t).toBe(calledAsFunctionThis)},function(){expect(!0).toBe(!1)},function(){e=!0,t=this});return n.notify(),n.resolve(),r}),it("should forward only the first notify argument to listeners",function(){var e=[],t=Q.defer(),n=Q.when(t.promise,function(){expect(e).toEqual([[1],[2],[4]])},function(){expect(!0).toBe(!1)},function(){var t=Array.prototype.slice.call(arguments);e.push(t)});return t.notify(1),t.notify(2,3),t.notify(4,5,6),t.resolve(),n}),it("should work with .then as well",function(){var e=!1,t=Q.defer(),n=t.promise.then(function(){expect(e).toBe(!0)},function(){expect(!0).toBe(!1)},function(){e=!0});return t.notify(),t.resolve(),n}),it("should re-throw all errors thrown by listeners to Q.onerror",function(){var e=new Error("boo!"),t=Q.defer();t.promise.progress(function(){throw e});var n=Q.defer();return Q.onerror=function(t){expect(t).toBe(e),n.resolve()},Q.delay(100).then(n.reject),t.notify(),n.promise})}),describe("promises for objects",function(){describe("get",function(){it("fulfills a promise",function(){var e=Q.defer();return e.resolve({a:1}),e.promise.get("a").then(function(e){expect(e).toBe(1)})}),it("propagates a rejection",function(){var e=new Error("boo!");return Q.fcall(function(){throw e}).get("a").then(function(){expect("be").toBe("not to be")},function(t){expect(t).toBe(e)})})}),describe("set",function(){it("fulfills a promise",function(){var e={};return Q(e).set("a",1).then(function(t){expect(t).toBe(undefined),expect(e.a).toBe(1)})}),it("propagates a rejection",function(){var e=new Error("Gah!");return Q.reject(e).set("a",1).then(function(){expect("frozen over").toBe("quite warm")},function(t){expect(t).toBe(e)})})}),describe("del",function(){it("fulfills a promise",function(){var e={a:10};return Q.fcall(function(){return e}).del("a").then(function(t){expect("a"in e).toBe(!1),expect(t).toBe(void 0)},function(){expect("up").toBe("down")})}),it("propagates a rejection",function(){var e=new Error("hah-hah");return Q.fcall(function(){throw e}).del("a").then(function(){expect(!0).toBe(!1)},function(t){expect(t).toBe(e)})})}),describe("post",function(){it("fulfills a promise",function(){var e={a:function(t){return this._a=t,1+t}};return Q.when(Q.post(e,"a",[1]),function(t){expect(e._a).toBe(1),expect(t).toBe(2)})}),it("works as apply when given no name",function(){return Q(function(e,t,n){return e+t+n}).post(undefined,[1,2,3]).then(function(e){expect(e).toEqual(6)})})}),describe("send",function(){it("fulfills a promise",function(){var e,t={foo:function(e){return e},bar:function(t,n){return e=t,this.foo(n)}};return Q.send(t,"bar",1,2).then(function(t){expect(e).toEqual(1),expect(t).toEqual(2)})}),it("is rejected for undefined method",function(){var e={};return Q(e).send("foo").then(function(){expect("here").toEqual("not here")},function(){})}),it("is rejected for undefined object",function(){return Q().send("foo").then(function(){expect("here").toEqual("not here")},function(){})})}),describe("keys",function(){function e(e,t){this.a=e,this.b=t}e.prototype.notOwn=1,it("fulfills a promise",function(){return Q.keys(new e(10,20)).then(function(e){expect(e.sort()).toEqual(["a","b"])})})})}),describe("promises for functions",function(){describe("fapply",function(){it("fulfills a promise using arguments",function(){return Q(function(e,t,n){return e+t+n}).fapply([1,2,3]).then(function(e){expect(e).toEqual(6)})})}),describe("fcall",function(){it("fulfills a promise using arguments",function(){return Q(function(e,t,n){return e+t+n}).fcall(1,2,3).then(function(e){expect(e).toEqual(6)})})}),describe("fbind",function(){it("accepts a promise for a function",function(){return Q.fbind(Q(function(e,t){return e-t}))(2,1).then(function(e){expect(e).toEqual(1)})}),it("chains partial application on a promise for a function",function(){return Q(function(e,t){return e*t}).fbind(2)(3).then(function(e){expect(e).toEqual(6)})}),it("returns a fulfilled promise",function(){var e={},t=Q.fbind(function(){return e});return t().then(function(t){expect(t).toBe(e)})}),it("returns a rejected promise from a thrown error",function(){var e=new Error("Boo!"),t=Q.fbind(function(){throw e});return t().then(function(){expect("flying pigs").toBe("swillin' pigs")},function(t){expect(t).toBe(e)})}),it("passes arguments through",function(){var e={},t={},n=Q.fbind(function(n,r){expect(n).toBe(e),expect(r).toBe(t)});return n(e,t)}),it("passes and also partially applies arguments",function(){var e={},t={},n=Q.fbind(function(n,r){expect(n).toBe(e),expect(r).toBe(t)},e);return n(t)}),it("doesn't bind `this`",function(){var e={me:"this"},t=Q.fbind(function(){expect(this).toBe(e)});return t.call(e)})})}),describe("inspect",function(){it("for a fulfilled promise",function(){expect(Q(10).inspect()).toEqual({state:"fulfilled",value:10})}),it("for a rejected promise",function(){var e=new Error("In your face."),t=Q.reject(e);expect(t.inspect()).toEqual({state:"rejected",reason:e})}),it("for a pending, unresolved promise",function(){var e=Q.defer().promise;expect(e.inspect()).toEqual({state:"pending"})}),it("for a promise resolved to a rejected promise",function(){var e=Q.defer(),t=new Error("Rejected!"),n=Q.reject(t);e.resolve(n),expect(e.promise.inspect()).toEqual({state:"rejected",reason:t})}),it("for a promise resolved to a fulfilled promise",function(){var e=Q.defer(),t=Q(10);e.resolve(t),expect(e.promise.inspect()).toEqual({state:"fulfilled",value:10})}),it("for a promise resolved to a pending promise",function(){var e=Q.defer(),t=Q.defer();e.resolve(t.promise),expect(e.promise.inspect()).toEqual({state:"pending"})})}),describe("promise states",function(){it("of fulfilled value",function(){expect(Q.isFulfilled(void 0)).toBe(!0),expect(Q.isRejected(!1)).toBe(!1),expect(Q.isPending(!0)).toBe(!1)}),it("of fulfillment",function(){var e=Q(10);expect(Q.isFulfilled(e)).toBe(!0),expect(e.isFulfilled()).toBe(!0),expect(Q.isRejected(e)).toBe(!1),expect(e.isRejected()).toBe(!1),expect(Q.isPending(e)).toBe(!1),expect(e.isPending()).toBe(!1)}),it("of rejection",function(){var e=new Error("Oh, snap."),t=Q.reject(e);expect(t.isFulfilled()).toBe(!1),expect(t.isRejected()).toBe(!0),expect(t.isPending()).toBe(!1)}),it("of rejection with a falsy value",function(){var e=Q.reject(undefined);expect(e.isFulfilled()).toBe(!1),expect(e.isRejected()).toBe(!0),expect(e.isPending()).toBe(!1)}),it("of deferred",function(){var e=Q.defer(),t=e.promise;expect(t.isFulfilled()).toBe(!1),expect(t.isRejected()).toBe(!1),expect(t.isPending()).toBe(!0)}),it("of deferred rejection",function(){var e=Q.defer(),t=Q.reject(new Error("Rejected!"));e.resolve(t);var n=e.promise;expect(n.isFulfilled()).toBe(!1),expect(n.isRejected()).toBe(!0),expect(n.isPending()).toBe(!1)}),it("of deferred fulfillment",function(){var e=Q.defer();e.resolve(10);var t=e.promise;expect(t.isFulfilled()).toBe(!0),expect(t.isRejected()).toBe(!1),expect(t.isPending()).toBe(!1)}),it("of deferred deferred",function(){var e=Q.defer(),t=Q.defer();e.resolve(t.promise);var n=e.promise;expect(n.isFulfilled()).toBe(!1),expect(n.isRejected()).toBe(!1),expect(n.isPending()).toBe(!0)}),it("of isFulfilled side effects",function(){var e=Q.defer(),t=!1;waitsFor(function(){return t});var n=e.promise,r=n.then(function(){return expect(n.isFulfilled()).toBe(!0),expect(r.isFulfilled()).toBe(!1),n.then(function(e){return t=!0,e+1})});e.resolve(1),runs(function(){expect(r.isPending()).toBe(!1),expect(r.isRejected()).toBe(!1),expect(r.isFulfilled()).toBe(!0),expect(r.inspect().value).toBe(2)})})}),describe("propagation",function(){it("propagate through then with no callback",function(){return Q(10).then().then(function(e){expect(e).toBe(10)})}),it("propagate through then with modifying callback",function(){return Q(10).then(function(e){return e+10}).then(function(e){expect(e).toBe(20)})}),it("errback recovers from exception",function(){var e=new Error("Bah!");return Q.reject(e).then(null,function(t){return expect(t).toBe(e),10}).then(function(e){expect(e).toBe(10)})}),it("rejection propagates through then with no errback",function(){var e=new Error("Foolish mortals!");return Q.reject(e).then().then(null,function(t){expect(t).toBe(e)})}),it("rejection intercepted and rethrown",function(){var e=new Error("Foolish mortals!"),t=new Error("Silly humans!");return Q.reject(e).fail(function(){throw t}).then(null,function(e){expect(e).toBe(t)})}),it("resolution is forwarded through deferred promise",function(){var e=Q.defer(),t=Q.defer();return e.resolve(t.promise),t.resolve(10),e.promise.then(function(e){expect(e).toEqual(10)})}),it("should propagate progress by default",function(){var e=Q.defer(),t=[],n=e.promise.then().then(function(){expect(t).toEqual([1])},function(){expect(!0).toBe(!1)},function(e){t.push(e)});return e.notify(1),e.resolve(),n}),it("should allow translation of progress in the progressback",function(){var e=Q.defer(),t=[],n=e.promise.progress(function(e){return e+5}).then(function(){expect(t).toEqual([10])},function(){expect(!0).toBe(!1)},function(e){t.push(e)});return e.notify(5),e.resolve(),n}),it("should stop progress propagation if an error is thrown",function(){var e=Q.defer(),t=e.promise.progress(function(){throw new Error("boo!")});Q.onerror=function(){};var n=[],r=t.then(function(){expect(n).toEqual([])},function(){expect(!0).toBe(!1)},function(e){n.push(e)});return e.notify(),e.resolve(),r})}),describe("all",function(){it("fulfills when passed an empty array",function(){return Q.all([])}),it("rejects after any constituent promise is rejected",function(){var e=Q.defer(),t=Q.defer(),n=[e.promise,t.promise],r=Q.all(n);return t.reject(new Error("Rejected")),Q.delay(250).then(function(){expect(r.isRejected()).toBe(!0)}).timeout(1e3)}),it("resolves foreign thenables",function(){var e=Q(1),t={then:function(e){e(2)}};return Q.all([e,t]).then(function(e){expect(e).toEqual([1,2])})}),it("fulfills when passed an sparse array",function(){var e=Q.defer(),t=[];t[0]=Q(0),t[2]=e.promise;var n=Q.all(t);return e.resolve(2),n.then(function(e){expect(e).toEqual([0,void 0,2])})}),it("modifies the input array",function(){var e=[Q(0),Q(1)];return Q.all(e).then(function(t){expect(t).toBe(e),expect(e).toEqual([0,1])})}),it("sends { index, value } progress updates",function(){var e=Q.defer(),t=Q.defer(),n=[];return Q.delay(50).then(function(){e.notify("a")}),Q.delay(100).then(function(){t.notify("b"),t.resolve()}),Q.delay(150).then(function(){e.notify("c"),e.resolve()}),Q.all([e.promise,t.promise]).then(function(){expect(n).toEqual([{index:0,value:"a"},{index:1,value:"b"},{index:0,value:"c"}])},undefined,function(e){n.push(e)})})}),describe("allSettled",function(){it("works on an empty array",function(){return Q.allSettled([]).then(function(e){expect(e).toEqual([])})}),it("deals with a mix of non-promises and promises",function(){return Q.allSettled([1,Q(2),Q.reject(3)]).then(function(e){expect(e).toEqual([{state:"fulfilled",value:1},{state:"fulfilled",value:2},{state:"rejected",reason:3}])})}),it("is settled after every constituent promise is settled",function(){var e=Q.defer(),t=Q.defer(),n=[e.promise,t.promise],r,i;return Q.fcall(function(){t.reject(),i=!0}).delay(15).then(function(){e.resolve(),r=!0}),Q.allSettled(n).then(function(){expect(r).toBe(!0),expect(i).toBe(!0)})}),it("does not modify the input array",function(){var e=[1,Q(2),Q.reject(3)];return Q.allSettled(e).then(function(t){expect(t).not.toBe(e),expect(t).toEqual([{state:"fulfilled",value:1},{state:"fulfilled",value:2},{state:"rejected",reason:3}])})})}),describe("spread",function(){it("spreads values across arguments",function(){return Q.spread([1,2,3],function(e,t){expect(t).toBe(2)})}),it("spreads promises for arrays across arguments",function(){return Q([Q(10)]).spread(function(e){expect(e).toEqual(10)})}),it("spreads arrays of promises across arguments",function(){var e=Q.defer(),t=Q.defer(),n=Q.spread([e.promise,t.promise],function(e,t){expect(e).toEqual(10),expect(t).toEqual(20)});return Q.delay(5).then(function(){e.resolve(10)}),Q.delay(10).then(function(){t.resolve(20)}),n}),it("calls the errback when given a rejected promise",function(){var e=new Error;return Q.spread([Q(10),Q.reject(e)],function(){expect(!0).toBe(!1)},function(t){expect(t).toBe(e)})})}),describe("fin",function(){var e=new Error("boo!"),t=new TypeError("evil!");describe("when the promise is fulfilled",function(){it("should call the callback",function(){var e=!1;return Q("foo").fin(function(){e=!0}).then(function(){expect(e).toBe(!0)})}),it("should fulfill with the original value",function(){return Q("foo").fin(function(){return"bar"}).then(function(e){expect(e).toBe("foo")})}),describe("when the callback returns a promise",function(){describe("that is fulfilled",function(){it("should fulfill with the original reason after that promise resolves",function(){var e=Q.delay(250);return Q("foo").fin(function(){return e}).then(function(t){expect(Q.isPending(e)).toBe(!1),expect(t).toBe("foo")})})}),describe("that is rejected",function(){it("should reject with this new rejection reason",function(){return Q("foo").fin(function(){return Q.reject(e)}).then(function(){expect(!1).toBe(!0)},function(t){expect(t).toBe(e)})})})}),describe("when the callback throws an exception",function(){it("should reject with this new exception",function(){return Q("foo").fin(function(){throw e}).then(function(){expect(!1).toBe(!0)},function(t){expect(t).toBe(e)})})})}),describe("when the promise is rejected",function(){it("should call the callback",function(){var t=!1;return Q.reject(e).fin(function(){t=!0}).then(function(){expect(t).toBe(!0)},function(){expect(t).toBe(!0)})}),it("should reject with the original reason",function(){return Q.reject(e).fin(function(){return"bar"}).then(function(){expect(!1).toBe(!0)},function(t){expect(t).toBe(e)})}),describe("when the callback returns a promise",function(){describe("that is fulfilled",function(){it("should reject with the original reason after that promise resolves",function(){var t=Q.delay(250);return Q.reject(e).fin(function(){return t}).then(function(){expect(!1).toBe(!0)},function(n){expect(n).toBe(e),expect(Q.isPending(t)).toBe(!1)})})}),describe("that is rejected",function(){it("should reject with the new reason",function(){return Q.reject(e).fin(function(){return Q.reject(t)}).then(function(){expect(!1).toBe(!0)},function(e){expect(e).toBe(t)})})})}),describe("when the callback throws an exception",function(){it("should reject with this new exception",function(){return Q.reject(e).fin(function(){throw t}).then(function(){expect(!1).toBe(!0)},function(e){expect(e).toBe(t)})})})})}),describe("done",function(){describe("when the promise is fulfilled",function(){describe("and the callback does not throw",function(){it("should call the callback and return nothing",function(){var e=!1,t=Q(),n=t.done(function(){e=!0});return t.fail(function(){}).fin(function(){expect(e).toBe(!0),expect(n).toBe(undefined)})})}),describe("and the callback throws",function(){it("should rethrow that error in the next turn and return nothing",function(){var e=0;Q.nextTick(function(){++e});var t=Q().done(function(){throw"foo"}),n=Q.defer();return Q.onerror=function(r){expect(e).toBe(1),expect(r).toBe("foo"),expect(t).toBe(undefined),n.resolve()},Q.delay(100).then(n.reject),n.promise})})}),describe("when the promise is rejected",function(){describe("and the errback handles it",function(){it("should call the errback and return nothing",function(){var e=!1,t=Q.reject(new Error),n=t.done(function(){},function(){e=!0});return t.fail(function(){}).fin(function(){expect(e).toBe(!0),expect(n).toBe(undefined)})})}),describe("and the errback throws",function(){it("should rethrow that error in the next turn and return nothing",function(){var e=0;Q.nextTick(function(){++e});var t=Q.reject("bar").done(null,function(){throw"foo"}),n=Q.defer();return Q.onerror=function(r){expect(e).toBe(1),expect(r).toBe("foo"),expect(t).toBe(undefined),n.resolve()},Q.delay(100).then(n.reject),n.promise})}),describe("and there is no errback",function(){it("should throw the original error in the next turn",function(){var e=0;Q.nextTick(function(){++e});var t=Q.reject("bar").done(),n=Q.defer();return Q.onerror=function(r){expect(e).toBe(1),expect(r).toBe("bar"),expect(t).toBe(undefined),n.resolve()},Q.delay(10).then(n.reject),n.promise})})}),it("should attach a progress listener",function(){var e=Q.defer(),t=jasmine.createSpy();return e.promise.done(null,null,t),e.notify(10),e.resolve(),e.promise.then(function(){expect(t).toHaveBeenCalledWith(10)})})}),describe("timeout",function(){it("should do nothing if the promise fulfills quickly",function(){return Q.delay(10).timeout(200)}),it("should do nothing if the promise rejects quickly",function(){var e=new Error("haha!");return Q.delay(10).then(function(){throw e}).timeout(200).then(undefined,function(t){expect(t).toBe(e)})}),it("should reject with a timeout error if the promise is too slow",function(){return Q.delay(100).timeout(10).then(function(){expect(!0).toBe(!1)},function(e){expect(/time/i.test(e.message)).toBe(!0)})}),it("should pass through progress notifications",function(){var e=Q.defer(),t=[],n=Q.timeout(e.promise,300).then(function(){expect(t).toEqual([1,2,3])},undefined,function(e){t.push(e)});return Q.delay(5).then(function(){e.notify(1)}),Q.delay(15).then(function(){e.notify(2)}),Q.delay(25).then(function(){e.notify(3)}),Q.delay(35).then(function(){e.resolve()}),n}),it("should reject with a custom timeout error if the promise is too slow and msg was provided",function(){return Q.delay(100).timeout(10,"custom").then(function(){expect(!0).toBe(!1)},function(e){expect(/custom/i.test(e.message)).toBe(!0)})})}),describe("delay",function(){it("should delay fulfillment",function(){var e=Q(5).delay(50);return setTimeout(function(){expect(e.isPending()).toBe(!0)},40),e}),it("should not delay rejection",function(){var e=Q.reject(5).delay(50);return Q.delay(20).then(function(){expect(e.isPending()).toBe(!1)})}),it("should treat a single argument as a time",function(){var e=Q.delay(50);return setTimeout(function(){expect(e.isPending()).toBe(!0)},40),e}),it("should treat two arguments as a value + a time",function(){var e=Q.delay("what",50);return setTimeout(function(){expect(e.isPending()).toBe(!0)},40),e.then(function(e){expect(e).toBe("what")})}),it("should delay after resolution",function(){var e=Q.delay("what",30),t=e.delay(30);return setTimeout(function(){expect(e.isPending()).toBe(!1),expect(t.isPending()).toBe(!0)},40),t.then(function(e){expect(e).toBe("what")})}),it("should pass through progress notifications from passed promises",function(){var e=Q.defer(),t=[],n=Q.delay(e.promise,100).then(function(){expect(t).toEqual([1,2,3])},undefined,function(e){t.push(e)});return Q.delay(5).then(function(){e.notify(1)}),Q.delay(15).then(function(){e.notify(2)}),Q.delay(25).then(function(){e.notify(3)}),Q.delay(35).then(function(){e.resolve()}),n})}),describe("thenResolve",function(){describe("Resolving with a non-thenable value",function(){it("returns a promise for that object once the promise is resolved",function(){var e=!1;return Q.delay(20).then(function(){e=!0}).thenResolve("foo").then(function(t){expect(e).toBe(!0),expect(t).toBe("foo")})}),describe("based off a rejected promise",function(){it("does nothing, letting the rejection flow through",function(){return Q.reject("boo").thenResolve("foo").then(function(){expect(!0).toBe(!1)},function(e){expect(e).toBe("boo")})})})}),describe("Resolving with an promise",function(){it("returns a promise for the result of that promise once the promise is resolved",function(){var e=!1;return Q.delay(20).then(function(){e=!0}).thenResolve(Q("foo")).then(function(t){expect(e).toBe(!0),expect(t).toBe("foo")})})})}),describe("thenReject",function(){describe("Rejecting with a reason",function(){it("returns a promise rejected with that object once the original promise is resolved",function(){var e=!1;return Q.delay(20).then(function(){e=!0}).thenReject("foo").then(function(){expect(!0).toBe(!1)},function(t){expect(e).toBe(!0),expect(t).toBe("foo")})}),describe("based off a rejected promise",function(){it("does nothing, letting the rejection flow through",function(){return Q.reject("boo").thenResolve("foo").then(function(){expect(!0).toBe(!1)},function(e){expect(e).toBe("boo")})})})})}),describe("thenables",function(){it("assimilates a thenable with fulfillment with resolve",function(){return Q({then:function(e){e(10)}}).then(function(e){expect(e).toEqual(10)}).then(function(e){expect(e).toEqual(void 0)})}),it("assimilates a thenable with progress and fulfillment (using resolve)",function(){var e=[];return Q({then:function(e,t,n){Q.nextTick(function(){n(1,2),n(3,4,5),e()})}}).progress(function(){e.push(Array.prototype.slice.call(arguments))}).then(function(){expect(e).toEqual([[1],[3]])})}),it("assimilates a thenable with progress and fulfillment (using when)",function(){var e=[];return Q.when({then:function(e,t,n){Q.nextTick(function(){n(1,2),n(3,4,5),e()})}}).progress(function(){e.push(Array.prototype.slice.call(arguments))}).then(function(){expect(e).toEqual([[1],[3]])})}),it("flows fulfillment into a promise pipeline",function(){return Q({then:function(e){e([10])}}).get(0).then(function(e){expect(e).toEqual(10)})}),it("assimilates an immediately-fulfilled thenable in allSettled",function(){return Q.allSettled([{then:function(e){e(10)}}]).then(function(e){expect(e).toEqual([{state:"fulfilled",value:10}])})}),it("assimilates an eventually-fulfilled thenable in allSettled",function(){return Q.allSettled([{then:function(e){setTimeout(function(){e(10)},100)}}]).then(function(e){expect(e).toEqual([{state:"fulfilled",value:10}])})})}),describe("node support",function(){var e=new Error("That is not your favorite color."),t={method:function(e,t,n,r){r(null,e+t+n)},thispChecker:function(e){e(null,this===t)},errorCallbacker:function(t,n,r,i){i(e)},errorThrower:function(){throw e}};describe("nfapply",function(){it("fulfills with callback result",function(){return Q.nfapply(function(e,t,n,r){r(null,e+t+n)},[1,2,3]).then(function(e){expect(e).toEqual(6)})}),it("rejects with callback error",function(){var e=new Error("That is not your favorite color.");return Q.nfapply(function(t,n,r,i){i(e)},[1,2,3]).then(function(){expect(!0).toBe(!1)},function(t){expect(t).toBe(e)})})}),describe("nfcall",function(){it("fulfills with callback result",function(){return Q.nfcall(function(e,t,n,r){r(null,e+t+n)},1,2,3).then(function(e){expect(e).toEqual(6)})}),it("rejects with callback error",function(){var e=new Error("That is not your favorite color.");return Q.nfcall(function(t,n,r,i){i(e)},1,2,3).then(function(){expect(!0).toBe(!1)},function(t){expect(t).toBe(e)})})}),describe("nfbind",function(){it("mixes partial application with complete application",function(){return Q.nfbind(function(e,t,n,r,i){i(null,e+t+n+r)},1,2).call({},3,4).then(function(e){expect(e).toBe(10)})})}),describe("nbind",function(){it("binds this, and mixes partial application with complete application",function(){return Q.nbind(function(e,t,n,r){r(null,this+e+t+n)},1,2).call(3,4,5).then(function(e){expect(e).toBe(12)})}),it("second arg binds this",function(){var e={test:null};return Q.nbind(function(e){e(null,this)},e).call().then(function(t){expect(t).toEqual(e)})})}),describe("npost",function(){it("fulfills with callback result",function(){return Q.npost(t,"method",[1,2,3]).then(function(e){expect(e).toEqual(6)})}),it("gets the correct thisp",function(){return Q.npost(t,"thispChecker",[]).then(function(e){expect(e).toBe(!0)})}),it("rejects with callback error",function(){return Q.npost(t,"errorCallbacker",[1,2,3]).then(function(){expect("blue").toBe("no, yellow!")},function(t){expect(t).toBe(e)})}),it("rejects with thrown error",function(){return Q.npost(t,"errorThrower",[1,2,3]).then(function(){expect(!0).toBe(!1)},function(t){expect(t).toBe(e)})}),it("works on promises for objects with Node methods",function(){return Q(t).npost("method",[1,2,3]).then(function(e){expect(e).toEqual(6)})})}),describe("nsend",function(){it("fulfills with callback result",function(){return Q.nsend(t,"method",1,2,3).then(function(e){expect(e).toEqual(6)})}),it("gets the correct thisp",function(){return Q.nsend(t,"thispChecker").then(function(e){expect(e).toBe(!0)})}),it("rejects with callback error",function(){return Q.nsend(t,"errorCallbacker",1,2,3).then(function(){expect("blue").toBe("no, yellow!")},function(t){expect(t).toBe(e)})}),it("rejects with thrown error",function(){return Q.nsend(t,"errorThrower",1,2,3).then(function(){expect(!0).toBe(!1)},function(t){expect(t).toBe(e)})}),it("works on promises for objects with Node methods",function(){return Q(t).nsend("method",1,2,3).then(function(e){expect(e).toEqual(6)})})}),describe("deferred.makeNodeResolver",function(){it("fulfills a promise with a single callback argument",function(){var e=Q.defer(),t=e.makeNodeResolver();return t(null,10),e.promise.then(function(e){expect(e).toBe(10)})}),it("fulfills a promise with multiple callback arguments",function(){var e=Q.defer(),t=e.makeNodeResolver();return t(null,10,20),e.promise.then(function(e){expect(e).toEqual([10,20])})}),it("rejects a promise",function(){var e=Q.defer(),t=e.makeNodeResolver(),n=new Error("Holy Exception of Anitoch");return t(n),e.promise.then(function(){expect(5).toBe(3)},function(e){expect(e).toBe(n)})})}),describe("nodeify",function(){it("calls back with a resolution",function(){var e=jasmine.createSpy();Q(10).nodeify(e),waitsFor(function(){return e.argsForCall.length}),runs(function(){expect(e.argsForCall).toEqual([[null,10]])})}),it("calls back with an error",function(){var e=jasmine.createSpy();Q.reject(10).nodeify(e),waitsFor(function(){return e.argsForCall.length}),runs(function(){expect(e.argsForCall).toEqual([[10]])})}),it("forwards a promise",function(){return Q(10).nodeify().then(function(e){expect(e).toBe(10)})})})}),describe("isPromise",function(){it("returns true if passed a promise",function(){expect(Q.isPromise(Q(10))).toBe(!0)}),it("returns false if not passed a promise",function(){expect(Q.isPromise(undefined)).toBe(!1),expect(Q.isPromise(null)).toBe(!1),expect(Q.isPromise(10)).toBe(!1),expect(Q.isPromise("str")).toBe(!1),expect(Q.isPromise("")).toBe(!1),expect(Q.isPromise(!0)).toBe(!1),expect(Q.isPromise(!1)).toBe(!1),expect(Q.isPromise({})).toBe(!1),expect(Q.isPromise({then:function(){}})).toBe(!1),expect(Q.isPromise(function(){})).toBe(!1)})}),describe("isPromiseAlike",function(){it("returns true if passed a promise like object",function(){expect(Q.isPromiseAlike(Q(10))).toBe(!0),expect(Q.isPromiseAlike({then:function(){}})).toBe(!0)}),it("returns false if not passed a promise like object",function(){expect(Q.isPromiseAlike(undefined)).toBe(!1),expect(Q.isPromiseAlike(null)).toBe(!1),expect(Q.isPromiseAlike(10)).toBe(!1),expect(Q.isPromiseAlike("str")).toBe(!1),expect(Q.isPromiseAlike("")).toBe(!1),expect(Q.isPromiseAlike(!0)).toBe(!1),expect(Q.isPromiseAlike(!1)).toBe(!1),expect(Q.isPromiseAlike({})).toBe(!1),expect(Q.isPromiseAlike(function(){})).toBe(!1)})});if(typeof require=="function"){var domain;try{domain=require("domain")}catch(e){}if(domain){var EventEmitter=require("events").EventEmitter;describe("node domain support",function(){var e;beforeEach(function(){e=domain.create()}),afterEach(function(){e.dispose()}),it("should work for non-promise async inside a promise handler",function(t){var n=new Error("should be caught by the domain");e.run(function(){Q().then(function(){setTimeout(function(){throw n},10)})});var r=setTimeout(function(){t(new Error("Wasn't caught"))},100);e.on("error",function(e){expect(e).toBe(n),clearTimeout(r),t()})}),it("should transfer errors from `done` into the domain",function(t){var n=new Error("should be caught by the domain");e.run(function(){Q.reject(n).done()});var r=setTimeout(function(){t(new Error("Wasn't caught"))},100);e.on("error",function(e){expect(e).toBe(n),clearTimeout(r),t()})}),it("should take care of re-used event emitters",function(t){function s(){var e=Q.defer();return r.once("beep",function(){e.reject(n)}),e.promise}var n=new Error("should be caught by the domain"),r=new EventEmitter;e.run(function(){s().done()}),setTimeout(function(){r.emit("beep")},100);var i=setTimeout(function(){t(new Error("Wasn't caught"))},500);e.on("error",function(e){expect(e).toBe(n),clearTimeout(i),t()})})})}}describe("decorator functions",function(){describe("promised",function(){var e=new Error("That is not the meaning of life.");it("resolves promised arguments",function(){var e=Q.promised(function(t,n){return t+n});return e(Q(4),Q(5)).then(function(e){expect(e).toEqual(9)})}),it("resolves promised `this`",function(){var e=Q.promised(function(t){return this+t});return e.call(Q(4),Q(5)).then(function(e){expect(e).toEqual(9)})}),it("is rejected if an argument is rejected",function(){var t=Q.promised(function(t,n){return t+n});return t(Q.reject(e),Q(4)).then(function(){expect(4).toEqual(42)},function(t){expect(t).toBe(e)})}),it("is rejected if `this` is rejected",function(){var t=Q.promised(function(t){return this+t});return t.call(Q.reject(e),Q(4)).then(function(){expect(4).toEqual(42)},function(t){expect(t).toBe(e)})})})}),describe("stack trace formatting",function(){it("doesn't mangle a stack trace that gets handled twice",function(){var e=Q.defer(),t=Q.defer(),n=[];e.promise.done(),t.promise.done(),Q.onerror=function(e){n.push(e.stack)};var r=new Error("boom!");return e.reject(r),t.reject(r),Q.all([e.promise.fail(function(){}),t.promise.fail(function(){})]).then(function(){expect(n[0]).toEqual(n[1])})})}),describe("possible regressions",function(){describe("gh-9",function(){it("treats falsy values as resolved values without error",function(){expect(Q.isPending(null)).toEqual(!1),expect(Q.isPending(void 0)).toEqual(!1),expect(Q.isPending(!1)).toEqual(!1),expect(Q.isPending()).toEqual(!1)})}),describe("gh-22",function(){it("ensures that the array prototype is intact",function(){var e=[];for(var t in[])e.push(t);expect(e.length).toBe(0)})}),describe("gh-73",function(){it("does not choke on non-error rejection reasons",function(){Q.reject(REASON).done();var e=Q.defer();return Q.onerror=function(t){expect(t).toBe(REASON),e.resolve()},Q.delay(10).then(e.reject),e.promise})}),describe("gh-90",function(){it("does not choke on rejection reasons with an undefined `stack`",function(){var e=new RangeError(REASON);e.stack=undefined,Q.reject(e).done();var t=Q.defer();return Q.onerror=function(n){expect(n).toBe(e),t.resolve()},Q.delay(10).then(t.reject),t.promise})}),describe("gh-75",function(){it("does not double-resolve misbehaved promises",function(){function n(){++t}var e=Q.makePromise({post:function(){return"hello"}}),t=0;return Q.when(e,n,n).then(function(){expect(t).toBe(1)})})})}),describe("unhandled rejection reporting",function(){beforeEach(function(){Q.resetUnhandledRejections()}),it("doesn't report a resolve, then reject (gh-252)",function(){var e=Q.defer();e.resolve(),e.reject(),expect(Q.getUnhandledReasons().length).toEqual(0)}),it("doesn't report when you chain off a rejection",function(){return Q.reject("this will be handled").get("property").fail(function(){}).fin(function(){expect(Q.getUnhandledReasons().length).toEqual(0)})}),it("reports the most basic case",function(){Q.reject("a reason"),expect(Q.getUnhandledReasons()).toEqual(["(no stack) a reason"])}),it("reports a stack trace",function(){var e=new Error("a reason");Q.reject(e),expect(Q.getUnhandledReasons()).toEqual([e.stack])}),it("doesn't let you mutate the internal array",function(){Q.reject("a reason"),Q.getUnhandledReasons().length=0,expect(Q.getUnhandledReasons()).toEqual(["(no stack) a reason"])}),it("resets after calling `Q.resetUnhandledRejections`",function(){Q.reject("a reason"),Q.resetUnhandledRejections(),expect(Q.getUnhandledReasons()).toEqual([])}),it("stops tracking after calling `Q.stopUnhandledRejectionTracking`",function(){Q.reject("a reason"),Q.stopUnhandledRejectionTracking(),Q.reject("another reason"),expect(Q.getUnhandledReasons()).toEqual([])})});