function Promise(){}var oneOneSecondLater=function(e){setTimeout(function(){e(1)},1e3)},maybeOneOneSecondLater=function(e,t){setTimeout(function(){Math.random()<.5?e(1):t(new Error("Can't provide one."))},1e3)},maybeOneOneSecondLater=function(){var e;return setTimeout(function(){e(1)},1e3),{then:function(t){e=t}}};maybeOneOneSecondLater().then(callback);var maybeOneOneSecondLater=function(){var e=[],t;return setTimeout(function(){t=1;for(var n=0,r=e.length;n<r;n++){var i=e[n];i(t)}e=undefined},1e3),{then:function(n){e?e.push(n):n(t)}}},defer=function(){var e=[],t;return{resolve:function(n){t=n;for(var r=0,i=e.length;r<i;r++){var s=e[r];s(t)}e=undefined},then:function(n){e?e.push(n):n(t)}}},oneOneSecondLater=function(){var e=defer();return setTimeout(function(){e.resolve(1)},1e3),e};oneOneSecondLater().then(callback);var defer=function(){var e=[],t;return{resolve:function(n){if(!e)throw new Error("A promise can only be resolved once.");t=n;for(var r=0,i=e.length;r<i;r++){var s=e[r];s(t)}e=undefined},then:function(n){e?e.push(n):n(t)}}},Promise=function(){},isPromise=function(e){return e instanceof Promise},defer=function(){var e=[],t,n=new Promise;return n.then=function(n){e?e.push(n):n(t)},{resolve:function(n){if(e){t=n;for(var r=0,i=e.length;r<i;r++){var s=e[r];s(t)}e=undefined}},promise:n}},isPromise=function(e){return e&&typeof e.then=="function"},defer=function(){var e=[],t;return{resolve:function(n){if(e){t=n;for(var r=0,i=e.length;r<i;r++){var s=e[r];s(t)}e=undefined}},promise:{then:function(n){e?e.push(n):n(t)}}}},twoOneSecondLater=function(e){var t,n,r=function(){if(t===undefined||n===undefined)return;e(t+n)};oneOneSecondLater(function(e){t=e,r()}),oneOneSecondLater(function(e){n=e,r()})};twoOneSecondLater(function(e){});var a=oneOneSecondLater(),b=oneOneSecondLater(),c=a.then(function(e){return b.then(function(t){return e+t})}),ref=function(e){return{then:function(t){t(e)}}},ref=function(e){return e&&typeof e.then=="function"?e:{then:function(t){t(e)}}},ref=function(e){return e&&typeof e.then=="function"?e:{then:function(t){return ref(t(e))}}},defer=function(){var e=[],t;return{resolve:function(n){if(e){t=ref(n);for(var r=0,i=e.length;r<i;r++){var s=e[r];t.then(s)}e=undefined}},promise:{then:function(n){var r=defer(),i=function(e){r.resolve(n(e))};return e?e.push(i):t.then(i),r.promise}}}},reject=function(e){return{then:function(t,n){return ref(n(e))}}};reject("Meh.").then(function(e){},function(e){});var maybeOneOneSecondLater=function(e,t){var n=defer();return setTimeout(function(){Math.random()<.5?n.resolve(1):n.resolve(reject("Can't provide one."))},1e3),n.promise},defer=function(){var e=[],t;return{resolve:function(n){if(e){t=ref(n);for(var r=0,i=e.length;r<i;r++)t.then.apply(t,e[r]);e=undefined}},promise:{then:function(n,r){var i=defer(),s=function(e){i.resolve(n(e))},o=function(e){i.resolve(r(e))};return e?e.push([s,o]):t.then(s,o),i.promise}}}},defer=function(){var e=[],t;return{resolve:function(n){if(e){t=ref(n);for(var r=0,i=e.length;r<i;r++)t.then.apply(t,e[r]);e=undefined}},promise:{then:function(n,r){var i=defer();n=n||function(e){return e},r=r||function(e){return reject(e)};var s=function(e){i.resolve(n(e))},o=function(e){i.resolve(r(e))};return e?e.push([s,o]):t.then(s,o),i.promise}}}};promises.reduce(function(e,t){return e.then(function(e){return t.then(function(t){return e+t})})},ref(0)).then(function(e){});var blah=function(){var e=foob().then(function(){return t()}),t=function(){return 10};return e},enqueue=function(e){setTimeout(e,1)},defer=function(){var e=[],t;return{resolve:function(n){if(e){t=ref(n);for(var r=0,i=e.length;r<i;r++)enqueue(function(){t.then.apply(t,e[r])});e=undefined}},promise:{then:function(n,r){var i=defer();n=n||function(e){return e},r=r||function(e){return reject(e)};var s=function(e){i.resolve(n(e))},o=function(e){i.resolve(r(e))};return e?e.push([s,o]):enqueue(function(){t.then(s,o)}),i.promise}}}},ref=function(e){return e&&e.then?e:{then:function(t){var n=defer();return enqueue(function(){n.resolve(t(e))}),n.promise}}},reject=function(e){return{then:function(t,n){var r=defer();return enqueue(function(){r.resolve(n(e))}),r.promise}}},when=function(e,t,n){var r=defer(),i;t=t||function(e){return e},n=n||function(e){return reject(e)};var s=function(e){try{return t(e)}catch(n){return reject(n)}},o=function(e){try{return n(e)}catch(e){return reject(e)}};return enqueue(function(){ref(e).then(function(e){if(i)return;i=!0,r.resolve(ref(e).then(s,o))},function(e){if(i)return;i=!0,r.resolve(o(e))})}),r.promise};promise.then(callback,errback),promise.promiseSend("when",callback,errback),Promise.prototype.then=function(e,t){return when(this,e,t)};var makePromise=function(e,t){var n=new Promise;return e=e||{},t=t||function(e){return reject("Can't "+e)},n.promiseSend=function(n,r){var i=Array.prototype.slice.call(arguments,2),s;return r=r||function(e){return e},e[n]?s=e[n].apply(e,i):s=t.apply(e,[n].concat(i)),r(s)},n},ref=function(e){return e&&typeof e.promiseSend!="undefined"?e:e&&typeof e.then!="undefined"?makePromise({when:function(){var t=defer();return e.then(t.resolve,t.reject),t}},function(n){return Q.when(e,function(e){return Q.ref(e).promiseSend.apply(e,arguments)})}):makePromise({when:function(){return e},get:function(t){return e[t]},put:function(t,n){e[t]=n},del:function(t){delete e[t]}})},reject=function(e){var t=function(e){return reject(e)};return makePromise({when:function(n){return n=n||t,n(e)}},t)},defer=function(){var e=[],t;return{resolve:function(n){if(e){t=ref(n);for(var r=0,i=e.length;r<i;r++)enqueue(function(){t.promiseSend.apply(t,e[r])});e=undefined}},promise:{promiseSend:function(){var n=Array.prototype.slice.call(arguments),r=defer();e?e.push(n):enqueue(function(){t.promiseSend.apply(t,n)})}}}},get=function(e,t){var n=defer();return ref(e).promiseSend("get",n.resolve,t),n.promise};get({a:10},"a").then(function(e){});