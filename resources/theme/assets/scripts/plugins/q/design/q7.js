var enqueue=function(e){setTimeout(e,1)},isPromise=function(e){return e&&typeof e.then=="function"},defer=function(){var e=[],t;return{resolve:function(n){if(e){t=ref(n);for(var r=0,i=e.length;r<i;r++)enqueue(function(){t.then.apply(t,e[r])});e=undefined}},promise:{then:function(n,r){var i=defer();n=n||function(e){return e},r=r||function(e){return reject(e)};var s=function(e){i.resolve(n(e))},o=function(e){i.resolve(r(e))};return e?e.push([s,o]):enqueue(function(){t.then(s,o)}),i.promise}}}},ref=function(e){return e&&e.then?e:{then:function(t){var n=defer();return enqueue(function(){n.resolve(t(e))}),n.promise}}},reject=function(e){return{then:function(t,n){var r=defer();return enqueue(function(){r.resolve(n(e))}),r.promise}}},when=function(e,t,n){var r=defer(),i;t=t||function(e){return e},n=n||function(e){return reject(e)};var s=function(e){try{return t(e)}catch(n){return reject(n)}},o=function(e){try{return n(e)}catch(e){return reject(e)}};return enqueue(function(){ref(e).then(function(e){if(i)return;i=!0,r.resolve(ref(e).then(s,o))},function(e){if(i)return;i=!0,r.resolve(o(e))})}),r.promise};