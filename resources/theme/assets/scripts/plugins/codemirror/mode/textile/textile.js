(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror")):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)})(function(e){function n(e,t){t.mode=h.newLayout,t.tableHeading=!1,t.layoutType==="definitionList"&&t.spanningLayout&&e.match(c("definitionListEnd"),!1)&&(t.spanningLayout=!1)}function r(e,n,r){if(r==="_")return e.eat("_")?i(e,n,"italic",/__/,2):i(e,n,"em",/_/,1);if(r==="*")return e.eat("*")?i(e,n,"bold",/\*\*/,2):i(e,n,"strong",/\*/,1);if(r==="[")return e.match(/\d+\]/)&&(n.footCite=!0),s(n);if(r==="("){var o=e.match(/^(r|tm|c)\)/);if(o)return u(n,t.specialChar)}if(r==="<"&&e.match(/(\w+)[^>]+>[^<]+<\/\1>/))return u(n,t.html);if(r==="?"&&e.eat("?"))return i(e,n,"cite",/\?\?/,2);if(r==="="&&e.eat("="))return i(e,n,"notextile",/==/,2);if(r==="-"&&!e.eat("-"))return i(e,n,"deletion",/-/,1);if(r==="+")return i(e,n,"addition",/\+/,1);if(r==="~")return i(e,n,"sub",/~/,1);if(r==="^")return i(e,n,"sup",/\^/,1);if(r==="%")return i(e,n,"span",/%/,1);if(r==="@")return i(e,n,"code",/@/,1);if(r==="!"){var a=i(e,n,"image",/(?:\([^\)]+\))?!/,1);return e.match(/^:\S+/),a}return s(n)}function i(e,t,n,r,i){var o=e.pos>i?e.string.charAt(e.pos-i-1):null,u=e.peek();if(t[n]){if((!u||/\W/.test(u))&&o&&/\S/.test(o)){var a=s(t);return t[n]=!1,a}}else(!o||/\W/.test(o))&&u&&/\S/.test(u)&&e.match(new RegExp("^.*\\S"+r.source+"(?:\\W|$)"),!1)&&(t[n]=!0,t.mode=h.attributes);return s(t)}function s(e){var n=o(e);if(n)return n;var r=[];return e.layoutType&&r.push(t[e.layoutType]),r=r.concat(a(e,"addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","strong","sub","sup","table","tableHeading")),e.layoutType==="header"&&r.push(t.header+"-"+e.header),r.length?r.join(" "):null}function o(e){var n=e.layoutType;switch(n){case"notextile":case"code":case"pre":return t[n];default:if(e.notextile)return t.notextile+(n?" "+t[n]:"");return null}}function u(e,t){var n=o(e);if(n)return n;var r=s(e);return t?r?r+" "+t:t:r}function a(e){var n=[];for(var r=1;r<arguments.length;++r)e[arguments[r]]&&n.push(t[arguments[r]]);return n}function f(e){var t=e.spanningLayout,n=e.layoutType;for(var r in e)e.hasOwnProperty(r)&&delete e[r];e.mode=h.newLayout,t&&(e.layoutType=n,e.spanningLayout=!0)}function c(e){return l.cache[e]||(l.cache[e]=l.createRe(e))}var t={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"},l={cache:{},single:{bc:"bc",bq:"bq",definitionList:/- [^(?::=)]+:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[\/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},attributes:{align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/},createRe:function(e){switch(e){case"drawTable":return l.makeRe("^",l.single.drawTable,"$");case"html":return l.makeRe("^",l.single.html,"(?:",l.single.html,")*","$");case"linkDefinition":return l.makeRe("^",l.single.linkDefinition,"$");case"listLayout":return l.makeRe("^",l.single.list,c("allAttributes"),"*\\s+");case"tableCellAttributes":return l.makeRe("^",l.choiceRe(l.single.tableCellAttributes,c("allAttributes")),"+\\.");case"type":return l.makeRe("^",c("allTypes"));case"typeLayout":return l.makeRe("^",c("allTypes"),c("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return l.makeRe("^",c("allAttributes"),"+");case"allTypes":return l.choiceRe(l.single.div,l.single.foot,l.single.header,l.single.bc,l.single.bq,l.single.notextile,l.single.pre,l.single.table,l.single.para);case"allAttributes":return l.choiceRe(l.attributes.selector,l.attributes.css,l.attributes.lang,l.attributes.align,l.attributes.pad);default:return l.makeRe("^",l.single[e])}},makeRe:function(){var e="";for(var t=0;t<arguments.length;++t){var n=arguments[t];e+=typeof n=="string"?n:n.source}return new RegExp(e)},choiceRe:function(){var e=[arguments[0]];for(var t=1;t<arguments.length;++t)e[t*2-1]="|",e[t*2]=arguments[t];return e.unshift("(?:"),e.push(")"),l.makeRe.apply(null,e)}},h={newLayout:function(e,t){if(e.match(c("typeLayout"),!1))return t.spanningLayout=!1,(t.mode=h.blockType)(e,t);var n;return o(t)||(e.match(c("listLayout"),!1)?n=h.list:e.match(c("drawTable"),!1)?n=h.table:e.match(c("linkDefinition"),!1)?n=h.linkDefinition:e.match(c("definitionList"))?n=h.definitionList:e.match(c("html"),!1)&&(n=h.html)),(t.mode=n||h.text)(e,t)},blockType:function(e,t){var n,r;return t.layoutType=null,(n=e.match(c("type")))?(r=n[0],(n=r.match(c("header")))?(t.layoutType="header",t.header=parseInt(n[0][1])):r.match(c("bq"))?t.layoutType="quote":r.match(c("bc"))?t.layoutType="code":r.match(c("foot"))?t.layoutType="footnote":r.match(c("notextile"))?t.layoutType="notextile":r.match(c("pre"))?t.layoutType="pre":r.match(c("div"))?t.layoutType="div":r.match(c("table"))&&(t.layoutType="table"),t.mode=h.attributes,s(t)):(t.mode=h.text)(e,t)},text:function(e,t){if(e.match(c("text")))return s(t);var n=e.next();return n==='"'?(t.mode=h.link)(e,t):r(e,t,n)},attributes:function(e,n){return n.mode=h.layoutLength,e.match(c("attributes"))?u(n,t.attributes):s(n)},layoutLength:function(e,t){return e.eat(".")&&e.eat(".")&&(t.spanningLayout=!0),t.mode=h.text,s(t)},list:function(e,t){var n=e.match(c("list"));t.listDepth=n[0].length;var r=(t.listDepth-1)%3;return r?r===1?t.layoutType="list2":t.layoutType="list3":t.layoutType="list1",t.mode=h.attributes,s(t)},link:function(e,n){return n.mode=h.text,e.match(c("link"))?(e.match(/\S+/),u(n,t.link)):s(n)},linkDefinition:function(e,n){return e.skipToEnd(),u(n,t.linkDefinition)},definitionList:function(e,t){return e.match(c("definitionList")),t.layoutType="definitionList",e.match(/\s*$/)?t.spanningLayout=!0:t.mode=h.attributes,s(t)},html:function(e,n){return e.skipToEnd(),u(n,t.html)},table:function(e,t){return t.layoutType="table",(t.mode=h.tableCell)(e,t)},tableCell:function(e,t){return e.match(c("tableHeading"))?t.tableHeading=!0:e.eat("|"),t.mode=h.tableCellAttributes,s(t)},tableCellAttributes:function(e,n){return n.mode=h.tableText,e.match(c("tableCellAttributes"))?u(n,t.attributes):s(n)},tableText:function(e,t){return e.match(c("tableText"))?s(t):e.peek()==="|"?(t.mode=h.tableCell,s(t)):r(e,t,e.next())}};e.defineMode("textile",function(){return{startState:function(){return{mode:h.newLayout}},token:function(e,t){return e.sol()&&n(e,t),t.mode(e,t)},blankLine:f}}),e.defineMIME("text/x-textile","textile")});