(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../smarty/smarty")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed","../smarty/smarty"],e):e(CodeMirror)})(function(e){e.defineMode("smartymixed",function(t){function s(e){return e.replace(/[^\s\w]/g,"\\$&")}var n=e.getMode(t,"htmlmixed"),r=e.getMode(t,"smarty"),i={rightDelimiter:"}",leftDelimiter:"{"};t.hasOwnProperty("leftDelimiter")&&(i.leftDelimiter=t.leftDelimiter),t.hasOwnProperty("rightDelimiter")&&(i.rightDelimiter=t.rightDelimiter);var o=s(i.leftDelimiter),u=s(i.rightDelimiter),a={smartyComment:new RegExp("^"+u+"\\*"),literalOpen:new RegExp(o+"literal"+u),literalClose:new RegExp(o+"/literal"+u),hasLeftDelimeter:new RegExp(".*"+o),htmlHasLeftDelimeter:new RegExp("[^<>]*"+o)},f={chain:function(e,t,n){return t.tokenize=n,n(e,t)},cleanChain:function(e,t,n){return t.tokenize=null,t.localState=null,t.localMode=null,typeof n=="string"?n?n:null:n(e,t)},maybeBackup:function(e,t,n){var r=e.current(),i=r.search(t),s;if(i>-1)e.backUp(r.length-i);else if(s=r.match(/<\/?$/))e.backUp(r.length),e.match(t,!1)||e.match(r[0]);return n}},l={html:function(e,t){var s=t.htmlMixedState.htmlState.context&&t.htmlMixedState.htmlState.context.tagName?t.htmlMixedState.htmlState.context.tagName:null;return!t.inLiteral&&e.match(a.htmlHasLeftDelimeter,!1)&&s===null?(t.tokenize=l.smarty,t.localMode=r,t.localState=r.startState(n.indent(t.htmlMixedState,"")),f.maybeBackup(e,i.leftDelimiter,r.token(e,t.localState))):!t.inLiteral&&e.match(i.leftDelimiter,!1)?(t.tokenize=l.smarty,t.localMode=r,t.localState=r.startState(n.indent(t.htmlMixedState,"")),f.maybeBackup(e,i.leftDelimiter,r.token(e,t.localState))):n.token(e,t.htmlMixedState)},smarty:function(e,t){if(e.match(i.leftDelimiter,!1)){if(e.match(a.smartyComment,!1))return f.chain(e,t,l.inBlock("comment","*"+i.rightDelimiter))}else if(e.match(i.rightDelimiter,!1))return e.eat(i.rightDelimiter),t.tokenize=l.html,t.localMode=n,t.localState=t.htmlMixedState,"tag";return f.maybeBackup(e,i.rightDelimiter,r.token(e,t.localState))},inBlock:function(e,t){return function(n,r){while(!n.eol()){if(n.match(t)){f.cleanChain(n,r,"");break}n.next()}return e}}};return{startState:function(){var e=n.startState();return{token:l.html,localMode:null,localState:null,htmlMixedState:e,tokenize:null,inLiteral:!1}},copyState:function(t){var i=null,s=t.tokenize||t.token;return t.localState&&(i=e.copyState(s!=l.html?r:n,t.localState)),{token:t.token,tokenize:t.tokenize,localMode:t.localMode,localState:i,htmlMixedState:e.copyState(n,t.htmlMixedState),inLiteral:t.inLiteral}},token:function(e,t){if(e.match(i.leftDelimiter,!1)){if(!t.inLiteral&&e.match(a.literalOpen,!0))return t.inLiteral=!0,"keyword";if(t.inLiteral&&e.match(a.literalClose,!0))return t.inLiteral=!1,"keyword"}t.inLiteral&&t.localState!=t.htmlMixedState&&(t.tokenize=l.html,t.localMode=n,t.localState=t.htmlMixedState);var r=(t.tokenize||t.token)(e,t);return r},indent:function(t,i){return t.localMode==r||t.inLiteral&&!t.localMode||a.hasLeftDelimeter.test(i)?e.Pass:n.indent(t.htmlMixedState,i)},innerMode:function(e){return{state:e.localState||e.htmlMixedState,mode:e.localMode||n}}}},"htmlmixed","smarty"),e.defineMIME("text/x-smarty","smartymixed")});