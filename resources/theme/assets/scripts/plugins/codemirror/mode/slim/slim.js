(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../ruby/ruby")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed","../ruby/ruby"],e):e(CodeMirror)})(function(e){e.defineMode("slim",function(t){function m(e,t,n){var r=function(r,i){return i.tokenize=t,r.pos<e?(r.pos=e,n):i.tokenize(r,i)};return function(e,n){return n.tokenize=r,t(e,n)}}function g(e,t,n,r,i){var s=e.current(),o=s.search(n);return o>-1&&(t.tokenize=m(e.pos,t.tokenize,i),e.backUp(s.length-o-r)),i}function y(e,t){e.stack={parent:e.stack,style:"continuation",indented:t,tokenize:e.line},e.line=e.tokenize}function b(e){e.line==e.tokenize&&(e.line=e.stack.tokenize,e.stack=e.stack.parent)}function w(e,t){return function(n,r){b(r);if(n.match(/^\\$/))return y(r,e),"lineContinuation";var i=t(n,r);return n.eol()&&n.current().match(/(?:^|[^\\])(?:\\\\)*\\$/)&&n.backUp(1),i}}function E(e,t){return function(n,r){b(r);var i=t(n,r);return n.eol()&&n.current().match(/,$/)&&y(r,e),i}}function S(e,t){return function(n,r){var i=n.peek();return i==e&&r.rubyState.tokenize.length==1?(n.next(),r.tokenize=t,"closeAttributeTag"):T(n,r)}}function x(e){var t,n=function(n,r){if(r.rubyState.tokenize.length==1&&!r.rubyState.context.prev){n.backUp(1);if(n.eatSpace())return r.rubyState=t,r.tokenize=e,e(n,r);n.next()}return T(n,r)};return function(e,i){return t=i.rubyState,i.rubyState=r.startState(),i.tokenize=n,T(e,i)}}function T(e,t){return r.token(e,t.rubyState)}function N(e,t){return e.match(/^\\$/)?"lineContinuation":C(e,t)}function C(e,t){return e.match(/^#\{/)?(t.tokenize=S("}",t.tokenize),null):g(e,t,/[^\\]#\{/,1,n.token(e,t.htmlState))}function k(e){return function(t,n){var r=N(t,n);return t.eol()&&(n.tokenize=e),r}}function L(e,t,n){return t.stack={parent:t.stack,style:"html",indented:e.column()+n,tokenize:t.line},t.line=t.tokenize=C,null}function A(e,t){return e.skipToEnd(),t.stack.style}function O(e,t){return t.stack={parent:t.stack,style:"comment",indented:t.indented+1,tokenize:t.line},t.line=A,A(e,t)}function M(e,t){return e.eat(t.stack.endQuote)?(t.line=t.stack.line,t.tokenize=t.stack.tokenize,t.stack=t.stack.parent,null):e.match(p)?(t.tokenize=_,"slimAttribute"):(e.next(),null)}function _(e,t){return e.match(/^==?/)?(t.tokenize=D,null):M(e,t)}function D(e,t){var n=e.peek();return n=='"'||n=="'"?(t.tokenize=Q(n,"string",!0,!1,M),e.next(),t.tokenize(e,t)):n=="["?x(M)(e,t):e.match(/^(true|false|nil)\b/)?(t.tokenize=M,"keyword"):x(M)(e,t)}function P(e,t,n){return e.stack={parent:e.stack,style:"wrapper",indented:e.indented+1,tokenize:n,line:e.line,endQuote:t},e.line=e.tokenize=M,null}function H(t,n){if(t.match(/^#\{/))return n.tokenize=S("}",n.tokenize),null;var r=new e.StringStream(t.string.slice(n.stack.indented),t.tabSize);r.pos=t.pos-n.stack.indented,r.start=t.start-n.stack.indented,r.lastColumnPos=t.lastColumnPos-n.stack.indented,r.lastColumnValue=t.lastColumnValue-n.stack.indented;var i=n.subMode.token(r,n.subState);return t.pos=r.pos+n.stack.indented,i}function B(e,t){return t.stack.indented=e.column(),t.line=t.tokenize=H,t.tokenize(e,t)}function j(n){var r=s[n],i=e.mimeModes[r];if(i)return e.getMode(t,i);var o=e.modes[r];return o?o(t,{name:r}):e.getMode(t,"null")}function F(e){return i.hasOwnProperty(e)?i[e]:i[e]=j(e)}function I(e,t){var n=F(e),r=n.startState&&n.startState();return t.subMode=n,t.subState=r,t.stack={parent:t.stack,style:"sub",indented:t.indented+1,tokenize:t.line},t.line=t.tokenize=B,"slimSubmode"}function q(e,t){return e.skipToEnd(),"slimDoctype"}function R(e,t){var n=e.peek();if(n=="<")return(t.tokenize=k(t.tokenize))(e,t);if(e.match(/^[|']/))return L(e,t,1);if(e.match(/^\/(!|\[\w+])?/))return O(e,t);if(e.match(/^(-|==?[<>]?)/))return t.tokenize=w(e.column(),E(e.column(),T)),"slimSwitch";if(e.match(/^doctype\b/))return t.tokenize=q,"keyword";var r=e.match(o);return r?I(r[1],t):z(e,t)}function U(e,t){return t.startOfLine?R(e,t):z(e,t)}function z(e,t){return e.eat("*")?(t.tokenize=x(W),null):e.match(c)?(t.tokenize=W,"slimTag"):X(e,t)}function W(e,t){return e.match(/^(<>?|><?)/)?(t.tokenize=X,null):X(e,t)}function X(e,t){return e.match(v)?(t.tokenize=X,"slimId"):e.match(d)?(t.tokenize=X,"slimClass"):V(e,t)}function V(e,t){return e.match(/^([\[\{\(])/)?P(t,a[RegExp.$1],V):e.match(h)?(t.tokenize=$,"slimAttribute"):e.peek()=="*"?(e.next(),t.tokenize=x(G),null):G(e,t)}function $(e,t){return e.match(/^==?/)?(t.tokenize=J,null):V(e,t)}function J(e,t){var n=e.peek();return n=='"'||n=="'"?(t.tokenize=Q(n,"string",!0,!1,V),e.next(),t.tokenize(e,t)):n=="["?x(V)(e,t):n==":"?x(K)(e,t):e.match(/^(true|false|nil)\b/)?(t.tokenize=V,"keyword"):x(V)(e,t)}function K(e,t){return e.backUp(1),e.match(/^[^\s],(?=:)/)?(t.tokenize=x(K),null):(e.next(),V(e,t))}function Q(e,t,n,r,i){return function(s,o){b(o);var u=s.current().length==0;if(s.match(/^\\$/,u))return u?(y(o,o.indented),"lineContinuation"):t;if(s.match(/^#\{/,u))return u?(o.tokenize=S("}",o.tokenize),null):t;var a=!1,f;while((f=s.next())!=null){if(f==e&&(r||!a)){o.tokenize=i;break}if(n&&f=="#"&&!a&&s.eat("{")){s.backUp(2);break}a=!a&&f=="\\"}return s.eol()&&a&&s.backUp(1),t}}function G(e,t){return e.match(/^==?/)?(t.tokenize=T,"slimSwitch"):e.match(/^\/$/)?(t.tokenize=U,null):e.match(/^:/)?(t.tokenize=z,"slimSwitch"):(L(e,t,0),t.tokenize(e,t))}var n=e.getMode(t,{name:"htmlmixed"}),r=e.getMode(t,"ruby"),i={html:n,ruby:r},s={ruby:"ruby",javascript:"javascript",css:"text/css",sass:"text/x-sass",scss:"text/x-scss",less:"text/x-less",styl:"text/x-styl",coffee:"coffeescript",asciidoc:"text/x-asciidoc",markdown:"text/x-markdown",textile:"text/x-textile",creole:"text/x-creole",wiki:"text/x-wiki",mediawiki:"text/x-mediawiki",rdoc:"text/x-rdoc",builder:"text/x-builder",nokogiri:"text/x-nokogiri",erb:"application/x-erb"},o=function(e){var t=[];for(var n in e)t.push(n);return new RegExp("^("+t.join("|")+"):")}(s),u={commentLine:"comment",slimSwitch:"operator special",slimTag:"tag",slimId:"attribute def",slimClass:"attribute qualifier",slimAttribute:"attribute",slimSubmode:"keyword special",closeAttributeTag:null,slimDoctype:null,lineContinuation:null},a={"{":"}","[":"]","(":")"},f="_a-zA-ZÀ-ÖØ-öø-˿Ͱ-ͽͿ-῿‌-‍⁰-↏Ⰰ-⿯、-퟿豈-﷏ﷰ-�",l=f+"\\-0-9·̀-ͯ‿-⁀",c=new RegExp("^[:"+f+"](?::["+l+"]|["+l+"]*)"),h=new RegExp("^[:"+f+"][:\\."+l+"]*(?=\\s*=)"),p=new RegExp("^[:"+f+"][:\\."+l+"]*"),d=/^\.-?[_a-zA-Z]+[\w\-]*/,v=/^#[_a-zA-Z]+[\w\-]*/,Y={startState:function(){var e=n.startState(),t=r.startState();return{htmlState:e,rubyState:t,stack:null,last:null,tokenize:U,line:U,indented:0}},copyState:function(t){return{htmlState:e.copyState(n,t.htmlState),rubyState:e.copyState(r,t.rubyState),subMode:t.subMode,subState:t.subMode&&e.copyState(t.subMode,t.subState),stack:t.stack,last:t.last,tokenize:t.tokenize,line:t.line}},token:function(e,t){if(e.sol()){t.indented=e.indentation(),t.startOfLine=!0,t.tokenize=t.line;while(t.stack&&t.stack.indented>t.indented&&t.last!="slimSubmode")t.line=t.tokenize=t.stack.tokenize,t.stack=t.stack.parent,t.subMode=null,t.subState=null}if(e.eatSpace())return null;var n=t.tokenize(e,t);return t.startOfLine=!1,n&&(t.last=n),u.hasOwnProperty(n)?u[n]:n},blankLine:function(e){if(e.subMode&&e.subMode.blankLine)return e.subMode.blankLine(e.subState)},innerMode:function(e){return e.subMode?{state:e.subState,mode:e.subMode}:{state:e,mode:Y}}};return Y},"htmlmixed","ruby"),e.defineMIME("text/x-slim","slim"),e.defineMIME("application/x-slim","slim")});