(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror"),require("../python/python"),require("../stex/stex"),require("../../addon/mode/overlay")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","../python/python","../stex/stex","../../addon/mode/overlay"],e):e(CodeMirror)})(function(e){e.defineMode("rst",function(t,n){var r=/^\*\*[^\*\s](?:[^\*]*[^\*\s])?\*\*/,i=/^\*[^\*\s](?:[^\*]*[^\*\s])?\*/,s=/^``[^`\s](?:[^`]*[^`\s])``/,o=/^(?:[\d]+(?:[\.,]\d+)*)/,u=/^(?:\s\+[\d]+(?:[\.,]\d+)*)/,a=/^(?:\s\-[\d]+(?:[\.,]\d+)*)/,f="[Hh][Tt][Tt][Pp][Ss]?://",l="(?:[\\d\\w.-]+)\\.(?:\\w{2,6})",c="(?:/[\\d\\w\\#\\%\\&\\-\\.\\,\\/\\:\\=\\?\\~]+)*",h=new RegExp("^"+f+l+c),p={token:function(e){if(e.match(r)&&e.match(/\W+|$/,!1))return"strong";if(e.match(i)&&e.match(/\W+|$/,!1))return"em";if(e.match(s)&&e.match(/\W+|$/,!1))return"string-2";if(e.match(o))return"number";if(e.match(u))return"positive";if(e.match(a))return"negative";if(e.match(h))return"link";while(e.next()!=null){if(e.match(r,!1))break;if(e.match(i,!1))break;if(e.match(s,!1))break;if(e.match(o,!1))break;if(e.match(u,!1))break;if(e.match(a,!1))break;if(e.match(h,!1))break}return null}},d=e.getMode(t,n.backdrop||"rst-base");return e.overlayMode(d,p,!0)},"python","stex"),e.defineMode("rst-base",function(t){function n(e){var t=Array.prototype.slice.call(arguments,1);return e.replace(/{(\d+)}/g,function(e,n){return typeof t[n]!="undefined"?t[n]:e})}function R(t,n){var s=null;if(t.sol()&&t.match(q,!1))J(n,V,{mode:r,local:e.startState(r)});else if(t.sol()&&t.match(m))J(n,U),s="meta";else if(t.sol()&&t.match(v))J(n,R),s="header";else if(Q(n)==k||t.match(k,!1))switch(K(n)){case 0:J(n,R,$(k,1)),t.match(/^:/),s="meta";break;case 1:J(n,R,$(k,2)),t.match(f),s="keyword",t.current().match(/^(?:math|latex)/)&&(n.tmp_stex=!0);break;case 2:J(n,R,$(k,3)),t.match(/^:`/),s="meta";break;case 3:n.tmp_stex&&(n.tmp_stex=undefined,n.tmp={mode:i,local:e.startState(i)});if(n.tmp){if(t.peek()=="`"){J(n,R,$(k,4)),n.tmp=undefined;break}s=n.tmp.mode.token(t,n.tmp.local);break}J(n,R,$(k,4)),t.match(d),s="string";break;case 4:J(n,R,$(k,5)),t.match(/^`/),s="meta";break;case 5:J(n,R,$(k,6)),t.match(u);break;default:J(n,R)}else if(Q(n)==L||t.match(L,!1))switch(K(n)){case 0:J(n,R,$(L,1)),t.match(/^`/),s="meta";break;case 1:J(n,R,$(L,2)),t.match(d),s="string";break;case 2:J(n,R,$(L,3)),t.match(/^`:/),s="meta";break;case 3:J(n,R,$(L,4)),t.match(f),s="keyword";break;case 4:J(n,R,$(L,5)),t.match(/^:/),s="meta";break;case 5:J(n,R,$(L,6)),t.match(u);break;default:J(n,R)}else if(Q(n)==A||t.match(A,!1))switch(K(n)){case 0:J(n,R,$(A,1)),t.match(/^:/),s="meta";break;case 1:J(n,R,$(A,2)),t.match(f),s="keyword";break;case 2:J(n,R,$(A,3)),t.match(/^:/),s="meta";break;case 3:J(n,R,$(A,4)),t.match(u);break;default:J(n,R)}else if(Q(n)==S||t.match(S,!1))switch(K(n)){case 0:J(n,R,$(S,1)),t.match(_),s="variable-2";break;case 1:J(n,R,$(S,2)),t.match(/^_?_?/)&&(s="link");break;default:J(n,R)}else if(t.match(x))J(n,R),s="quote";else if(t.match(T))J(n,R),s="quote";else if(t.match(N)){J(n,R);if(!t.peek()||t.peek().match(/^\W$/))s="link"}else if(Q(n)==C||t.match(C,!1))switch(K(n)){case 0:!t.peek()||t.peek().match(/^\W$/)?J(n,R,$(C,1)):t.match(C);break;case 1:J(n,R,$(C,2)),t.match(/^`/),s="link";break;case 2:J(n,R,$(C,3)),t.match(d);break;case 3:J(n,R,$(C,4)),t.match(/^`_/),s="link";break;default:J(n,R)}else t.match(I)?J(n,W):t.next()&&J(n,R);return s}function U(t,n){var s=null;if(Q(n)==b||t.match(b,!1))switch(K(n)){case 0:J(n,U,$(b,1)),t.match(_),s="variable-2";break;case 1:J(n,U,$(b,2)),t.match(D);break;case 2:J(n,U,$(b,3)),t.match(P),s="keyword";break;case 3:J(n,U,$(b,4)),t.match(H),s="meta";break;default:J(n,R)}else if(Q(n)==y||t.match(y,!1))switch(K(n)){case 0:J(n,U,$(y,1)),t.match(O),s="keyword",t.current().match(/^(?:math|latex)/)?n.tmp_stex=!0:t.current().match(/^python/)&&(n.tmp_py=!0);break;case 1:J(n,U,$(y,2)),t.match(M),s="meta";if(t.match(/^latex\s*$/)||n.tmp_stex)n.tmp_stex=undefined,J(n,V,{mode:i,local:e.startState(i)});break;case 2:J(n,U,$(y,3));if(t.match(/^python\s*$/)||n.tmp_py)n.tmp_py=undefined,J(n,V,{mode:r,local:e.startState(r)});break;default:J(n,R)}else if(Q(n)==g||t.match(g,!1))switch(K(n)){case 0:J(n,U,$(g,1)),t.match(B),t.match(j),s="link";break;case 1:J(n,U,$(g,2)),t.match(F),s="meta";break;default:J(n,R)}else t.match(w)?(J(n,R),s="quote"):t.match(E)?(J(n,R),s="quote"):(t.eatSpace(),t.eol()?J(n,R):(t.skipToEnd(),J(n,z),s="comment"));return s}function z(e,t){return X(e,t,"comment")}function W(e,t){return X(e,t,"meta")}function X(e,t,n){return e.eol()||e.eatSpace()?(e.skipToEnd(),n):(J(t,R),null)}function V(e,t){return t.ctx.mode&&t.ctx.local?e.sol()?(e.eatSpace()||J(t,R),null):t.ctx.mode.token(e,t.ctx.local):(J(t,R),null)}function $(e,t,n,r){return{phase:e,stage:t,mode:n,local:r}}function J(e,t,n){e.tok=t,e.ctx=n||{}}function K(e){return e.ctx.stage||0}function Q(e){return e.ctx.phase}var r=e.getMode(t,"python"),i=e.getMode(t,"stex"),s="\\s+",o="(?:\\s*|\\W|$)",u=new RegExp(n("^{0}",o)),a="(?:[^\\W\\d_](?:[\\w!\"#$%&'()\\*\\+,\\-\\./:;<=>\\?]*[^\\W_])?)",f=new RegExp(n("^{0}",a)),l="(?:[^\\W\\d_](?:[\\w\\s!\"#$%&'()\\*\\+,\\-\\./:;<=>\\?]*[^\\W_])?)",c=n("(?:{0}|`{1}`)",a,l),h="(?:[^\\s\\|](?:[^\\|]*[^\\s\\|])?)",p="(?:[^\\`]+)",d=new RegExp(n("^{0}",p)),v=new RegExp("^([!'#$%&\"()*+,-./:;<=>?@\\[\\\\\\]^_`{|}~])\\1{3,}\\s*$"),m=new RegExp(n("^\\.\\.{0}",s)),g=new RegExp(n("^_{0}:{1}|^__:{1}",c,o)),y=new RegExp(n("^{0}::{1}",c,o)),b=new RegExp(n("^\\|{0}\\|{1}{2}::{3}",h,s,c,o)),w=new RegExp(n("^\\[(?:\\d+|#{0}?|\\*)]{1}",c,o)),E=new RegExp(n("^\\[{0}\\]{1}",c,o)),S=new RegExp(n("^\\|{0}\\|",h)),x=new RegExp(n("^\\[(?:\\d+|#{0}?|\\*)]_",c)),T=new RegExp(n("^\\[{0}\\]_",c)),N=new RegExp(n("^{0}__?",c)),C=new RegExp(n("^`{0}`_",p)),k=new RegExp(n("^:{0}:`{1}`{2}",a,p,o)),L=new RegExp(n("^`{1}`:{0}:{2}",a,p,o)),A=new RegExp(n("^:{0}:{1}",a,o)),O=new RegExp(n("^{0}",c)),M=new RegExp(n("^::{0}",o)),_=new RegExp(n("^\\|{0}\\|",h)),D=new RegExp(n("^{0}",s)),P=new RegExp(n("^{0}",c)),H=new RegExp(n("^::{0}",o)),B=new RegExp("^_"),j=new RegExp(n("^{0}|_",c)),F=new RegExp(n("^:{0}",o)),I=new RegExp("^::\\s*$"),q=new RegExp("^\\s+(?:>>>|In \\[\\d+\\]:)\\s");return{startState:function(){return{tok:R,ctx:$(undefined,0)}},copyState:function(t){var n=t.ctx,r=t.tmp;return n.local&&(n={mode:n.mode,local:e.copyState(n.mode,n.local)}),r&&(r={mode:r.mode,local:e.copyState(r.mode,r.local)}),{tok:t.tok,ctx:n,tmp:r}},innerMode:function(e){return e.tmp?{state:e.tmp.local,mode:e.tmp.mode}:e.ctx.mode?{state:e.ctx.local,mode:e.ctx.mode}:null},token:function(e,t){return t.tok(e,t)}}},"python","stex"),e.defineMIME("text/x-rst","rst")});