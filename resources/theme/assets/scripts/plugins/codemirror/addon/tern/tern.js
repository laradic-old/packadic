(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror")):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)})(function(e){function i(e,t,n){var r=e.docs[t];r?n(H(e,r)):e.options.getFile?e.options.getFile(t,n):n(null)}function s(e,t,n){for(var r in e.docs){var i=e.docs[r];if(i.doc==t)return i}if(!n)for(var s=0;;++s){r="[doc"+(s||"")+"]";if(!e.docs[r]){n=r;break}}return e.addDoc(n,t)}function o(t,n){if(typeof n=="string")return t.docs[n];n instanceof e&&(n=n.getDoc());if(n instanceof e.Doc)return s(t,n)}function u(e,t,n){var i=s(e,t),o=e.cachedArgHints;o&&o.doc==t&&C(o.start,n.to)<=0&&(e.cachedArgHints=null);var u=i.changed;u==null&&(i.changed=u={from:n.from.line,to:n.from.line});var f=n.from.line+(n.text.length-1);n.from.line<u.to&&(u.to=u.to-(n.to.line-f)),f>=u.to&&(u.to=f+1),u.from>n.from.line&&(u.from=n.from.line),t.lineCount()>r&&n.to-u.from>100&&setTimeout(function(){i.changed&&i.changed.to-i.changed.from>100&&a(e,i)},200)}function a(e,t){e.server.request({files:[{type:"full",name:t.name,text:H(e,t)}]},function(e){e?window.console.error(e):t.changed=null})}function f(r,i,s){r.request(i,{type:"completions",types:!0,docs:!0,urls:!0},function(o,u){if(o)return D(r,i,o);var a=[],f="",c=u.start,h=u.end;i.getRange(t(c.line,c.ch-2),c)=='["'&&i.getRange(h,t(h.line,h.ch+2))!='"]'&&(f='"]');for(var p=0;p<u.completions.length;++p){var d=u.completions[p],v=l(d.type);u.guess&&(v+=" "+n+"guess"),a.push({text:d.name+f,displayText:d.name,className:v,data:d})}var m={from:c,to:h,list:a},g=null;e.on(m,"close",function(){M(g)}),e.on(m,"update",function(){M(g)}),e.on(m,"select",function(e,t){M(g);var i=r.options.completionTip?r.options.completionTip(e.data):e.data.doc;i&&(g=O(t.parentNode.getBoundingClientRect().right+window.pageXOffset,t.getBoundingClientRect().top+window.pageYOffset,i),g.className+=" "+n+"hint-doc")}),s(m)})}function l(e){var t;return e=="?"?t="unknown":e=="number"||e=="string"||e=="bool"?t=e:/^fn\(/.test(e)?t="fn":/^\[/.test(e)?t="array":t="object",n+"completion "+n+"completion-"+t}function c(e,t,n,r,i){e.request(t,r,function(n,r){if(n)return D(e,t,n);if(e.options.typeTip)var s=e.options.typeTip(r);else{var s=k("span",null,k("strong",null,r.type||"not found"));r.doc&&s.appendChild(document.createTextNode(" — "+r.doc)),r.url&&(s.appendChild(document.createTextNode(" ")),s.appendChild(k("a",null,"[docs]")).href=r.url)}A(t,s),i&&i()},n)}function h(n,r){P(n);if(r.somethingSelected())return;var i=r.getTokenAt(r.getCursor()).state,s=e.innerMode(r.getMode(),i);if(s.mode.name!="javascript")return;var o=s.state.lexical;if(o.info!="call")return;var u,a=o.pos||0,f=r.getOption("tabSize");for(var l=r.getCursor().line,c=Math.max(0,l-9),h=!1;l>=c;--l){var v=r.getLine(l),m=0;for(var g=0;;){var y=v.indexOf("	",g);if(y==-1)break;m+=f-(y+m)%f-1,g=y+1}u=o.column-m;if(v.charAt(u)=="("){h=!0;break}}if(!h)return;var b=t(l,u),w=n.cachedArgHints;if(w&&w.doc==r.getDoc()&&C(b,w.start)==0)return p(n,r,a);n.request(r,{type:"type",preferFunction:!0,end:b},function(e,t){if(e||!t.type||!/^fn\(/.test(t.type))return;n.cachedArgHints={start:g,type:d(t.type),name:t.exprName||t.name||"fn",guess:t.guess,doc:r.getDoc()},p(n,r,a)})}function p(e,t,r){P(e);var i=e.cachedArgHints,s=i.type,o=k("span",i.guess?n+"fhint-guess":null,k("span",n+"fname",i.name),"(");for(var u=0;u<s.args.length;++u){u&&o.appendChild(document.createTextNode(", "));var a=s.args[u];o.appendChild(k("span",n+"farg"+(u==r?" "+n+"farg-current":""),a.name||"?")),a.type!="?"&&(o.appendChild(document.createTextNode(": ")),o.appendChild(k("span",n+"type",a.type)))}o.appendChild(document.createTextNode(s.rettype?") -> ":")")),s.rettype&&o.appendChild(k("span",n+"type",s.rettype));var f=t.cursorCoords(null,"page");e.activeArgHints=O(f.right+1,f.bottom,o)}function d(e){function r(t){var r=0,i=n;for(;;){var s=e.charAt(n);if(t.test(s)&&!r)return e.slice(i,n);/[{\[\(]/.test(s)?++r:/[}\]\)]/.test(s)&&--r,++n}}var t=[],n=3;if(e.charAt(n)!=")")for(;;){var i=e.slice(n).match(/^([^, \(\[\{]+): /);i&&(n+=i[0].length,i=i[1]),t.push({name:i,type:r(/[\),]/)});if(e.charAt(n)==")")break;n+=2}var s=e.slice(n).match(/^\) -> (.*)$/);return{args:t,rettype:s&&s[1]}}function v(e,t){function n(n){var r={type:"definition",variable:n||null},i=s(e,t.getDoc());e.server.request(T(e,i,r),function(n,r){if(n)return D(e,t,n);if(!r.file&&r.url){window.open(r.url);return}if(r.file){var s=e.docs[r.file],o;if(s&&(o=y(s.doc,r))){e.jumpStack.push({file:i.name,start:t.getCursor("from"),end:t.getCursor("to")}),g(e,i,s,o.start,o.end);return}}D(e,t,"Could not find a definition.")})}b(t)?n():L(t,"Jump to variable",function(e){e&&n(e)})}function m(e,t){var n=e.jumpStack.pop(),r=n&&e.docs[n.file];if(!r)return;g(e,s(e,t.getDoc()),r,n.start,n.end)}function g(e,t,n,r,i){n.doc.setSelection(r,i),t!=n&&e.options.switchToDoc&&(P(e),e.options.switchToDoc(n.name,n.doc))}function y(e,n){var r=n.context.slice(0,n.contextOffset).split("\n"),i=n.start.line-(r.length-1),s=t(i,(r.length==1?n.start.ch:e.getLine(i).length)-r[0].length),o=e.getLine(i).slice(s.ch);for(var u=i+1;u<e.lineCount()&&o.length<n.context.length;++u)o+="\n"+e.getLine(u);if(o.slice(0,n.context.length)==n.context)return n;var a=e.getSearchCursor(n.context,0,!1),f,l=Infinity;while(a.findNext()){var c=a.from(),h=Math.abs(c.line-s.line)*1e4;h||(h=Math.abs(c.ch-s.ch)),h<l&&(f=c,l=h)}if(!f)return null;r.length==1?f.ch+=r[0].length:f=t(f.line+(r.length-1),r[r.length-1].length);if(n.start.line==n.end.line)var p=t(f.line,f.ch+(n.end.ch-n.start.ch));else var p=t(f.line+(n.end.line-n.start.line),n.end.ch);return{start:f,end:p}}function b(e){var t=e.getCursor("end"),n=e.getTokenAt(t);return n.start<t.ch&&(n.type=="comment"||n.type=="string")?!1:/\w/.test(e.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}function w(e,t){var n=t.getTokenAt(t.getCursor());if(!/\w/.test(n.string))return D(e,t,"Not at a variable");L(t,"New name for "+n.string,function(n){e.request(t,{type:"rename",newName:n,fullDocs:!0},function(n,r){if(n)return D(e,t,n);x(e,r.changes)})})}function E(e,t){var n=s(e,t.doc).name;e.request(t,{type:"refs"},function(r,i){if(r)return D(e,t,r);var s=[],o=0;for(var u=0;u<i.refs.length;u++){var a=i.refs[u];a.file==n&&(s.push({anchor:a.start,head:a.end}),C(o,a.start)>=0&&C(o,a.end)<=0&&(o=s.length-1))}t.setSelections(s,o)})}function x(e,t){var n=Object.create(null);for(var r=0;r<t.length;++r){var i=t[r];(n[i.file]||(n[i.file]=[])).push(i)}for(var s in n){var o=e.docs[s],u=n[s];if(!o)continue;u.sort(function(e,t){return C(t.start,e.start)});var a="*rename"+ ++S;for(var r=0;r<u.length;++r){var i=u[r];o.doc.replaceRange(i.text,i.start,i.end,a)}}}function T(e,n,i,s){var o=[],u=0,a=!i.fullDocs;a||delete i.fullDocs,typeof i=="string"&&(i={type:i}),i.lineCharPositions=!0,i.end==null&&(i.end=s||n.doc.getCursor("end"),n.doc.somethingSelected()&&(i.start=n.doc.getCursor("start")));var f=i.start||i.end;if(n.changed)if(n.doc.lineCount()>r&&a!==!1&&n.changed.to-n.changed.from<100&&n.changed.from<=f.line&&n.changed.to>i.end.line){o.push(N(n,f,i.end)),i.file="#0";var u=o[0].offsetLines;i.start!=null&&(i.start=t(i.start.line- -u,i.start.ch)),i.end=t(i.end.line-u,i.end.ch)}else o.push({type:"full",name:n.name,text:H(e,n)}),i.file=n.name,n.changed=null;else i.file=n.name;for(var l in e.docs){var c=e.docs[l];c.changed&&c!=n&&(o.push({type:"full",name:c.name,text:H(e,c)}),c.changed=null)}return{query:i,files:o}}function N(n,r,i){var s=n.doc,o=null,u=null,a,f=4;for(var l=r.line-1,c=Math.max(0,l-50);l>=c;--l){var h=s.getLine(l),p=h.search(/\bfunction\b/);if(p<0)continue;var d=e.countColumn(h,null,f);if(o!=null&&o<=d)continue;o=d,u=l}u==null&&(u=c);var v=Math.min(s.lastLine(),i.line+20);if(o==null||o==e.countColumn(s.getLine(r.line),null,f))a=v;else for(a=i.line+1;a<v;++a){var d=e.countColumn(s.getLine(a),null,f);if(d<=o)break}var m=t(u,0);return{type:"part",name:n.name,offsetLines:m.line,text:s.getRange(m,t(a,0))}}function k(e,t){var n=document.createElement(e);t&&(n.className=t);for(var r=2;r<arguments.length;++r){var i=arguments[r];typeof i=="string"&&(i=document.createTextNode(i)),n.appendChild(i)}return n}function L(e,t,n){e.openDialog?e.openDialog(t+": <input type=text>",n):n(prompt(t,""))}function A(e,t){function i(){if(!r.parentNode)return;e.off("cursorActivity",i),_(r)}var n=e.cursorCoords(),r=O(n.right+1,n.bottom,t);setTimeout(i,1700),e.on("cursorActivity",i)}function O(e,t,r){var i=k("div",n+"tooltip",r);return i.style.left=e+"px",i.style.top=t+"px",document.body.appendChild(i),i}function M(e){var t=e&&e.parentNode;t&&t.removeChild(e)}function _(e){e.style.opacity="0",setTimeout(function(){M(e)},1100)}function D(e,t,n){e.options.showError?e.options.showError(t,n):A(t,String(n))}function P(e){e.activeArgHints&&(M(e.activeArgHints),e.activeArgHints=null)}function H(e,t){var n=t.doc.getValue();return e.options.fileFilter&&(n=e.options.fileFilter(n,t.name,t.doc)),n}function B(e){function s(e,i){i&&(e.id=++n,r[n]=i),t.postMessage(e)}var t=new Worker(e.options.workerScript);t.postMessage({type:"init",defs:e.options.defs,plugins:e.options.plugins,scripts:e.options.workerDeps});var n=0,r={};t.onmessage=function(t){var n=t.data;n.type=="getFile"?i(e,n.name,function(e,t){s({type:"getFile",err:String(e),text:t,id:n.id})}):n.type=="debug"?window.console.log(n.message):n.id&&r[n.id]&&(r[n.id](n.err,n.body),delete r[n.id])},t.onerror=function(e){for(var t in r)r[t](e);r={}},this.addFile=function(e,t){s({type:"add",name:e,text:t})},this.delFile=function(e){s({type:"del",name:e})},this.request=function(e,t){s({type:"req",body:e},t)}}e.TernServer=function(e){var t=this;this.options=e||{};var n=this.options.plugins||(this.options.plugins={});n.doc_comment||(n.doc_comment=!0),this.options.useWorker?this.server=new B(this):this.server=new tern.Server({getFile:function(e,n){return i(t,e,n)},async:!0,defs:this.options.defs||[],plugins:n}),this.docs=Object.create(null),this.trackChange=function(e,n){u(t,e,n)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[],this.getHint=function(e,n){return f(t,e,n)},this.getHint.async=!0},e.TernServer.prototype={addDoc:function(t,n){var r={doc:n,name:t,changed:null};return this.server.addFile(t,H(this,r)),e.on(n,"change",this.trackChange),this.docs[t]=r},delDoc:function(t){var n=o(this,t);if(!n)return;e.off(n.doc,"change",this.trackChange),delete this.docs[n.name],this.server.delFile(n.name)},hideDoc:function(e){P(this);var t=o(this,e);t&&t.changed&&a(this,t)},complete:function(e){e.showHint({hint:this.getHint})},showType:function(e,t,n){c(this,e,t,"type",n)},showDocs:function(e,t,n){c(this,e,t,"documentation",n)},updateArgHints:function(e){h(this,e)},jumpToDef:function(e){v(this,e)},jumpBack:function(e){m(this,e)},rename:function(e){w(this,e)},selectName:function(e){E(this,e)},request:function(e,t,n,r){var i=this,o=s(this,e.getDoc()),u=T(this,o,t,r);this.server.request(u,function(e,r){!e&&i.options.responseFilter&&(r=i.options.responseFilter(o,t,u,e,r)),n(e,r)})}};var t=e.Pos,n="CodeMirror-Tern-",r=250,S=0,C=e.cmpPos});