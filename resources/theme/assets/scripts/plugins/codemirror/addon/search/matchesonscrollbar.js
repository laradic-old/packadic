(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror"),require("./searchcursor"),require("../scroll/annotatescrollbar")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","./searchcursor","../scroll/annotatescrollbar"],e):e(CodeMirror)})(function(e){function t(e,t,n,r){this.cm=e,this.annotation=e.annotateScrollbar(r||"CodeMirror-search-match"),this.query=t,this.caseFold=n,this.gap={from:e.firstLine(),to:e.lastLine()+1},this.matches=[],this.update=null,this.findMatches(),this.annotation.update(this.matches);var i=this;e.on("change",this.changeHandler=function(e,t){i.onChange(t)})}function r(e,t,n){return e<=t?e:Math.max(t,e+n)}e.defineExtension("showMatchesOnScrollbar",function(e,n,r){return new t(this,e,n,r)});var n=1e3;t.prototype.findMatches=function(){if(!this.gap)return;for(var t=0;t<this.matches.length;t++){var r=this.matches[t];if(r.from.line>=this.gap.to)break;r.to.line>=this.gap.from&&this.matches.splice(t--,1)}var i=this.cm.getSearchCursor(this.query,e.Pos(this.gap.from,0),this.caseFold);while(i.findNext()){var r={from:i.from(),to:i.to()};if(r.from.line>=this.gap.to)break;this.matches.splice(t++,0,r);if(this.matches.length>n)break}this.gap=null},t.prototype.onChange=function(t){var n=t.from.line,i=e.changeEnd(t).line,s=i-t.to.line;this.gap?(this.gap.from=Math.min(r(this.gap.from,n,s),t.from.line),this.gap.to=Math.max(r(this.gap.to,n,s),t.from.line)):this.gap={from:t.from.line,to:i+1};if(s)for(var o=0;o<this.matches.length;o++){var u=this.matches[o],a=r(u.from.line,n,s);a!=u.from.line&&(u.from=e.Pos(a,u.from.ch));var f=r(u.to.line,n,s);f!=u.to.line&&(u.to=e.Pos(f,u.to.ch))}clearTimeout(this.update);var l=this;this.update=setTimeout(function(){l.updateAfterChange()},250)},t.prototype.updateAfterChange=function(){this.findMatches(),this.annotation.update(this.matches)},t.prototype.clear=function(){this.cm.off("change",this.changeHandler),this.annotation.clear()}});