(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):typeof define=="function"&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],e):e(CodeMirror)})(function(e){function o(t,n,i){if(i<0&&n.ch==0)return t.clipPos(r(n.line-1));var s=t.getLine(n.line);if(i>0&&n.ch>=s.length)return t.clipPos(r(n.line+1,0));var o="start",u;for(var a=n.ch,f=i<0?0:s.length,l=0;a!=f;a+=i,l++){var c=s.charAt(i<0?a-1:a),h=c!="_"&&e.isWordChar(c)?"w":"o";h=="w"&&c.toUpperCase()==c&&(h="W");if(o=="start")h!="o"&&(o="in",u=h);else if(o=="in"&&u!=h){u=="w"&&h=="W"&&i<0&&a--;if(u=="W"&&h=="w"&&i>0){u="w";continue}break}}return r(n.line,a)}function u(e,t){e.extendSelectionsBy(function(n){return e.display.shift||e.doc.extend||n.empty()?o(e.doc,n.head,t):t<0?n.from():n.to()})}function a(e,t){e.operation(function(){var n=e.listSelections().length,i=[],s=-1;for(var o=0;o<n;o++){var u=e.listSelections()[o].head;if(u.line<=s)continue;var a=r(u.line+(t?0:1),0);e.replaceRange("\n",a,null,"+insertLine"),e.indentLine(a.line,null,!0),i.push({head:a,anchor:a}),s=u.line+1}e.setSelections(i)})}function f(t,n){var i=n.ch,s=i,o=t.getLine(n.line);while(i&&e.isWordChar(o.charAt(i-1)))--i;while(s<o.length&&e.isWordChar(o.charAt(s)))++s;return{from:r(n.line,i),to:r(n.line,s),word:o.slice(i,s)}}function c(e){var t=e.getCursor(),n=e.scanForBracket(t,-1);if(!n)return;for(;;){var i=e.scanForBracket(t,1);if(!i)return;if(i.ch==l.charAt(l.indexOf(n.ch)+1))return e.setSelection(r(n.pos.line,n.pos.ch+1),i.pos,!1),!0;t=r(i.pos.line,i.pos.ch+1)}}function p(e,t){var n=e.listSelections(),i=[],s;for(var o=0;o<n.length;o++){var u=n[o];if(u.empty())continue;var a=u.from().line,f=u.to().line;while(o<n.length-1&&n[o+1].from().line==f)f=u[++o].to().line;i.push(a,f)}i.length?s=!0:i.push(e.firstLine(),e.lastLine()),e.operation(function(){var n=[];for(var o=0;o<i.length;o+=2){var u=i[o],a=i[o+1],f=r(u,0),l=r(a),c=e.getRange(f,l,!1);t?c.sort():c.sort(function(e,t){var n=e.toUpperCase(),r=t.toUpperCase();return n!=r&&(e=n,t=r),e<t?-1:e==t?0:1}),e.replaceRange(c,f,l),s&&n.push({anchor:f,head:l})}s&&e.setSelections(n,0)})}function v(t,n){t.operation(function(){var r=t.listSelections(),i=[],s=[];for(var o=0;o<r.length;o++){var u=r[o];u.empty()?(i.push(o),s.push("")):s.push(n(t.getRange(u.from(),u.to())))}t.replaceSelections(s,"around","case");for(var o=i.length-1,a;o>=0;o--){var u=r[i[o]];if(a&&e.cmpPos(u.head,a)>0)continue;var l=f(t,u.head);a=l.from,t.replaceRange(n(l.word),l.from,l.to)}})}function m(t){var n=t.getCursor("from"),r=t.getCursor("to");if(e.cmpPos(n,r)==0){var i=f(t,n);if(!i.word)return;n=i.from,r=i.to}return{from:n,to:r,query:t.getRange(n,r),word:i}}function g(e,t){var n=m(e);if(!n)return;var i=n.query,s=e.getSearchCursor(i,t?n.to:n.from);(t?s.findNext():s.findPrevious())?e.setSelection(s.from(),s.to()):(s=e.getSearchCursor(i,t?r(e.firstLine(),0):e.clipPos(r(e.lastLine()))),(t?s.findNext():s.findPrevious())?e.setSelection(s.from(),s.to()):n.word&&e.setSelection(n.from,n.to))}var t=e.keyMap.sublime={fallthrough:"default"},n=e.commands,r=e.Pos,i=e.keyMap["default"]==e.keyMap.macDefault,s=i?"Cmd-":"Ctrl-";n[t["Alt-Left"]="goSubwordLeft"]=function(e){u(e,-1)},n[t["Alt-Right"]="goSubwordRight"]=function(e){u(e,1)},n[t[s+"Up"]="scrollLineUp"]=function(e){var t=e.getScrollInfo();if(!e.somethingSelected()){var n=e.lineAtHeight(t.top+t.clientHeight,"local");e.getCursor().line>=n&&e.execCommand("goLineUp")}e.scrollTo(null,t.top-e.defaultTextHeight())},n[t[s+"Down"]="scrollLineDown"]=function(e){var t=e.getScrollInfo();if(!e.somethingSelected()){var n=e.lineAtHeight(t.top,"local")+1;e.getCursor().line<=n&&e.execCommand("goLineDown")}e.scrollTo(null,t.top+e.defaultTextHeight())},n[t["Shift-"+s+"L"]="splitSelectionByLine"]=function(e){var t=e.listSelections(),n=[];for(var i=0;i<t.length;i++){var s=t[i].from(),o=t[i].to();for(var u=s.line;u<=o.line;++u)o.line>s.line&&u==o.line&&o.ch==0||n.push({anchor:u==s.line?s:r(u,0),head:u==o.line?o:r(u)})}e.setSelections(n,0)},t["Shift-Tab"]="indentLess",n[t.Esc="singleSelectionTop"]=function(e){var t=e.listSelections()[0];e.setSelection(t.anchor,t.head,{scroll:!1})},n[t[s+"L"]="selectLine"]=function(e){var t=e.listSelections(),n=[];for(var i=0;i<t.length;i++){var s=t[i];n.push({anchor:r(s.from().line,0),head:r(s.to().line+1,0)})}e.setSelections(n)},t["Shift-"+s+"K"]="deleteLine",n[t[s+"Enter"]="insertLineAfter"]=function(e){a(e,!1)},n[t["Shift-"+s+"Enter"]="insertLineBefore"]=function(e){a(e,!0)},n[t[s+"D"]="selectNextOccurrence"]=function(t){var n=t.getCursor("from"),i=t.getCursor("to"),s=t.state.sublimeFindFullWord==t.doc.sel;if(e.cmpPos(n,i)==0){var o=f(t,n);if(!o.word)return;t.setSelection(o.from,o.to),s=!0}else{var u=t.getRange(n,i),a=s?new RegExp("\\b"+u+"\\b"):u,l=t.getSearchCursor(a,i);l.findNext()?t.addSelection(l.from(),l.to()):(l=t.getSearchCursor(a,r(t.firstLine(),0)),l.findNext()&&t.addSelection(l.from(),l.to()))}s&&(t.state.sublimeFindFullWord=t.doc.sel)};var l="(){}[]";n[t["Shift-"+s+"Space"]="selectScope"]=function(e){c(e)||e.execCommand("selectAll")},n[t["Shift-"+s+"M"]="selectBetweenBrackets"]=function(t){if(!c(t))return e.Pass},n[t[s+"M"]="goToBracket"]=function(t){t.extendSelectionsBy(function(n){var i=t.scanForBracket(n.head,1);if(i&&e.cmpPos(i.pos,n.head)!=0)return i.pos;var s=t.scanForBracket(n.head,-1);return s&&r(s.pos.line,s.pos.ch+1)||n.head})};var h=i?"Cmd-Ctrl-":"Shift-Ctrl-";n[t[h+"Up"]="swapLineUp"]=function(e){var t=e.listSelections(),n=[],i=e.firstLine()-1,s=[];for(var o=0;o<t.length;o++){var u=t[o],a=u.from().line-1,f=u.to().line;s.push({anchor:r(u.anchor.line-1,u.anchor.ch),head:r(u.head.line-1,u.head.ch)}),u.to().ch==0&&!u.empty()&&--f,a>i?n.push(a,f):n.length&&(n[n.length-1]=f),i=f}e.operation(function(){for(var t=0;t<n.length;t+=2){var i=n[t],o=n[t+1],u=e.getLine(i);e.replaceRange("",r(i,0),r(i+1,0),"+swapLine"),o>e.lastLine()?e.replaceRange("\n"+u,r(e.lastLine()),null,"+swapLine"):e.replaceRange(u+"\n",r(o,0),null,"+swapLine")}e.setSelections(s),e.scrollIntoView()})},n[t[h+"Down"]="swapLineDown"]=function(e){var t=e.listSelections(),n=[],i=e.lastLine()+1;for(var s=t.length-1;s>=0;s--){var o=t[s],u=o.to().line+1,a=o.from().line;o.to().ch==0&&!o.empty()&&u--,u<i?n.push(u,a):n.length&&(n[n.length-1]=a),i=a}e.operation(function(){for(var t=n.length-2;t>=0;t-=2){var i=n[t],s=n[t+1],o=e.getLine(i);i==e.lastLine()?e.replaceRange("",r(i-1),r(i),"+swapLine"):e.replaceRange("",r(i,0),r(i+1,0),"+swapLine"),e.replaceRange(o+"\n",r(s,0),null,"+swapLine")}e.scrollIntoView()})},t[s+"/"]="toggleComment",n[t[s+"J"]="joinLines"]=function(e){var t=e.listSelections(),n=[];for(var i=0;i<t.length;i++){var s=t[i],o=s.from(),u=o.line,a=s.to().line;while(i<t.length-1&&t[i+1].from().line==a)a=t[++i].to().line;n.push({start:u,end:a,anchor:!s.empty()&&o})}e.operation(function(){var t=0,i=[];for(var s=0;s<n.length;s++){var o=n[s],u=o.anchor&&r(o.anchor.line-t,o.anchor.ch),a;for(var f=o.start;f<=o.end;f++){var l=f-t;f==o.end&&(a=r(l,e.getLine(l).length+1)),l<e.lastLine()&&(e.replaceRange(" ",r(l),r(l+1,/^\s*/.exec(e.getLine(l+1))[0].length)),++t)}i.push({anchor:u||a,head:a})}e.setSelections(i,0)})},n[t["Shift-"+s+"D"]="duplicateLine"]=function(e){e.operation(function(){var t=e.listSelections().length;for(var n=0;n<t;n++){var i=e.listSelections()[n];i.empty()?e.replaceRange(e.getLine(i.head.line)+"\n",r(i.head.line,0)):e.replaceRange(e.getRange(i.from(),i.to()),i.from())}e.scrollIntoView()})},t[s+"T"]="transposeChars",n[t.F9="sortLines"]=function(e){p(e,!0)},n[t[s+"F9"]="sortLinesInsensitive"]=function(e){p(e,!1)},n[t.F2="nextBookmark"]=function(e){var t=e.state.sublimeBookmarks;if(t)while(t.length){var n=t.shift(),r=n.find();if(r)return t.push(n),e.setSelection(r.from,r.to)}},n[t["Shift-F2"]="prevBookmark"]=function(e){var t=e.state.sublimeBookmarks;if(t)while(t.length){t.unshift(t.pop());var n=t[t.length-1].find();if(!!n)return e.setSelection(n.from,n.to);t.pop()}},n[t[s+"F2"]="toggleBookmark"]=function(e){var t=e.listSelections(),n=e.state.sublimeBookmarks||(e.state.sublimeBookmarks=[]);for(var r=0;r<t.length;r++){var i=t[r].from(),s=t[r].to(),o=e.findMarks(i,s);for(var u=0;u<o.length;u++)if(o[u].sublimeBookmark){o[u].clear();for(var a=0;a<n.length;a++)n[a]==o[u]&&n.splice(a--,1);break}u==o.length&&n.push(e.markText(i,s,{sublimeBookmark:!0,clearWhenEmpty:!1}))}},n[t["Shift-"+s+"F2"]="clearBookmarks"]=function(e){var t=e.state.sublimeBookmarks;if(t)for(var n=0;n<t.length;n++)t[n].clear();t.length=0},n[t["Alt-F2"]="selectBookmarks"]=function(e){var t=e.state.sublimeBookmarks,n=[];if(t)for(var r=0;r<t.length;r++){var i=t[r].find();i?n.push({anchor:i.from,head:i.to}):t.splice(r--,0)}n.length&&e.setSelections(n,0)},t["Alt-Q"]="wrapLines";var d=s+"K ";t[d+s+"Backspace"]="delLineLeft",n[t[d+s+"K"]="delLineRight"]=function(e){e.operation(function(){var t=e.listSelections();for(var n=t.length-1;n>=0;n--)e.replaceRange("",t[n].anchor,r(t[n].to().line),"+delete");e.scrollIntoView()})},n[t[d+s+"U"]="upcaseAtCursor"]=function(e){v(e,function(e){return e.toUpperCase()})},n[t[d+s+"L"]="downcaseAtCursor"]=function(e){v(e,function(e){return e.toLowerCase()})},n[t[d+s+"Space"]="setSublimeMark"]=function(e){e.state.sublimeMark&&e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor())},n[t[d+s+"A"]="selectToSublimeMark"]=function(e){var t=e.state.sublimeMark&&e.state.sublimeMark.find();t&&e.setSelection(e.getCursor(),t)},n[t[d+s+"W"]="deleteToSublimeMark"]=function(t){var n=t.state.sublimeMark&&t.state.sublimeMark.find();if(n){var r=t.getCursor(),i=n;if(e.cmpPos(r,i)>0){var s=i;i=r,r=s}t.state.sublimeKilled=t.getRange(r,i),t.replaceRange("",r,i)}},n[t[d+s+"X"]="swapWithSublimeMark"]=function(e){var t=e.state.sublimeMark&&e.state.sublimeMark.find();t&&(e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor()),e.setCursor(t))},n[t[d+s+"Y"]="sublimeYank"]=function(e){e.state.sublimeKilled!=null&&e.replaceSelection(e.state.sublimeKilled,null,"paste")},t[d+s+"G"]="clearBookmarks",n[t[d+s+"C"]="showInCenter"]=function(e){var t=e.cursorCoords(null,"local");e.scrollTo(null,(t.top+t.bottom)/2-e.getScrollInfo().clientHeight/2)},n[t["Shift-Alt-Up"]="selectLinesUpward"]=function(e){e.operation(function(){var t=e.listSelections();for(var n=0;n<t.length;n++){var i=t[n];i.head.line>e.firstLine()&&e.addSelection(r(i.head.line-1,i.head.ch))}})},n[t["Shift-Alt-Down"]="selectLinesDownward"]=function(e){e.operation(function(){var t=e.listSelections();for(var n=0;n<t.length;n++){var i=t[n];i.head.line<e.lastLine()&&e.addSelection(r(i.head.line+1,i.head.ch))}})},n[t[s+"F3"]="findUnder"]=function(e){g(e,!0)},n[t["Shift-"+s+"F3"]="findUnderPrevious"]=function(e){g(e,!1)},n[t["Alt-F3"]="findAllUnder"]=function(e){var t=m(e);if(!t)return;var n=e.getSearchCursor(t.query),r=[],i=-1;while(n.findNext())r.push({anchor:n.from(),head:n.to()}),n.from().line<=t.from.line&&n.from().ch<=t.from.ch&&i++;e.setSelections(r,i)},t["Shift-"+s+"["]="fold",t["Shift-"+s+"]"]="unfold",t[d+s+"0"]=t[d+s+"j"]="unfoldAll",t[s+"I"]="findIncremental",t["Shift-"+s+"I"]="findIncrementalReverse",t[s+"H"]="replace",t.F3="findNext",t["Shift-F3"]="findPrev",e.normalizeKeyMap(t)});