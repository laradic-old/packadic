(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/dialog/dialog"),require("../addon/edit/matchbrackets.js")):typeof define=="function"&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/dialog/dialog","../addon/edit/matchbrackets"],e):e(CodeMirror)})(function(e){var t=[{keys:"<Left>",type:"keyToKey",toKeys:"h"},{keys:"<Right>",type:"keyToKey",toKeys:"l"},{keys:"<Up>",type:"keyToKey",toKeys:"k"},{keys:"<Down>",type:"keyToKey",toKeys:"j"},{keys:"<Space>",type:"keyToKey",toKeys:"l"},{keys:"<BS>",type:"keyToKey",toKeys:"h",context:"normal"},{keys:"<C-Space>",type:"keyToKey",toKeys:"W"},{keys:"<C-BS>",type:"keyToKey",toKeys:"B",context:"normal"},{keys:"<S-Space>",type:"keyToKey",toKeys:"w"},{keys:"<S-BS>",type:"keyToKey",toKeys:"b",context:"normal"},{keys:"<C-n>",type:"keyToKey",toKeys:"j"},{keys:"<C-p>",type:"keyToKey",toKeys:"k"},{keys:"<C-[>",type:"keyToKey",toKeys:"<Esc>"},{keys:"<C-c>",type:"keyToKey",toKeys:"<Esc>"},{keys:"<C-[>",type:"keyToKey",toKeys:"<Esc>",context:"insert"},{keys:"<C-c>",type:"keyToKey",toKeys:"<Esc>",context:"insert"},{keys:"s",type:"keyToKey",toKeys:"cl",context:"normal"},{keys:"s",type:"keyToKey",toKeys:"xi",context:"visual"},{keys:"S",type:"keyToKey",toKeys:"cc",context:"normal"},{keys:"S",type:"keyToKey",toKeys:"dcc",context:"visual"},{keys:"<Home>",type:"keyToKey",toKeys:"0"},{keys:"<End>",type:"keyToKey",toKeys:"$"},{keys:"<PageUp>",type:"keyToKey",toKeys:"<C-b>"},{keys:"<PageDown>",type:"keyToKey",toKeys:"<C-f>"},{keys:"<CR>",type:"keyToKey",toKeys:"j^",context:"normal"},{keys:"H",type:"motion",motion:"moveToTopLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:"M",type:"motion",motion:"moveToMiddleLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:"L",type:"motion",motion:"moveToBottomLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:"h",type:"motion",motion:"moveByCharacters",motionArgs:{forward:!1}},{keys:"l",type:"motion",motion:"moveByCharacters",motionArgs:{forward:!0}},{keys:"j",type:"motion",motion:"moveByLines",motionArgs:{forward:!0,linewise:!0}},{keys:"k",type:"motion",motion:"moveByLines",motionArgs:{forward:!1,linewise:!0}},{keys:"gj",type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:!0}},{keys:"gk",type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:!1}},{keys:"w",type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!1}},{keys:"W",type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!1,bigWord:!0}},{keys:"e",type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!0,inclusive:!0}},{keys:"E",type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!0,bigWord:!0,inclusive:!0}},{keys:"b",type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1}},{keys:"B",type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1,bigWord:!0}},{keys:"ge",type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!0,inclusive:!0}},{keys:"gE",type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!0,bigWord:!0,inclusive:!0}},{keys:"{",type:"motion",motion:"moveByParagraph",motionArgs:{forward:!1,toJumplist:!0}},{keys:"}",type:"motion",motion:"moveByParagraph",motionArgs:{forward:!0,toJumplist:!0}},{keys:"<C-f>",type:"motion",motion:"moveByPage",motionArgs:{forward:!0}},{keys:"<C-b>",type:"motion",motion:"moveByPage",motionArgs:{forward:!1}},{keys:"<C-d>",type:"motion",motion:"moveByScroll",motionArgs:{forward:!0,explicitRepeat:!0}},{keys:"<C-u>",type:"motion",motion:"moveByScroll",motionArgs:{forward:!1,explicitRepeat:!0}},{keys:"gg",type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!1,explicitRepeat:!0,linewise:!0,toJumplist:!0}},{keys:"G",type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!0,explicitRepeat:!0,linewise:!0,toJumplist:!0}},{keys:"0",type:"motion",motion:"moveToStartOfLine"},{keys:"^",type:"motion",motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:"+",type:"motion",motion:"moveByLines",motionArgs:{forward:!0,toFirstChar:!0}},{keys:"-",type:"motion",motion:"moveByLines",motionArgs:{forward:!1,toFirstChar:!0}},{keys:"_",type:"motion",motion:"moveByLines",motionArgs:{forward:!0,toFirstChar:!0,repeatOffset:-1}},{keys:"$",type:"motion",motion:"moveToEol",motionArgs:{inclusive:!0}},{keys:"%",type:"motion",motion:"moveToMatchedSymbol",motionArgs:{inclusive:!0,toJumplist:!0}},{keys:"f<character>",type:"motion",motion:"moveToCharacter",motionArgs:{forward:!0,inclusive:!0}},{keys:"F<character>",type:"motion",motion:"moveToCharacter",motionArgs:{forward:!1}},{keys:"t<character>",type:"motion",motion:"moveTillCharacter",motionArgs:{forward:!0,inclusive:!0}},{keys:"T<character>",type:"motion",motion:"moveTillCharacter",motionArgs:{forward:!1}},{keys:";",type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:!0}},{keys:",",type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:!1}},{keys:"'<character>",type:"motion",motion:"goToMark",motionArgs:{toJumplist:!0,linewise:!0}},{keys:"`<character>",type:"motion",motion:"goToMark",motionArgs:{toJumplist:!0}},{keys:"]`",type:"motion",motion:"jumpToMark",motionArgs:{forward:!0}},{keys:"[`",type:"motion",motion:"jumpToMark",motionArgs:{forward:!1}},{keys:"]'",type:"motion",motion:"jumpToMark",motionArgs:{forward:!0,linewise:!0}},{keys:"['",type:"motion",motion:"jumpToMark",motionArgs:{forward:!1,linewise:!0}},{keys:"]p",type:"action",action:"paste",isEdit:!0,actionArgs:{after:!0,isEdit:!0,matchIndent:!0}},{keys:"[p",type:"action",action:"paste",isEdit:!0,actionArgs:{after:!1,isEdit:!0,matchIndent:!0}},{keys:"]<character>",type:"motion",motion:"moveToSymbol",motionArgs:{forward:!0,toJumplist:!0}},{keys:"[<character>",type:"motion",motion:"moveToSymbol",motionArgs:{forward:!1,toJumplist:!0}},{keys:"|",type:"motion",motion:"moveToColumn"},{keys:"o",type:"motion",motion:"moveToOtherHighlightedEnd",context:"visual"},{keys:"O",type:"motion",motion:"moveToOtherHighlightedEnd",motionArgs:{sameLine:!0},context:"visual"},{keys:"d",type:"operator",operator:"delete"},{keys:"y",type:"operator",operator:"yank"},{keys:"c",type:"operator",operator:"change"},{keys:">",type:"operator",operator:"indent",operatorArgs:{indentRight:!0}},{keys:"<",type:"operator",operator:"indent",operatorArgs:{indentRight:!1}},{keys:"g~",type:"operator",operator:"changeCase"},{keys:"gu",type:"operator",operator:"changeCase",operatorArgs:{toLower:!0},isEdit:!0},{keys:"gU",type:"operator",operator:"changeCase",operatorArgs:{toLower:!1},isEdit:!0},{keys:"n",type:"motion",motion:"findNext",motionArgs:{forward:!0,toJumplist:!0}},{keys:"N",type:"motion",motion:"findNext",motionArgs:{forward:!1,toJumplist:!0}},{keys:"x",type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:!0},operatorMotionArgs:{visualLine:!1}},{keys:"X",type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:!1},operatorMotionArgs:{visualLine:!0}},{keys:"D",type:"operatorMotion",operator:"delete",motion:"moveToEol",motionArgs:{inclusive:!0},context:"normal"},{keys:"D",type:"operator",operator:"delete",operatorArgs:{linewise:!0},context:"visual"},{keys:"Y",type:"operatorMotion",operator:"yank",motion:"moveToEol",motionArgs:{inclusive:!0},context:"normal"},{keys:"Y",type:"operator",operator:"yank",operatorArgs:{linewise:!0},context:"visual"},{keys:"C",type:"operatorMotion",operator:"change",motion:"moveToEol",motionArgs:{inclusive:!0},context:"normal"},{keys:"C",type:"operator",operator:"change",operatorArgs:{linewise:!0},context:"visual"},{keys:"~",type:"operatorMotion",operator:"changeCase",motion:"moveByCharacters",motionArgs:{forward:!0},operatorArgs:{shouldMoveCursor:!0},context:"normal"},{keys:"~",type:"operator",operator:"changeCase",context:"visual"},{keys:"<C-w>",type:"operatorMotion",operator:"delete",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1},context:"insert"},{keys:"<C-i>",type:"action",action:"jumpListWalk",actionArgs:{forward:!0}},{keys:"<C-o>",type:"action",action:"jumpListWalk",actionArgs:{forward:!1}},{keys:"<C-e>",type:"action",action:"scroll",actionArgs:{forward:!0,linewise:!0}},{keys:"<C-y>",type:"action",action:"scroll",actionArgs:{forward:!1,linewise:!0}},{keys:"a",type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"charAfter"},context:"normal"},{keys:"A",type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"eol"},context:"normal"},{keys:"A",type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"endOfSelectedArea"},context:"visual"},{keys:"i",type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"inplace"},context:"normal"},{keys:"I",type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"firstNonBlank"},context:"normal"},{keys:"I",type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"startOfSelectedArea"},context:"visual"},{keys:"o",type:"action",action:"newLineAndEnterInsertMode",isEdit:!0,interlaceInsertRepeat:!0,actionArgs:{after:!0},context:"normal"},{keys:"O",type:"action",action:"newLineAndEnterInsertMode",isEdit:!0,interlaceInsertRepeat:!0,actionArgs:{after:!1},context:"normal"},{keys:"v",type:"action",action:"toggleVisualMode"},{keys:"V",type:"action",action:"toggleVisualMode",actionArgs:{linewise:!0}},{keys:"<C-v>",type:"action",action:"toggleVisualMode",actionArgs:{blockwise:!0}},{keys:"gv",type:"action",action:"reselectLastSelection"},{keys:"J",type:"action",action:"joinLines",isEdit:!0},{keys:"p",type:"action",action:"paste",isEdit:!0,actionArgs:{after:!0,isEdit:!0}},{keys:"P",type:"action",action:"paste",isEdit:!0,actionArgs:{after:!1,isEdit:!0}},{keys:"r<character>",type:"action",action:"replace",isEdit:!0},{keys:"@<character>",type:"action",action:"replayMacro"},{keys:"q<character>",type:"action",action:"enterMacroRecordMode"},{keys:"R",type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{replace:!0}},{keys:"u",type:"action",action:"undo",context:"normal"},{keys:"u",type:"operator",operator:"changeCase",operatorArgs:{toLower:!0},context:"visual",isEdit:!0},{keys:"U",type:"operator",operator:"changeCase",operatorArgs:{toLower:!1},context:"visual",isEdit:!0},{keys:"<C-r>",type:"action",action:"redo"},{keys:"m<character>",type:"action",action:"setMark"},{keys:'"<character>',type:"action",action:"setRegister"},{keys:"zz",type:"action",action:"scrollToCursor",actionArgs:{position:"center"}},{keys:"z.",type:"action",action:"scrollToCursor",actionArgs:{position:"center"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:"zt",type:"action",action:"scrollToCursor",actionArgs:{position:"top"}},{keys:"z<CR>",type:"action",action:"scrollToCursor",actionArgs:{position:"top"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:"z-",type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"}},{keys:"zb",type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:".",type:"action",action:"repeatLastEdit"},{keys:"<C-a>",type:"action",action:"incrementNumberToken",isEdit:!0,actionArgs:{increase:!0,backtrack:!1}},{keys:"<C-x>",type:"action",action:"incrementNumberToken",isEdit:!0,actionArgs:{increase:!1,backtrack:!1}},{keys:"a<character>",type:"motion",motion:"textObjectManipulation"},{keys:"i<character>",type:"motion",motion:"textObjectManipulation",motionArgs:{textObjectInner:!0}},{keys:"/",type:"search",searchArgs:{forward:!0,querySrc:"prompt",toJumplist:!0}},{keys:"?",type:"search",searchArgs:{forward:!1,querySrc:"prompt",toJumplist:!0}},{keys:"*",type:"search",searchArgs:{forward:!0,querySrc:"wordUnderCursor",wholeWordOnly:!0,toJumplist:!0}},{keys:"#",type:"search",searchArgs:{forward:!1,querySrc:"wordUnderCursor",wholeWordOnly:!0,toJumplist:!0}},{keys:"g*",type:"search",searchArgs:{forward:!0,querySrc:"wordUnderCursor",toJumplist:!0}},{keys:"g#",type:"search",searchArgs:{forward:!1,querySrc:"wordUnderCursor",toJumplist:!0}},{keys:":",type:"ex"}],n=e.Pos,r=function(){function r(t){t.setOption("disableInput",!0),t.setOption("showCursorWhenSelecting",!1),e.signal(t,"vim-mode-change",{mode:"normal"}),t.on("cursorActivity",Sn),H(t),e.on(t.getInputField(),"paste",c(t))}function i(t){t.setOption("disableInput",!1),t.off("cursorActivity",Sn),e.off(t.getInputField(),"paste",c(t)),t.state.vim=null}function s(t,n){this==e.keyMap.vim&&e.rmClass(t.getWrapperElement(),"cm-fat-cursor"),(!n||n.attach!=o)&&i(t,!1)}function o(t,n){this==e.keyMap.vim&&e.addClass(t.getWrapperElement(),"cm-fat-cursor"),(!n||n.attach!=o)&&r(t)}function u(t,n){if(!n)return undefined;var r=l(t);if(!r)return!1;var i=e.Vim.findKey(n,r);return typeof i=="function"&&e.signal(n,"vim-keypress",r),i}function l(e){if(e.charAt(0)=="'")return e.charAt(1);var t=e.split("-");/-$/.test(e)&&t.splice(-2,2,"-");var n=t[t.length-1];if(t.length==1&&t[0].length==1)return!1;if(t.length==2&&t[0]=="Shift"&&n.length==1)return!1;var r=!1;for(var i=0;i<t.length;i++){var s=t[i];s in a?t[i]=a[s]:r=!0,s in f&&(t[i]=f[s])}return r?(N(n)&&(t[t.length-1]=n.toLowerCase()),"<"+t.join("-")+">"):!1}function c(e){var t=e.state.vim;return t.onPasteFn||(t.onPasteFn=function(){t.insertMode||(e.setCursor(Y(e.getCursor(),0,1)),K.enterInsertMode(e,{},t))}),t.onPasteFn}function v(e,t){var n=[];for(var r=e;r<e+t;r++)n.push(String.fromCharCode(r));return n}function E(e,t){return t>=e.firstLine()&&t<=e.lastLine()}function S(e){return/^[a-z]$/.test(e)}function x(e){return"()[]{}".indexOf(e)!=-1}function T(e){return h.test(e)}function N(e){return/^[A-Z]$/.test(e)}function C(e){return/^\s*$/.test(e)}function k(e,t){for(var n=0;n<t.length;n++)if(t[n]==e)return!0;return!1}function A(e,t,n){if(t===undefined)throw Error("defaultValue is required");n||(n="string"),L[e]={type:n,defaultValue:t},O(e,t)}function O(e,t){var n=L[e];if(!n)throw Error("Unknown option: "+e);if(n.type=="boolean"){if(t&&t!==!0)throw Error("Invalid argument: "+e+"="+t);t!==!1&&(t=!0)}n.value=n.type=="boolean"?!!t:t}function M(e){var t=L[e];if(!t)throw Error("Unknown option: "+e);return t.value}function P(){this.latestRegister=undefined,this.isPlaying=!1,this.isRecording=!1,this.replaySearchQueries=[],this.onRecordingDone=undefined,this.lastInsertModeChanges=D()}function H(e){return e.state.vim||(e.state.vim={inputState:new q,lastEditInputState:undefined,lastEditActionCommand:undefined,lastHPos:-1,lastHSPos:-1,lastMotion:null,marks:{},fakeCursor:null,insertMode:!1,insertModeRepeat:undefined,visualMode:!1,visualLine:!1,visualBlock:!1,lastSelection:null,lastPastedText:null,sel:{}}),e.state.vim}function j(){B={searchQuery:null,searchIsReversed:!1,lastSubstituteReplacePart:undefined,jumpList:_(),macroModeState:new P,lastChararacterSearch:{increment:0,forward:!0,selectedCharacter:""},registerController:new z({}),searchHistoryController:new W({}),exCommandHistoryController:new W({})};for(var e in L){var t=L[e];t.value=t.defaultValue}}function q(){this.prefixRepeat=[],this.motionRepeat=[],this.operator=null,this.operatorArgs=null,this.motion=null,this.motionArgs=null,this.keyBuffer=[],this.registerName=null}function R(t,n){t.state.vim.inputState=new q,e.signal(t,"vim-command-done",n)}function U(e,t,n){this.clear(),this.keyBuffer=[e||""],this.insertModeChanges=[],this.searchQueries=[],this.linewise=!!t,this.blockwise=!!n}function z(e){this.registers=e,this.unnamedRegister=e['"']=new U,e["."]=new U,e[":"]=new U,e["/"]=new U}function W(){this.historyBuffer=[],this.iterator,this.initialPrefix=null}function $(e,t){var n=[];for(var r=0;r<t;r++)n.push(e);return n}function Q(e,t,r){var i=Math.min(Math.max(e.firstLine(),t.line),e.lastLine()),s=lt(e,i)-1;s=r?s+1:s;var o=Math.min(Math.max(0,t.ch),s);return n(i,o)}function G(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function Y(e,t,r){return typeof t=="object"&&(r=t.ch,t=t.line),n(e.line+t,e.ch+r)}function Z(e,t){return{line:t.line-e.line,ch:t.line-e.line}}function et(e,t,n,r){var i,s=[],o=[];for(var u=0;u<t.length;u++){var a=t[u];if(n=="insert"&&a.context!="insert"||a.context&&a.context!=n||r.operator&&a.type=="action"||!(i=tt(e,a.keys)))continue;i=="partial"&&s.push(a),i=="full"&&o.push(a)}return{partial:s.length&&s,full:o.length&&o}}function tt(e,t){if(t.slice(-11)=="<character>"){var n=t.length-11,r=e.slice(0,n),i=t.slice(0,n);return r==i&&e.length>n?"full":i.indexOf(r)==0?"partial":!1}return e==t?"full":t.indexOf(e)==0?"partial":!1}function nt(e){var t=/^.*(<[\w\-]+>)$/.exec(e),n=t?t[1]:e.slice(-1);if(n.length>1)switch(n){case"<CR>":n="\n";break;case"<Space>":n=" ";break;default:}return n}function rt(e,t,n){return function(){for(var r=0;r<n;r++)t(e)}}function it(e){return n(e.line,e.ch)}function st(e,t){return e.ch==t.ch&&e.line==t.line}function ot(e,t){return e.line<t.line?!0:e.line==t.line&&e.ch<t.ch?!0:!1}function ut(e,t){return arguments.length>2&&(t=ut.apply(undefined,Array.prototype.slice.call(arguments,1))),ot(e,t)?e:t}function at(e,t){return arguments.length>2&&(t=at.apply(undefined,Array.prototype.slice.call(arguments,1))),ot(e,t)?t:e}function ft(e,t,n){var r=ot(e,t),i=ot(t,n);return r&&i}function lt(e,t){return e.getLine(t).length}function ct(e){return e.split("").reverse().join("")}function ht(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function pt(e){return e.replace(/([.?*+$\[\]\/\\(){}|\-])/g,"\\$1")}function dt(e,t,r){var i=lt(e,t),s=(new Array(r-i+1)).join(" ");e.setCursor(n(t,i)),e.replaceRange(s,e.getCursor())}function vt(e,t){var r=[],i=e.listSelections(),s=it(e.clipPos(t)),o=!st(t,s),u=e.getCursor("head"),a=gt(i,u),f=st(i[a].head,i[a].anchor),l=i.length-1,c=l-a>a?l:0,h=i[c].anchor,p=Math.min(h.line,s.line),d=Math.max(h.line,s.line),v=h.ch,m=s.ch,g=i[c].head.ch-v,y=m-v;g>0&&y<=0?(v++,o||m--):g<0&&y>=0?(v--,f||m++):g<0&&y==-1&&(v--,m++);for(var b=p;b<=d;b++){var w={anchor:new n(b,v),head:new n(b,m)};r.push(w)}return a=s.line==d?r.length-1:0,e.setSelections(r),t.ch=m,h.ch=v,h}function mt(e,t,n){var r=[];for(var i=0;i<n;i++){var s=Y(t,i,0);r.push({anchor:s,head:s})}e.setSelections(r,0)}function gt(e,t,n){for(var r=0;r<e.length;r++){var i=n!="head"&&st(e[r].anchor,t),s=n!="anchor"&&st(e[r].head,t);if(i||s)return r}return-1}function yt(e,t){var r=t.lastSelection,i=function(){var t=e.listSelections(),n=t[0],r=t[t.length-1],i=ot(n.anchor,n.head)?n.anchor:n.head,s=ot(r.anchor,r.head)?r.head:r.anchor;return[i,s]},s=function(){var t=e.getCursor(),i=e.getCursor(),s=r.visualBlock;if(s){var o=s.width,u=s.height;i=n(t.line+u,t.ch+o);var a=[];for(var f=t.line;f<i.line;f++){var l=n(f,t.ch),c=n(f,i.ch),h={anchor:l,head:c};a.push(h)}e.setSelections(a)}else{var p=r.anchorMark.find(),d=r.headMark.find(),v=d.line-p.line,m=d.ch-p.ch;i={line:i.line+v,ch:v?i.ch:m+i.ch},r.visualLine&&(t=n(t.line,0),i=n(i.line,lt(e,i.line))),e.setSelection(t,i)}return[t,i]};return t.visualMode?i():s()}function bt(e,t){var n=t.sel.anchor,r=t.sel.head;t.lastPastedText&&(r=e.posFromIndex(e.indexFromPos(n)+t.lastPastedText.length),t.lastPastedText=null),t.lastSelection={anchorMark:e.setBookmark(n),headMark:e.setBookmark(r),anchor:it(n),head:it(r),visualMode:t.visualMode,visualLine:t.visualLine,visualBlock:t.visualBlock}}function wt(e,t,r){var i=e.state.vim.sel,s=i.head,o=i.anchor,u;return ot(r,t)&&(u=r,r=t,t=u),ot(s,o)?(s=ut(t,s),o=at(o,r)):(o=ut(t,o),s=at(s,r),s=Y(s,0,-1),s.ch==-1&&s.line!=e.firstLine()&&(s=n(s.line-1,lt(e,s.line-1)))),[o,s]}function Et(e,t,n){var r=e.state.vim;t=t||r.sel;var n=n||r.visualLine?"line":r.visualBlock?"block":"char",i=St(e,t,n);e.setSelections(i.ranges,i.primary),xn(e)}function St(e,t,r,i){var s=it(t.head),o=it(t.anchor);if(r=="char"){var u=!i&&!ot(t.head,t.anchor)?1:0,a=ot(t.head,t.anchor)?1:0;return s=Y(t.head,0,u),o=Y(t.anchor,0,a),{ranges:[{anchor:o,head:s}],primary:0}}if(r=="line"){if(!ot(t.head,t.anchor)){o.ch=0;var f=e.lastLine();s.line>f&&(s.line=f),s.ch=lt(e,s.line)}else s.ch=0,o.ch=lt(e,o.line);return{ranges:[{anchor:o,head:s}],primary:0}}if(r=="block"){var l=Math.min(o.line,s.line),c=Math.min(o.ch,s.ch),h=Math.max(o.line,s.line),p=Math.max(o.ch,s.ch)+1,d=h-l+1,v=s.line==l?0:d-1,m=[];for(var g=0;g<d;g++)m.push({anchor:n(l+g,c),head:n(l+g,p)});return{ranges:m,primary:v}}}function xt(e){var t=e.getCursor("head");return e.getSelection().length==1&&(t=ut(t,e.getCursor("anchor"))),t}function Tt(t,n){var r=t.state.vim;n!==!1&&t.setCursor(Q(t,r.sel.head)),bt(t,r),r.visualMode=!1,r.visualLine=!1,r.visualBlock=!1,e.signal(t,"vim-mode-change",{mode:"normal"}),r.fakeCursor&&r.fakeCursor.clear()}function Nt(e,t,n){var r=e.getRange(t,n);if(/\n\s*$/.test(r)){var i=r.split("\n");i.pop();var s;for(var s=i.pop();i.length>0&&s&&C(s);s=i.pop())n.line--,n.ch=0;s?(n.line--,n.ch=lt(e,n.line)):n.ch=0}}function Ct(e,t,n){t.ch=0,n.ch=0,n.line++}function kt(e){if(!e)return 0;var t=e.search(/\S/);return t==-1?e.length:t}function Lt(e,t,r,i,s){var o=xt(e),u=e.getLine(o.line),a=o.ch,f=u.substring(a),l;s?l=f.search(/\w/):l=f.search(/\S/);if(l==-1)return null;a+=l,f=u.substring(a);var c=u.substring(0,a),h;i?h=/^\S+/:/\w/.test(u.charAt(a))?h=/^\w+/:h=/^[^\w\s]+/;var p=h.exec(f),d=a,v=a+p[0].length,m=ct(c),g=h.exec(m);g&&(d-=g[0].length);if(t){var y=u.substring(v),b=y.match(/^\s*/)[0].length;if(b>0)v+=b;else{var w=m.length-d,E=m.substring(w),S=E.match(/^\s*/)[0].length;d-=S}}return{start:n(o.line,d),end:n(o.line,v)}}function At(e,t,n){st(t,n)||B.jumpList.add(e,t,n)}function Ot(e,t){B.lastChararacterSearch.increment=e,B.lastChararacterSearch.forward=t.forward,B.lastChararacterSearch.selectedCharacter=t.selectedCharacter}function Dt(e,t,r,i){var s=it(e.getCursor()),o=r?1:-1,u=r?e.lineCount():-1,a=s.ch,f=s.line,l=e.getLine(f),c={lineText:l,nextCh:l.charAt(a),lastCh:null,index:a,symb:i,reverseSymb:(r?{")":"(","}":"{"}:{"(":")","{":"}"})[i],forward:r,depth:0,curMoveThrough:!1},h=Mt[i];if(!h)return s;var p=_t[h].init,d=_t[h].isComplete;p&&p(c);while(f!==u&&t){c.index+=o,c.nextCh=c.lineText.charAt(c.index);if(!c.nextCh){f+=o,c.lineText=e.getLine(f)||"";if(o>0)c.index=0;else{var v=c.lineText.length;c.index=v>0?v-1:0}c.nextCh=c.lineText.charAt(c.index)}d(c)&&(s.line=f,s.ch=c.index,t--)}return c.nextCh||c.curMoveThrough?n(f,c.index):s}function Pt(e,t,n,r,i){var s=t.line,o=t.ch,u=e.getLine(s),a=n?1:-1,f=r?d:p;if(i&&u==""){s+=a,u=e.getLine(s);if(!E(e,s))return null;o=n?0:u.length}for(;;){if(i&&u=="")return{from:0,to:0,line:s};var l=a>0?u.length:-1,c=l,h=l;while(o!=l){var v=!1;for(var m=0;m<f.length&&!v;++m)if(f[m].test(u.charAt(o))){c=o;while(o!=l&&f[m].test(u.charAt(o)))o+=a;h=o,v=c!=h;if(c==t.ch&&s==t.line&&h==c+a)continue;return{from:Math.min(c,h+1),to:Math.max(c,h),line:s}}v||(o+=a)}s+=a;if(!E(e,s))return null;u=e.getLine(s),o=a>0?0:u.length}throw new Error("The impossible happened.")}function Ht(e,t,r,i,s,o){var u=it(t),a=[];(i&&!s||!i&&s)&&r++;var f=!i||!s;for(var l=0;l<r;l++){var c=Pt(e,t,i,o,f);if(!c){var h=lt(e,e.lastLine());a.push(i?{line:e.lastLine(),from:h,to:h}:{line:0,from:0,to:0});break}a.push(c),t=n(c.line,i?c.to-1:c.from)}var p=a.length!=r,d=a[0],v=a.pop();return i&&!s?(!p&&(d.from!=u.ch||d.line!=u.line)&&(v=a.pop()),n(v.line,v.from)):i&&s?n(v.line,v.to-1):!i&&s?(!p&&(d.to!=u.ch||d.line!=u.line)&&(v=a.pop()),n(v.line,v.to)):n(v.line,v.from)}function Bt(e,t,r,i){var s=e.getCursor(),o=s.ch,u;for(var a=0;a<t;a++){var f=e.getLine(s.line);u=It(o,f,i,r,!0);if(u==-1)return null;o=u}return n(e.getCursor().line,u)}function jt(e,t){var r=e.getCursor().line;return Q(e,n(r,t-1))}function Ft(e,t,n,r){if(!k(n,b))return;t.marks[n]&&t.marks[n].clear(),t.marks[n]=e.setBookmark(r)}function It(e,t,n,r,i){var s;return r?(s=t.indexOf(n,e+1),s!=-1&&!i&&(s-=1)):(s=t.lastIndexOf(n,e-1),s!=-1&&!i&&(s+=1)),s}function qt(e,t,r,i,s){function h(t){return!e.getLine(t)}function p(e,t,n){return n?h(e)!=h(e+t):!h(e)&&h(e+t)}var o=t.line,u=e.firstLine(),a=e.lastLine(),f,l,c=o;if(i){while(u<=c&&c<=a&&r>0)p(c,i)&&r--,c+=i;return new n(c,0)}var d=e.state.vim;if(d.visualLine&&p(o,1,!0)){var v=d.sel.anchor;p(v.line,-1,!0)&&(!s||v.line!=o)&&(o+=1)}var m=h(o);for(c=o;c<=a&&r;c++)p(c,1,!0)&&(!s||h(c)!=m)&&r--;l=new n(c,0),c>a&&!m?m=!0:s=!1;for(c=o;c>u;c--)if(!s||h(c)==m||c==o)if(p(c,-1,!0))break;return f=new n(c,0),{start:f,end:l}}function Rt(e,t,r,i){var s=t,o,u,a={"(":/[()]/,")":/[()]/,"[":/[[\]]/,"]":/[[\]]/,"{":/[{}]/,"}":/[{}]/}[r],f={"(":"(",")":"(","[":"[","]":"[","{":"{","}":"{"}[r],l=e.getLine(s.line).charAt(s.ch),c=l===f?1:0;o=e.scanForBracket(n(s.line,s.ch+c),-1,null,{bracketRegex:a}),u=e.scanForBracket(n(s.line,s.ch+c),1,null,{bracketRegex:a});if(!o||!u)return{start:s,end:s};o=o.pos,u=u.pos;if(o.line==u.line&&o.ch>u.ch||o.line>u.line){var h=o;o=u,u=h}return i?u.ch+=1:o.ch+=1,{start:o,end:u}}function Ut(e,t,r,i){var s=it(t),o=e.getLine(s.line),u=o.split(""),a,f,l,c,h=u.indexOf(r);s.ch<h?s.ch=h:h<s.ch&&u[s.ch]==r&&(f=s.ch,--s.ch);if(u[s.ch]==r&&!f)a=s.ch+1;else for(l=s.ch;l>-1&&!a;l--)u[l]==r&&(a=l+1);if(a&&!f)for(l=a,c=u.length;l<c&&!f;l++)u[l]==r&&(f=l);return!a||!f?{start:s,end:s}:(i&&(--a,++f),{start:n(s.line,a),end:n(s.line,f)})}function zt(){}function Wt(e){var t=e.state.vim;return t.searchState_||(t.searchState_=new zt)}function Xt(e,t,n,r,i){e.openDialog?e.openDialog(t,r,{bottom:!0,value:i.value,onKeyDown:i.onKeyDown,onKeyUp:i.onKeyUp}):r(prompt(n,""))}function Vt(e){var t=$t(e)||[];if(!t.length)return[];var n=[];if(t[0]!==0)return;for(var r=0;r<t.length;r++)typeof t[r]=="number"&&n.push(e.substring(t[r]+1,t[r+1]));return n}function $t(e){var t=!1,n=[];for(var r=0;r<e.length;r++){var i=e.charAt(r);!t&&i=="/"&&n.push(r),t=!t&&i=="\\"}return n}function Jt(e){var t="|(){",n="}",r=!1,i=[];for(var s=-1;s<e.length;s++){var o=e.charAt(s)||"",u=e.charAt(s+1)||"",a=u&&t.indexOf(u)!=-1;r?((o!=="\\"||!a)&&i.push(o),r=!1):o==="\\"?(r=!0,u&&n.indexOf(u)!=-1&&(a=!0),(!a||u==="\\")&&i.push(o)):(i.push(o),a&&u!=="\\"&&i.push("\\"))}return i.join("")}function Kt(e){var t=!1,n=[];for(var r=-1;r<e.length;r++){var i=e.charAt(r)||"",s=e.charAt(r+1)||"";t?(n.push(i),t=!1):i==="\\"?(t=!0,T(s)||s==="$"?n.push("$"):s!=="/"&&s!=="\\"&&n.push("\\")):(i==="$"&&n.push("$"),n.push(i),s==="/"&&n.push("\\"))}return n.join("")}function Qt(t){var n=new e.StringStream(t),r=[];while(!n.eol()){while(n.peek()&&n.peek()!="\\")r.push(n.next());n.match("\\/",!0)?r.push("/"):n.match("\\\\",!0)?r.push("\\"):r.push(n.next())}return r.join("")}function Gt(e,t,n){var r=B.registerController.getRegister("/");r.setText(e);if(e instanceof RegExp)return e;var i=$t(e),s,o;if(!i.length)s=e;else{s=e.substring(0,i[0]);var u=e.substring(i[0]);o=u.indexOf("i")!=-1}if(!s)return null;M("pcre")||(s=Jt(s)),n&&(t=/^[^A-Z]*$/.test(s));var a=new RegExp(s,t||o?"i":undefined);return a}function Yt(e,t){e.openNotification?e.openNotification('<span style="color: red">'+t+"</span>",{bottom:!0,duration:5e3}):alert(t)}function Zt(e,t){var n="";return e&&(n+='<span style="font-family: monospace">'+e+"</span>"),n+='<input type="text"/> <span style="color: #888">',t&&(n+='<span style="color: #888">',n+=t,n+="</span>"),n}function tn(e,t){var n=(t.prefix||"")+" "+(t.desc||""),r=Zt(t.prefix,t.desc);Xt(e,r,n,t.onClose,t)}function nn(e,t){if(e instanceof RegExp&&t instanceof RegExp){var n=["global","multiline","ignoreCase","source"];for(var r=0;r<n.length;r++){var i=n[r];if(e[i]!==t[i])return!1}return!0}return!1}function rn(e,t,n,r){if(!t)return;var i=Wt(e),s=Gt(t,!!n,!!r);if(!s)return;return on(e,s),nn(s,i.getQuery())?s:(i.setQuery(s),s)}function sn(e){if(e.source.charAt(0)=="^")var t=!0;return{token:function(n){if(t&&!n.sol()){n.skipToEnd();return}var r=n.match(e,!1);if(r){if(r[0].length==0)return n.next(),"searching";if(!n.sol()){n.backUp(1);if(!e.exec(n.next()+r[0]))return n.next(),null}return n.match(e),"searching"}while(!n.eol()){n.next();if(n.match(e,!1))break}},query:e}}function on(e,t){var n=Wt(e),r=n.getOverlay();if(!r||t!=r.query)r&&e.removeOverlay(r),r=sn(t),e.addOverlay(r),e.showMatchesOnScrollbar&&(n.getScrollbarAnnotate()&&n.getScrollbarAnnotate().clear(),n.setScrollbarAnnotate(e.showMatchesOnScrollbar(t))),n.setOverlay(r)}function un(e,t,r,i){return i===undefined&&(i=1),e.operation(function(){var s=e.getCursor(),o=e.getSearchCursor(r,s);for(var u=0;u<i;u++){var a=o.find(t);u==0&&a&&st(o.from(),s)&&(a=o.find(t));if(!a){o=e.getSearchCursor(r,t?n(e.lastLine()):n(e.firstLine(),0));if(!o.find(t))return}}return o.from()})}function an(e){var t=Wt(e);e.removeOverlay(Wt(e).getOverlay()),t.setOverlay(null),t.getScrollbarAnnotate()&&(t.getScrollbarAnnotate().clear(),t.setScrollbarAnnotate(null))}function fn(e,t,n){return typeof e!="number"&&(e=e.line),t instanceof Array?k(e,t):n?e>=t&&e<=n:e==t}function ln(e){var t=e.getScrollInfo(),n=6,r=10,i=e.coordsChar({left:0,top:n+t.top},"local"),s=t.clientHeight-r+t.top,o=e.coordsChar({left:0,top:s},"local");return{top:i.line,bottom:o.line}}function vn(t,n,r,i,s,o,u,a,f){function h(){t.operation(function(){while(!l)p(),d();v()})}function p(){var e=t.getRange(o.from(),o.to()),n=e.replace(u,a);o.replace(n)}function d(){var e;while(e=o.findNext()&&fn(o.from(),i,s)){if(!r&&c&&o.from().line==c.line)continue;t.scrollIntoView(o.from(),30),t.setSelection(o.from(),o.to()),c=o.from(),l=!1;return}l=!0}function v(e){e&&e(),t.focus();if(c){t.setCursor(c);var n=t.state.vim;n.exMode=!1,n.lastHPos=n.lastHSPos=c.ch}f&&f()}function m(n,r,i){e.e_stop(n);var s=e.keyName(n);switch(s){case"Y":p(),d();break;case"N":d();break;case"A":var o=f;f=undefined,t.operation(h),f=o;break;case"L":p();case"Q":case"Esc":case"Ctrl-C":case"Ctrl-[":v(i)}return l&&v(i),!0}t.state.vim.exMode=!0;var l=!1,c=o.from();d();if(l){Yt(t,"No matches for "+u.source);return}if(!n){h(),f&&f();return}tn(t,{prefix:"replace with <strong>"+a+"</strong> (y/n/a/q/l)",onKeyDown:m})}function mn(t){var n=t.state.vim,r=B.macroModeState,i=B.registerController.getRegister("."),s=r.isPlaying,o=r.lastInsertModeChanges,u=[];if(!s){var a=o.inVisualBlock?n.lastSelection.visualBlock.height:1,f=o.changes,u=[],l=0;while(l<f.length)u.push(f[l]),f[l]instanceof Nn?l++:l+=a;o.changes=u,t.off("change",En),e.off(t.getInputField(),"keydown",Cn)}!s&&n.insertModeRepeat>1&&(kn(t,n,n.insertModeRepeat-1,!0),n.lastEditInputState.repeatOverride=n.insertModeRepeat),delete n.insertModeRepeat,n.insertMode=!1,t.setCursor(t.getCursor().line,t.getCursor().ch-1),t.setOption("keyMap","vim"),t.setOption("disableInput",!0),t.toggleOverwrite(!1),i.setText(o.changes.join("")),e.signal(t,"vim-mode-change",{mode:"normal"}),r.isRecording&&bn(r)}function gn(t,n,r,i){var s=B.registerController.getRegister(i),o=s.keyBuffer,u=0;r.isPlaying=!0,r.replaySearchQueries=s.searchQueries.slice(0);for(var a=0;a<o.length;a++){var f=o[a],l,c;while(f){l=/<\w+-.+?>|<\w+>|./.exec(f),c=l[0],f=f.substring(l.index+c.length),e.Vim.handleKey(t,c,"macro");if(n.insertMode){var h=s.insertModeChanges[u++].changes;B.macroModeState.lastInsertModeChanges.changes=h,Ln(t,h,1),mn(t)}}}r.isPlaying=!1}function yn(e,t){if(e.isPlaying)return;var n=e.latestRegister,r=B.registerController.getRegister(n);r&&r.pushText(t)}function bn(e){if(e.isPlaying)return;var t=e.latestRegister,n=B.registerController.getRegister(t);n&&n.pushInsertModeChanges(e.lastInsertModeChanges)}function wn(e,t){if(e.isPlaying)return;var n=e.latestRegister,r=B.registerController.getRegister(n);r&&r.pushSearchQuery(t)}function En(e,t){var n=B.macroModeState,r=n.lastInsertModeChanges;if(!n.isPlaying)while(t){r.expectCursorActivityForChange=!0;if(t.origin=="+input"||t.origin=="paste"||t.origin===undefined){var i=t.text.join("\n");r.changes.push(i)}t=t.next}}function Sn(e){var t=e.state.vim;if(t.insertMode){var n=B.macroModeState;if(n.isPlaying)return;var r=n.lastInsertModeChanges;r.expectCursorActivityForChange?r.expectCursorActivityForChange=!1:r.changes=[]}else e.curOp.isVimOp||Tn(e,t);t.visualMode&&xn(e)}function xn(e){var t=e.state.vim,n=it(t.sel.head),r=Y(n,0,1);t.fakeCursor&&t.fakeCursor.clear(),t.fakeCursor=e.markText(n,r,{className:"cm-animate-fat-cursor"})}function Tn(t,n){var r=t.getCursor("anchor"),i=t.getCursor("head");n.visualMode&&st(i,r)&&lt(t,i.line)>i.ch?Tt(t,!1):!n.visualMode&&!n.insertMode&&t.somethingSelected()&&(n.visualMode=!0,n.visualLine=!1,e.signal(t,"vim-mode-change",{mode:"visual"}));if(n.visualMode){var s=ot(i,r)?0:-1,o=ot(i,r)?-1:0;i=Y(i,0,s),r=Y(r,0,o),n.sel={anchor:r,head:i},Ft(t,n,"<",ut(i,r)),Ft(t,n,">",at(i,r))}else n.insertMode||(n.lastHPos=t.getCursor().ch)}function Nn(e){this.keyName=e}function Cn(t){function s(){return r.changes.push(new Nn(i)),!0}var n=B.macroModeState,r=n.lastInsertModeChanges,i=e.keyName(t);if(!i)return;(i.indexOf("Delete")!=-1||i.indexOf("Backspace")!=-1)&&e.lookupKey(i,"vim-insert",s)}function kn(e,t,n,r){function u(){s?X.processAction(e,t,t.lastEditActionCommand):X.evalInput(e,t)}function a(n){if(i.lastInsertModeChanges.changes.length>0){n=t.lastEditActionCommand?n:1;var r=i.lastInsertModeChanges;Ln(e,r.changes,n)}}var i=B.macroModeState;i.isPlaying=!0;var s=!!t.lastEditActionCommand,o=t.inputState;t.inputState=t.lastEditInputState;if(s&&t.lastEditActionCommand.interlaceInsertRepeat)for(var f=0;f<n;f++)u(),a(1);else r||u(),a(n);t.inputState=o,t.insertMode&&!r&&mn(e),i.isPlaying=!1}function Ln(t,n,r){function i(n){return typeof n=="string"?e.commands[n](t):n(t),!0}var s=t.getCursor("head"),o=B.macroModeState.lastInsertModeChanges.inVisualBlock;if(o){var u=t.state.vim,a=u.lastSelection,f=Z(a.anchor,a.head);mt(t,s,f.line+1),r=t.listSelections().length,t.setCursor(s)}for(var l=0;l<r;l++){o&&t.setCursor(Y(s,l,0));for(var c=0;c<n.length;c++){var h=n[c];if(h instanceof Nn)e.lookupKey(h.keyName,"vim-insert",i);else{var p=t.getCursor();t.replaceRange(h,p,p)}}}o&&t.setCursor(Y(s,0,1))}e.defineOption("vimMode",!1,function(t,n,r){n&&t.getOption("keyMap")!="vim"?t.setOption("keyMap","vim"):!n&&r!=e.Init&&/^vim/.test(t.getOption("keyMap"))&&t.setOption("keyMap","default")});var a={Shift:"S",Ctrl:"C",Alt:"A",Cmd:"D",Mod:"A"},f={Enter:"CR",Backspace:"BS",Delete:"Del"},h=/[\d]/,p=[/\w/,/[^\w\s]/],d=[/\S/],m=v(65,26),g=v(97,26),y=v(48,10),b=[].concat(m,g,y,["<",">"]),w=[].concat(m,g,y,["-",'"',".",":","/"]),L={},_=function(){function s(s,o,u){function l(n){var r=++t%e,o=i[r];o&&o.clear(),i[r]=s.setBookmark(n)}var a=t%e,f=i[a];if(f){var c=f.find();c&&!st(c,o)&&l(o)}else l(o);l(u),n=t,r=t-e+1,r<0&&(r=0)}function o(s,o){t+=o,t>n?t=n:t<r&&(t=r);var u=i[(e+t)%e];if(u&&!u.find()){var a=o>0?1:-1,f,l=s.getCursor();do{t+=a,u=i[(e+t)%e];if(u&&(f=u.find())&&!st(l,f))break}while(t<n&&t>r)}return u}var e=100,t=-1,n=0,r=0,i=new Array(e);return{cachedCursor:undefined,add:s,move:o}},D=function(e){return e?{changes:e.changes,expectCursorActivityForChange:e.expectCursorActivityForChange}:{changes:[],expectCursorActivityForChange:!1}};P.prototype={exitMacroRecordMode:function(){var e=B.macroModeState;e.onRecordingDone&&e.onRecordingDone(),e.onRecordingDone=undefined,e.isRecording=!1},enterMacroRecordMode:function(e,t){var n=B.registerController.getRegister(t);n&&(n.clear(),this.latestRegister=t,e.openDialog&&(this.onRecordingDone=e.openDialog("(recording)["+t+"]",null,{bottom:!0})),this.isRecording=!0)}};var B,F,I={buildKeyMap:function(){},getRegisterController:function(){return B.registerController},resetVimGlobalState_:j,getVimGlobalState_:function(){return B},maybeInitVimState_:H,suppressErrorLogging:!1,InsertModeKey:Nn,map:function(e,t,n){dn.map(e,t,n)},setOption:O,getOption:M,defineOption:A,defineEx:function(e,t,n){if(e.indexOf(t)!==0)throw new Error('(Vim.defineEx) "'+t+'" is not a prefix of "'+e+'", command not registered');pn[e]=n,dn.commandMap_[t]={name:e,shortName:t,type:"api"}},handleKey:function(e,t,n){var r=this.findKey(e,t,n);if(typeof r=="function")return r()},findKey:function(n,r,i){function o(){var e=B.macroModeState;if(e.isRecording){if(r=="q")return e.exitMacroRecordMode(),R(n),!0;i!="mapping"&&yn(e,r)}}function u(){if(r=="<Esc>")return R(n),s.visualMode?Tt(n):s.insertMode&&mn(n),!0}function a(t){var i;while(t)i=/<\w+-.+?>|<\w+>|./.exec(t),r=i[0],t=t.substring(i.index+r.length),e.Vim.handleKey(n,r,"mapping")}function f(){if(u())return!0;var e=s.inputState.keyBuffer=s.inputState.keyBuffer+r,i=r.length==1,o=X.matchCommand(e,t,s.inputState,"insert");while(e.length>1&&o.type!="full"){var e=s.inputState.keyBuffer=e.slice(1),a=X.matchCommand(e,t,s.inputState,"insert");a.type!="none"&&(o=a)}if(o.type=="none")return R(n),!1;if(o.type=="partial")return F&&window.clearTimeout(F),F=window.setTimeout(function(){s.insertMode&&s.inputState.keyBuffer&&R(n)},M("insertModeEscKeysTimeout")),!i;F&&window.clearTimeout(F);if(i){var f=n.getCursor();n.replaceRange("",Y(f,0,-(e.length-1)),f,"+input")}return R(n),o.command}function l(){if(o()||u())return!0;var e=s.inputState.keyBuffer=s.inputState.keyBuffer+r;if(/^[1-9]\d*$/.test(e))return!0;var i=/^(\d*)(.*)$/.exec(e);if(!i)return R(n),!1;var a=s.visualMode?"visual":"normal",f=X.matchCommand(i[2]||i[1],t,s.inputState,a);if(f.type=="none")return R(n),!1;if(f.type=="partial")return!0;s.inputState.keyBuffer="";var i=/^(\d*)(.*)$/.exec(e);return i[1]&&i[1]!="0"&&s.inputState.pushRepeatDigit(i[1]),f.command}var s=H(n),c;return s.insertMode?c=f():c=l(),c===!1?undefined:c===!0?function(){}:function(){return n.operation(function(){n.curOp.isVimOp=!0;try{c.type=="keyToKey"?a(c.toKeys):X.processCommand(n,s,c)}catch(t){throw n.state.vim=undefined,H(n),e.Vim.suppressErrorLogging||console.log(t),t}return!0})}},handleEx:function(e,t){dn.processCommand(e,t)}};q.prototype.pushRepeatDigit=function(e){this.operator?this.motionRepeat=this.motionRepeat.concat(e):this.prefixRepeat=this.prefixRepeat.concat(e)},q.prototype.getRepeat=function(){var e=0;if(this.prefixRepeat.length>0||this.motionRepeat.length>0)e=1,this.prefixRepeat.length>0&&(e*=parseInt(this.prefixRepeat.join(""),10)),this.motionRepeat.length>0&&(e*=parseInt(this.motionRepeat.join(""),10));return e},U.prototype={setText:function(e,t,n){this.keyBuffer=[e||""],this.linewise=!!t,this.blockwise=!!n},pushText:function(e,t){t&&(this.linewise||this.keyBuffer.push("\n"),this.linewise=!0),this.keyBuffer.push(e)},pushInsertModeChanges:function(e){this.insertModeChanges.push(D(e))},pushSearchQuery:function(e){this.searchQueries.push(e)},clear:function(){this.keyBuffer=[],this.insertModeChanges=[],this.searchQueries=[],this.linewise=!1},toString:function(){return this.keyBuffer.join("")}},z.prototype={pushText:function(e,t,n,r,i){r&&n.charAt(0)=="\n"&&(n=n.slice(1)+"\n"),r&&n.charAt(n.length-1)!=="\n"&&(n+="\n");var s=this.isValidRegister(e)?this.getRegister(e):null;if(!s){switch(t){case"yank":this.registers[0]=new U(n,r,i);break;case"delete":case"change":n.indexOf("\n")==-1?this.registers["-"]=new U(n,r):(this.shiftNumericRegisters_(),this.registers[1]=new U(n,r))}this.unnamedRegister.setText(n,r,i);return}var o=N(e);o?s.pushText(n,r):s.setText(n,r,i),this.unnamedRegister.setText(s.toString(),r)},getRegister:function(e){return this.isValidRegister(e)?(e=e.toLowerCase(),this.registers[e]||(this.registers[e]=new U),this.registers[e]):this.unnamedRegister},isValidRegister:function(e){return e&&k(e,w)},shiftNumericRegisters_:function(){for(var e=9;e>=2;e--)this.registers[e]=this.getRegister(""+(e-1))}},W.prototype={nextMatch:function(e,t){var n=this.historyBuffer,r=t?-1:1;this.initialPrefix===null&&(this.initialPrefix=e);for(var i=this.iterator+r;t?i>=0:i<n.length;i+=r){var s=n[i];for(var o=0;o<=s.length;o++)if(this.initialPrefix==s.substring(0,o))return this.iterator=i,s}if(i>=n.length)return this.iterator=n.length,this.initialPrefix;if(i<0)return e},pushInput:function(e){var t=this.historyBuffer.indexOf(e);t>-1&&this.historyBuffer.splice(t,1),e.length&&this.historyBuffer.push(e)},reset:function(){this.initialPrefix=null,this.iterator=this.historyBuffer.length}};var X={matchCommand:function(e,t,n,r){var i=et(e,t,r,n);if(!i.full&&!i.partial)return{type:"none"};if(!i.full&&i.partial)return{type:"partial"};var s;for(var o=0;o<i.full.length;o++){var u=i.full[o];s||(s=u)}return s.keys.slice(-11)=="<character>"&&(n.selectedCharacter=nt(e)),{type:"full",command:s}},processCommand:function(e,t,n){t.inputState.repeatOverride=n.repeatOverride;switch(n.type){case"motion":this.processMotion(e,t,n);break;case"operator":this.processOperator(e,t,n);break;case"operatorMotion":this.processOperatorMotion(e,t,n);break;case"action":this.processAction(e,t,n);break;case"search":this.processSearch(e,t,n),R(e);break;case"ex":case"keyToEx":this.processEx(e,t,n),R(e);break;default:}},processMotion:function(e,t,n){t.inputState.motion=n.motion,t.inputState.motionArgs=G(n.motionArgs),this.evalInput(e,t)},processOperator:function(e,t,n){var r=t.inputState;if(r.operator){if(r.operator==n.operator){r.motion="expandToLine",r.motionArgs={linewise:!0},this.evalInput(e,t);return}R(e)}r.operator=n.operator,r.operatorArgs=G(n.operatorArgs),t.visualMode&&this.evalInput(e,t)},processOperatorMotion:function(e,t,n){var r=t.visualMode,i=G(n.operatorMotionArgs);i&&r&&i.visualLine&&(t.visualLine=!0),this.processOperator(e,t,n),r||this.processMotion(e,t,n)},processAction:function(e,t,n){var r=t.inputState,i=r.getRepeat(),s=!!i,o=G(n.actionArgs)||{};r.selectedCharacter&&(o.selectedCharacter=r.selectedCharacter),n.operator&&this.processOperator(e,t,n),n.motion&&this.processMotion(e,t,n),(n.motion||n.operator)&&this.evalInput(e,t),o.repeat=i||1,o.repeatIsExplicit=s,o.registerName=r.registerName,R(e),t.lastMotion=null,n.isEdit&&this.recordLastEdit(t,r,n),K[n.action](e,o,t)},processSearch:function(t,n,r){function f(e,i,s){B.searchHistoryController.pushInput(e),B.searchHistoryController.reset();try{rn(t,e,i,s)}catch(o){Yt(t,"Invalid regex: "+e);return}X.processMotion(t,n,{type:"motion",motion:"findNext",motionArgs:{forward:!0,toJumplist:r.searchArgs.toJumplist}})}function l(e){t.scrollTo(a.left,a.top),f(e,!0,!0);var n=B.macroModeState;n.isRecording&&wn(n,e)}function c(n,r,s){var o=e.keyName(n),u;o=="Up"||o=="Down"?(u=o=="Up"?!0:!1,r=B.searchHistoryController.nextMatch(r,u)||"",s(r)):o!="Left"&&o!="Right"&&o!="Ctrl"&&o!="Alt"&&o!="Shift"&&B.searchHistoryController.reset();var f;try{f=rn(t,r,!0,!0)}catch(n){}f?t.scrollIntoView(un(t,!i,f),30):(an(t),t.scrollTo(a.left,a.top))}function h(n,r,i){var s=e.keyName(n);if(s=="Esc"||s=="Ctrl-C"||s=="Ctrl-[")B.searchHistoryController.pushInput(r),B.searchHistoryController.reset(),rn(t,u),an(t),t.scrollTo(a.left,a.top),e.e_stop(n),i(),t.focus()}if(!t.getSearchCursor)return;var i=r.searchArgs.forward,s=r.searchArgs.wholeWordOnly;Wt(t).setReversed(!i);var o=i?"/":"?",u=Wt(t).getQuery(),a=t.getScrollInfo();switch(r.searchArgs.querySrc){case"prompt":var p=B.macroModeState;if(p.isPlaying){var d=p.replaySearchQueries.shift();f(d,!0,!1)}else tn(t,{onClose:l,prefix:o,desc:en,onKeyUp:c,onKeyDown:h});break;case"wordUnderCursor":var v=Lt(t,!1,!0,!1,!0),m=!0;v||(v=Lt(t,!1,!0,!1,!1),m=!1);if(!v)return;var d=t.getLine(v.start.line).substring(v.start.ch,v.end.ch);m&&s?d="\\b"+d+"\\b":d=pt(d),B.jumpList.cachedCursor=t.getCursor(),t.setCursor(v.start),f(d,!0,!1)}},processEx:function(t,n,r){function i(e){B.exCommandHistoryController.pushInput(e),B.exCommandHistoryController.reset(),dn.processCommand(t,e)}function s(n,r,i){var s=e.keyName(n),o;if(s=="Esc"||s=="Ctrl-C"||s=="Ctrl-[")B.exCommandHistoryController.pushInput(r),B.exCommandHistoryController.reset(),e.e_stop(n),i(),t.focus();s=="Up"||s=="Down"?(o=s=="Up"?!0:!1,r=B.exCommandHistoryController.nextMatch(r,o)||"",i(r)):s!="Left"&&s!="Right"&&s!="Ctrl"&&s!="Alt"&&s!="Shift"&&B.exCommandHistoryController.reset()}r.type=="keyToEx"?dn.processCommand(t,r.exArgs.input):n.visualMode?tn(t,{onClose:i,prefix:":",value:"'<,'>",onKeyDown:s}):tn(t,{onClose:i,prefix:":",onKeyDown:s})},evalInput:function(e,t){var r=t.inputState,i=r.motion,s=r.motionArgs||{},o=r.operator,u=r.operatorArgs||{},a=r.registerName,f=t.sel,l=it(t.visualMode?f.head:e.getCursor("head")),c=it(t.visualMode?f.anchor:e.getCursor("anchor")),h=it(l),p=it(c),d,v,m;o&&this.recordLastEdit(t,r),r.repeatOverride!==undefined?m=r.repeatOverride:m=r.getRepeat();if(m>0&&s.explicitRepeat)s.repeatIsExplicit=!0;else if(s.noRepeat||!s.explicitRepeat&&m===0)m=1,s.repeatIsExplicit=!1;r.selectedCharacter&&(s.selectedCharacter=u.selectedCharacter=r.selectedCharacter),s.repeat=m,R(e);if(i){var g=V[i](e,l,s,t);t.lastMotion=V[i];if(!g)return;if(s.toJumplist){var y=B.jumpList,b=y.cachedCursor;b?(At(e,b,g),delete y.cachedCursor):At(e,l,g)}g instanceof Array?(v=g[0],d=g[1]):d=g,d||(d=it(l));if(t.visualMode){if(!t.visualBlock||d.ch!==Infinity)d=Q(e,d,t.visualBlock);v&&(v=Q(e,v,!0)),v=v||p,f.anchor=v,f.head=d,Et(e),Ft(e,t,"<",ot(v,d)?v:d),Ft(e,t,">",ot(v,d)?d:v)}else o||(d=Q(e,d),e.setCursor(d.line,d.ch))}if(o){if(u.lastSel){v=p;var w=u.lastSel,E=Math.abs(w.head.line-w.anchor.line),S=Math.abs(w.head.ch-w.anchor.ch);w.visualLine?d=n(p.line+E,p.ch):w.visualBlock?d=n(p.line+E,p.ch+S):w.head.line==w.anchor.line?d=n(p.line,p.ch+S):d=n(p.line+E,p.ch),t.visualMode=!0,t.visualLine=w.visualLine,t.visualBlock=w.visualBlock,f=t.sel={anchor:v,head:d},Et(e)}else t.visualMode&&(u.lastSel={anchor:it(f.anchor),head:it(f.head),visualBlock:t.visualBlock,visualLine:t.visualLine});var x,T,N,C,k;if(t.visualMode){x=ut(f.head,f.anchor),T=at(f.head,f.anchor),N=t.visualLine||u.linewise,C=t.visualBlock?"block":N?"line":"char",k=St(e,{anchor:x,head:T},C);if(N){var L=k.ranges;if(C=="block")for(var A=0;A<L.length;A++)L[A].head.ch=lt(e,L[A].head.line);else C=="line"&&(L[0].head=n(L[0].head.line+1,0))}}else{x=it(v||p),T=it(d||h);if(ot(T,x)){var O=x;x=T,T=O}N=s.linewise||u.linewise,N?Ct(e,x,T):s.forward&&Nt(e,x,T),C="char";var M=!s.inclusive||N;k=St(e,{anchor:x,head:T},C,M)}e.setSelections(k.ranges,k.primary),t.lastMotion=null,u.repeat=m,u.registerName=a,u.linewise=N;var _=J[o](e,u,k.ranges,p,d);t.visualMode&&Tt(e),_&&e.setCursor(_)}},recordLastEdit:function(e,t,n){var r=B.macroModeState;if(r.isPlaying)return;e.lastEditInputState=t,e.lastEditActionCommand=n,r.lastInsertModeChanges.changes=[],r.lastInsertModeChanges.expectCursorActivityForChange=!1}},V={moveToTopLine:function(e,t,r){var i=ln(e).top+r.repeat-1;return n(i,kt(e.getLine(i)))},moveToMiddleLine:function(e){var t=ln(e),r=Math.floor((t.top+t.bottom)*.5);return n(r,kt(e.getLine(r)))},moveToBottomLine:function(e,t,r){var i=ln(e).bottom-r.repeat+1;return n(i,kt(e.getLine(i)))},expandToLine:function(e,t,r){var i=t;return n(i.line+r.repeat-1,Infinity)},findNext:function(e,t,n){var r=Wt(e),i=r.getQuery();if(!i)return;var s=!n.forward;return s=r.isReversed()?!s:s,on(e,i),un(e,s,i,n.repeat)},goToMark:function(e,t,n,r){var i=r.marks[n.selectedCharacter];if(i){var s=i.find();return n.linewise?{line:s.line,ch:kt(e.getLine(s.line))}:s}return null},moveToOtherHighlightedEnd:function(e,t,r,i){if(i.visualBlock&&r.sameLine){var s=i.sel;return[Q(e,n(s.anchor.line,s.head.ch)),Q(e,n(s.head.line,s.anchor.ch))]}return[i.sel.head,i.sel.anchor]},jumpToMark:function(e,t,r,i){var s=t;for(var o=0;o<r.repeat;o++){var u=s;for(var a in i.marks){if(!S(a))continue;var f=i.marks[a].find(),l=r.forward?ot(f,u):ot(u,f);if(l)continue;if(r.linewise&&f.line==u.line)continue;var c=st(u,s),h=r.forward?ft(u,f,s):ft(s,f,u);if(c||h)s=f}}return r.linewise&&(s=n(s.line,kt(e.getLine(s.line)))),s},moveByCharacters:function(e,t,r){var i=t,s=r.repeat,o=r.forward?i.ch+s:i.ch-s;return n(i.line,o)},moveByLines:function(e,t,r,i){var s=t,o=s.ch;switch(i.lastMotion){case this.moveByLines:case this.moveByDisplayLines:case this.moveByScroll:case this.moveToColumn:case this.moveToEol:o=i.lastHPos;break;default:i.lastHPos=o}var u=r.repeat+(r.repeatOffset||0),a=r.forward?s.line+u:s.line-u,f=e.firstLine(),l=e.lastLine();if(a<f&&s.line==f||a>l&&s.line==l)return;return r.toFirstChar&&(o=kt(e.getLine(a)),i.lastHPos=o),i.lastHSPos=e.charCoords(n(a,o),"div").left,n(a,o)},moveByDisplayLines:function(e,t,r,i){var s=t;switch(i.lastMotion){case this.moveByDisplayLines:case this.moveByScroll:case this.moveByLines:case this.moveToColumn:case this.moveToEol:break;default:i.lastHSPos=e.charCoords(s,"div").left}var o=r.repeat,u=e.findPosV(s,r.forward?o:-o,"line",i.lastHSPos);if(u.hitSide)if(r.forward)var a=e.charCoords(u,"div"),f={top:a.top+8,left:i.lastHSPos},u=e.coordsChar(f,"div");else{var l=e.charCoords(n(e.firstLine(),0),"div");l.left=i.lastHSPos,u=e.coordsChar(l,"div")}return i.lastHPos=u.ch,u},moveByPage:function(e,t,n){var r=t,i=n.repeat;return e.findPosV(r,n.forward?i:-i,"page")},moveByParagraph:function(e,t,n){var r=n.forward?1:-1;return qt(e,t,n.repeat,r)},moveByScroll:function(e,t,n,r){var i=e.getScrollInfo(),s=null,o=n.repeat;o||(o=i.clientHeight/(2*e.defaultTextHeight()));var u=e.charCoords(t,"local");n.repeat=o;var s=V.moveByDisplayLines(e,t,n,r);if(!s)return null;var a=e.charCoords(s,"local");return e.scrollTo(null,i.top+a.top-u.top),s},moveByWords:function(e,t,n){return Ht(e,t,n.repeat,!!n.forward,!!n.wordEnd,!!n.bigWord)},moveTillCharacter:function(e,t,n){var r=n.repeat,i=Bt(e,r,n.forward,n.selectedCharacter),s=n.forward?-1:1;return Ot(s,n),i?(i.ch+=s,i):null},moveToCharacter:function(e,t,n){var r=n.repeat;return Ot(0,n),Bt(e,r,n.forward,n.selectedCharacter)||t},moveToSymbol:function(e,t,n){var r=n.repeat;return Dt(e,r,n.forward,n.selectedCharacter)||t},moveToColumn:function(e,t,n,r){var i=n.repeat;return r.lastHPos=i-1,r.lastHSPos=e.charCoords(t,"div").left,jt(e,i)},moveToEol:function(e,t,r,i){var s=t;i.lastHPos=Infinity;var o=n(s.line+r.repeat-1,Infinity),u=e.clipPos(o);return u.ch--,i.lastHSPos=e.charCoords(u,"div").left,o},moveToFirstNonWhiteSpaceCharacter:function(e,t){var r=t;return n(r.line,kt(e.getLine(r.line)))},moveToMatchedSymbol:function(e,t){var r=t,i=r.line,s=r.ch,o=e.getLine(i),u;do{u=o.charAt(s++);if(u&&x(u)){var a=e.getTokenTypeAt(n(i,s));if(a!=="string"&&a!=="comment")break}}while(u);if(u){var f=e.findMatchingBracket(n(i,s));return f.to}return r},moveToStartOfLine:function(e,t){return n(t.line,0)},moveToLineOrEdgeOfDocument:function(e,t,r){var i=r.forward?e.lastLine():e.firstLine();return r.repeatIsExplicit&&(i=r.repeat-e.getOption("firstLineNumber")),n(i,kt(e.getLine(i)))},textObjectManipulation:function(e,t,n,r){var i={"(":")",")":"(","{":"}","}":"{","[":"]","]":"["},s={"'":!0,'"':!0},o=n.selectedCharacter;o=="b"?o="(":o=="B"&&(o="{");var u=!n.textObjectInner,a;if(i[o])a=Rt(e,t,o,u);else if(s[o])a=Ut(e,t,o,u);else if(o==="W")a=Lt(e,u,!0,!0);else if(o==="w")a=Lt(e,u,!0,!1);else{if(o!=="p")return null;a=qt(e,t,n.repeat,0,u),n.linewise=!0;if(r.visualMode)r.visualLine||(r.visualLine=!0);else{var f=r.inputState.operatorArgs;f&&(f.linewise=!0),a.end.line--}}return e.state.vim.visualMode?wt(e,a.start,a.end):[a.start,a.end]},repeatLastCharacterSearch:function(e,t,n){var r=B.lastChararacterSearch,i=n.repeat,s=n.forward===r.forward,o=(r.increment?1:0)*(s?-1:1);e.moveH(-o,"char"),n.inclusive=s?!0:!1;var u=Bt(e,i,s,r.selectedCharacter);return u?(u.ch+=o,u):(e.moveH(o,"char"),t)}},J={change:function(t,n,r){var i,s,o=t.state.vim;B.macroModeState.lastInsertModeChanges.inVisualBlock=o.visualBlock;if(!o.visualMode){var u=r[0].anchor,a=r[0].head;s=t.getRange(u,a);if(!C(s)){var f=/\s+$/.exec(s);f&&(a=Y(a,0,-f[0].length),s=s.slice(0,-f[0].length))}var l=a.line-1==t.lastLine();t.replaceRange("",u,a),n.linewise&&!l&&(e.commands.newlineAndIndent(t),u.ch=null),i=u}else{s=t.getSelection();var c=$("",r.length);t.replaceSelections(c),i=ut(r[0].head,r[0].anchor)}B.registerController.pushText(n.registerName,"change",s,n.linewise,r.length>1),K.enterInsertMode(t,{head:i},t.state.vim)},"delete":function(e,t,r){var i,s,o=e.state.vim;if(!o.visualBlock){var u=r[0].anchor,a=r[0].head;t.linewise&&a.line!=e.firstLine()&&u.line==e.lastLine()&&u.line==a.line-1&&(u.line==e.firstLine()?u.ch=0:u=n(u.line-1,lt(e,u.line-1))),s=e.getRange(u,a),e.replaceRange("",u,a),i=u,t.linewise&&(i=V.moveToFirstNonWhiteSpaceCharacter(e,u))}else{s=e.getSelection();var f=$("",r.length);e.replaceSelections(f),i=r[0].anchor}return B.registerController.pushText(t.registerName,"delete",s,t.linewise,o.visualBlock),i},indent:function(e,t,n){var r=e.state.vim,i=n[0].anchor.line,s=r.visualBlock?n[n.length-1].anchor.line:n[0].head.line,o=r.visualMode?t.repeat:1;t.linewise&&s--;for(var u=i;u<=s;u++)for(var a=0;a<o;a++)e.indentLine(u,t.indentRight);return V.moveToFirstNonWhiteSpaceCharacter(e,n[0].anchor)},changeCase:function(e,t,n,r,i){var s=e.getSelections(),o=[],u=t.toLower;for(var a=0;a<s.length;a++){var f=s[a],l="";if(u===!0)l=f.toLowerCase();else if(u===!1)l=f.toUpperCase();else for(var c=0;c<f.length;c++){var h=f.charAt(c);l+=N(h)?h.toLowerCase():h.toUpperCase()}o.push(l)}return e.replaceSelections(o),t.shouldMoveCursor?i:!e.state.vim.visualMode&&t.linewise&&n[0].anchor.line+1==n[0].head.line?V.moveToFirstNonWhiteSpaceCharacter(e,r):t.linewise?r:ut(n[0].anchor,n[0].head)},yank:function(e,t,n,r){var i=e.state.vim,s=e.getSelection(),o=i.visualMode?ut(i.sel.anchor,i.sel.head,n[0].head,n[0].anchor):r;return B.registerController.pushText(t.registerName,"yank",s,t.linewise,i.visualBlock),o}},K={jumpListWalk:function(e,t,n){if(n.visualMode)return;var r=t.repeat,i=t.forward,s=B.jumpList,o=s.move(e,i?r:-r),u=o?o.find():undefined;u=u?u:e.getCursor(),e.setCursor(u)},scroll:function(e,t,n){if(n.visualMode)return;var r=t.repeat||1,i=e.defaultTextHeight(),s=e.getScrollInfo().top,o=i*r,u=t.forward?s+o:s-o,a=it(e.getCursor()),f=e.charCoords(a,"local");if(t.forward)u>f.top?(a.line+=(u-f.top)/i,a.line=Math.ceil(a.line),e.setCursor(a),f=e.charCoords(a,"local"),e.scrollTo(null,f.top)):e.scrollTo(null,u);else{var l=u+e.getScrollInfo().clientHeight;l<f.bottom?(a.line-=(f.bottom-l)/i,a.line=Math.floor(a.line),e.setCursor(a),f=e.charCoords(a,"local"),e.scrollTo(null,f.bottom-e.getScrollInfo().clientHeight)):e.scrollTo(null,u)}},scrollToCursor:function(e,t){var r=e.getCursor().line,i=e.charCoords(n(r,0),"local"),s=e.getScrollInfo().clientHeight,o=i.top,u=i.bottom-o;switch(t.position){case"center":o=o-s/2+u;break;case"bottom":o=o-s+u*1.4;break;case"top":o+=u*.4}e.scrollTo(null,o)},replayMacro:function(e,t,n){var r=t.selectedCharacter,i=t.repeat,s=B.macroModeState;r=="@"&&(r=s.latestRegister);while(i--)gn(e,n,s,r)},enterMacroRecordMode:function(e,t){var n=B.macroModeState,r=t.selectedCharacter;n.enterMacroRecordMode(e,r)},enterInsertMode:function(t,r,i){if(t.getOption("readOnly"))return;i.insertMode=!0,i.insertModeRepeat=r&&r.repeat||1;var s=r?r.insertAt:null,o=i.sel,u=r.head||t.getCursor("head"),a=t.listSelections().length;if(s=="eol")u=n(u.line,lt(t,u.line));else if(s=="charAfter")u=Y(u,0,1);else if(s=="firstNonBlank")u=V.moveToFirstNonWhiteSpaceCharacter(t,u);else if(s=="startOfSelectedArea")i.visualBlock?(u=n(Math.min(o.head.line,o.anchor.line),Math.min(o.head.ch,o.anchor.ch)),a=Math.abs(o.head.line-o.anchor.line)+1):o.head.line<o.anchor.line?u=o.head:u=n(o.anchor.line,0);else if(s=="endOfSelectedArea")i.visualBlock?(u=n(Math.min(o.head.line,o.anchor.line),Math.max(o.head.ch+1,o.anchor.ch)),a=Math.abs(o.head.line-o.anchor.line)+1):o.head.line>=o.anchor.line?u=Y(o.head,0,1):u=n(o.anchor.line,0);else if(s=="inplace"&&i.visualMode)return;t.setOption("keyMap","vim-insert"),t.setOption("disableInput",!1),r&&r.replace?(t.toggleOverwrite(!0),t.setOption("keyMap","vim-replace"),e.signal(t,"vim-mode-change",{mode:"replace"})):(t.setOption("keyMap","vim-insert"),e.signal(t,"vim-mode-change",{mode:"insert"})),B.macroModeState.isPlaying||(t.on("change",En),e.on(t.getInputField(),"keydown",Cn)),i.visualMode&&Tt(t),mt(t,u,a)},toggleVisualMode:function(t,r,i){var s=r.repeat,o=t.getCursor(),u;i.visualMode?i.visualLine^r.linewise||i.visualBlock^r.blockwise?(i.visualLine=!!r.linewise,i.visualBlock=!!r.blockwise,e.signal(t,"vim-mode-change",{mode:"visual",subMode:i.visualLine?"linewise":i.visualBlock?"blockwise":""}),Et(t)):Tt(t):(i.visualMode=!0,i.visualLine=!!r.linewise,i.visualBlock=!!r.blockwise,u=Q(t,n(o.line,o.ch+s-1),!0),i.sel={anchor:o,head:u},e.signal(t,"vim-mode-change",{mode:"visual",subMode:i.visualLine?"linewise":i.visualBlock?"blockwise":""}),Et(t),Ft(t,i,"<",ut(o,u)),Ft(t,i,">",at(o,u)))},reselectLastSelection:function(t,n,r){var i=r.lastSelection;r.visualMode&&bt(t,r);if(i){var s=i.anchorMark.find(),o=i.headMark.find();if(!s||!o)return;r.sel={anchor:s,head:o},r.visualMode=!0,r.visualLine=i.visualLine,r.visualBlock=i.visualBlock,Et(t),Ft(t,r,"<",ut(s,o)),Ft(t,r,">",at(s,o)),e.signal(t,"vim-mode-change",{mode:"visual",subMode:r.visualLine?"linewise":r.visualBlock?"blockwise":""})}},joinLines:function(e,t,r){var i,s;if(r.visualMode)i=e.getCursor("anchor"),s=e.getCursor("head"),s.ch=lt(e,s.line)-1;else{var o=Math.max(t.repeat,2);i=e.getCursor(),s=Q(e,n(i.line+o-1,Infinity))}var u=0;for(var a=i.line;a<s.line;a++){u=lt(e,i.line);var f=n(i.line+1,lt(e,i.line+1)),l=e.getRange(i,f);l=l.replace(/\n\s*/g," "),e.replaceRange(l,i,f)}var c=n(i.line,u);e.setCursor(c),r.visualMode&&Tt(e)},newLineAndEnterInsertMode:function(t,r,i){i.insertMode=!0;var s=it(t.getCursor());if(s.line===t.firstLine()&&!r.after)t.replaceRange("\n",n(t.firstLine(),0)),t.setCursor(t.firstLine(),0);else{s.line=r.after?s.line:s.line-1,s.ch=lt(t,s.line),t.setCursor(s);var o=e.commands.newlineAndIndentContinueComment||e.commands.newlineAndIndent;o(t)}this.enterInsertMode(t,{repeat:r.repeat},i)},paste:function(e,t,r){var i=it(e.getCursor()),s=B.registerController.getRegister(t.registerName),o=s.toString();if(!o)return;if(t.matchIndent){var u=e.getOption("tabSize"),a=function(e){var t=e.split("	").length-1,n=e.split(" ").length-1;return t*u+n*1},f=e.getLine(e.getCursor().line),l=a(f.match(/^\s*/)[0]),c=o.replace(/\n$/,""),h=o!==c,p=a(o.match(/^\s*/)[0]),o=c.replace(/^\s*/gm,function(t){var n=l+(a(t)-p);if(n<0)return"";if(e.getOption("indentWithTabs")){var r=Math.floor(n/u);return Array(r+1).join("	")}return Array(n+1).join(" ")});o+=h?"\n":""}if(t.repeat>1)var o=Array(t.repeat+1).join(o);var d=s.linewise,v=s.blockwise;if(d)r.visualMode?o=r.visualLine?o.slice(0,-1):"\n"+o.slice(0,o.length-1)+"\n":t.after?(o="\n"+o.slice(0,o.length-1),i.ch=lt(e,i.line)):i.ch=0;else{if(v){o=o.split("\n");for(var m=0;m<o.length;m++)o[m]=o[m]==""?" ":o[m]}i.ch+=t.after?1:0}var g,y;if(r.visualMode){r.lastPastedText=o;var b,w=yt(e,r),E=w[0],S=w[1],x=e.getSelection(),T=e.listSelections(),N=(new Array(T.length)).join("1").split("1");r.lastSelection&&(b=r.lastSelection.headMark.find()),B.registerController.unnamedRegister.setText(x),v?(e.replaceSelections(N),S=n(E.line+o.length-1,E.ch),e.setCursor(E),vt(e,S),e.replaceSelections(o),g=E):r.visualBlock?(e.replaceSelections(N),e.setCursor(E),e.replaceRange(o,E,E),g=E):(e.replaceRange(o,E,S),g=e.posFromIndex(e.indexFromPos(E)+o.length-1)),b&&(r.lastSelection.headMark=e.setBookmark(b)),d&&(g.ch=0)}else if(v){e.setCursor(i);for(var m=0;m<o.length;m++){var C=i.line+m;C>e.lastLine()&&e.replaceRange("\n",n(C,0));var k=lt(e,C);k<i.ch&&dt(e,C,i.ch)}e.setCursor(i),vt(e,n(i.line+o.length-1,i.ch)),e.replaceSelections(o),g=i}else e.replaceRange(o,i),d&&t.after?g=n(i.line+1,kt(e.getLine(i.line+1))):d&&!t.after?g=n(i.line,kt(e.getLine(i.line))):!d&&t.after?(y=e.indexFromPos(i),g=e.posFromIndex(y+o.length-1)):(y=e.indexFromPos(i),g=e.posFromIndex(y+o.length));r.visualMode&&Tt(e),e.setCursor(g)},undo:function(t,n){t.operation(function(){rt(t,e.commands.undo,n.repeat)(),t.setCursor(t.getCursor("anchor"))})},redo:function(t,n){rt(t,e.commands.redo,n.repeat)()},setRegister:function(e,t,n){n.inputState.registerName=t.selectedCharacter},setMark:function(e,t,n){var r=t.selectedCharacter;Ft(e,n,r,e.getCursor())},replace:function(t,r,i){var s=r.selectedCharacter,o=t.getCursor(),u,a,f=t.listSelections();if(i.visualMode)o=t.getCursor("start"),a=t.getCursor("end");else{var l=t.getLine(o.line);u=o.ch+r.repeat,u>l.length&&(u=l.length),a=n(o.line,u)}if(s=="\n")i.visualMode||t.replaceRange("",o,a),(e.commands.newlineAndIndentContinueComment||e.commands.newlineAndIndent)(t);else{var c=t.getRange(o,a);c=c.replace(/[^\n]/g,s);if(i.visualBlock){var h=(new Array(t.getOption("tabSize")+1)).join(" ");c=t.getSelection(),c=c.replace(/\t/g,h).replace(/[^\n]/g,s).split("\n"),t.replaceSelections(c)}else t.replaceRange(c,o,a);i.visualMode?(o=ot(f[0].anchor,f[0].head)?f[0].anchor:f[0].head,t.setCursor(o),Tt(t)):t.setCursor(Y(a,0,-1))}},incrementNumberToken:function(e,t){var r=e.getCursor(),i=e.getLine(r.line),s=/-?\d+/g,o,u,a,f,l;while((o=s.exec(i))!==null){l=o[0],u=o.index,a=u+l.length;if(r.ch<a)break}if(!t.backtrack&&a<=r.ch)return;if(!l)return;var c=t.increase?1:-1,h=parseInt(l)+c*t.repeat,p=n(r.line,u),d=n(r.line,a);f=h.toString(),e.replaceRange(f,p,d),e.setCursor(n(r.line,u+f.length-1))},repeatLastEdit:function(e,t,n){var r=n.lastEditInputState;if(!r)return;var i=t.repeat;i&&t.repeatIsExplicit?n.lastEditInputState.repeatOverride=i:i=n.lastEditInputState.repeatOverride||i,kn(e,n,i,!1)},exitInsertMode:mn},Mt={"(":"bracket",")":"bracket","{":"bracket","}":"bracket","[":"section","]":"section","*":"comment","/":"comment",m:"method",M:"method","#":"preprocess"},_t={bracket:{isComplete:function(e){if(e.nextCh===e.symb){e.depth++;if(e.depth>=1)return!0}else e.nextCh===e.reverseSymb&&e.depth--;return!1}},section:{init:function(e){e.curMoveThrough=!0,e.symb=(e.forward?"]":"[")===e.symb?"{":"}"},isComplete:function(e){return e.index===0&&e.nextCh===e.symb}},comment:{isComplete:function(e){var t=e.lastCh==="*"&&e.nextCh==="/";return e.lastCh=e.nextCh,t}},method:{init:function(e){e.symb=e.symb==="m"?"{":"}",e.reverseSymb=e.symb==="{"?"}":"{"},isComplete:function(e){return e.nextCh===e.symb?!0:!1}},preprocess:{init:function(e){e.index=0},isComplete:function(e){if(e.nextCh==="#"){var t=e.lineText.match(/#(\w+)/)[1];if(t==="endif"){if(e.forward&&e.depth===0)return!0;e.depth++}else if(t==="if"){if(!e.forward&&e.depth===0)return!0;e.depth--}if(t==="else"&&e.depth===0)return!0}return!1}}};A("pcre",!0,"boolean"),zt.prototype={getQuery:function(){return B.query},setQuery:function(e){B.query=e},getOverlay:function(){return this.searchOverlay},setOverlay:function(e){this.searchOverlay=e},isReversed:function(){return B.isReversed},setReversed:function(e){B.isReversed=e},getScrollbarAnnotate:function(){return this.annotate},setScrollbarAnnotate:function(e){this.annotate=e}};var en="(Javascript regexp)",cn=[{name:"map"},{name:"imap",shortName:"im"},{name:"nmap",shortName:"nm"},{name:"vmap",shortName:"vm"},{name:"unmap"},{name:"write",shortName:"w"},{name:"undo",shortName:"u"},{name:"redo",shortName:"red"},{name:"set",shortName:"set"},{name:"sort",shortName:"sor"},{name:"substitute",shortName:"s",possiblyAsync:!0},{name:"nohlsearch",shortName:"noh"},{name:"delmarks",shortName:"delm"},{name:"registers",shortName:"reg",excludeFromCommandHistory:!0},{name:"global",shortName:"g"}],hn=function(){this.buildCommandMap_()};hn.prototype={processCommand:function(t,n,r){var i=t.state.vim,s=B.registerController.getRegister(":"),o=s.toString();i.visualMode&&Tt(t);var u=new e.StringStream(n);s.setText(n);var a=r||{};a.input=n;try{this.parseInput_(t,u,a)}catch(f){throw Yt(t,f),f}var l,c;if(!a.commandName)a.line!==undefined&&(c="move");else{l=this.matchCommand_(a.commandName);if(l){c=l.name,l.excludeFromCommandHistory&&s.setText(o),this.parseCommandArgs_(u,a,l);if(l.type=="exToKey"){for(var h=0;h<l.toKeys.length;h++)e.Vim.handleKey(t,l.toKeys[h],"mapping");return}if(l.type=="exToEx"){this.processCommand(t,l.toInput);return}}}if(!c){Yt(t,'Not an editor command ":'+n+'"');return}try{pn[c](t,a),(!l||!l.possiblyAsync)&&a.callback&&a.callback()}catch(f){throw Yt(t,f),f}},parseInput_:function(e,t,n){t.eatWhile(":"),t.eat("%")?(n.line=e.firstLine(),n.lineEnd=e.lastLine()):(n.line=this.parseLineSpec_(e,t),n.line!==undefined&&t.eat(",")&&(n.lineEnd=this.parseLineSpec_(e,t)));var r=t.match(/^(\w+)/);return r?n.commandName=r[1]:n.commandName=t.match(/.*/)[0],n},parseLineSpec_:function(e,t){var n=t.match(/^(\d+)/);if(n)return parseInt(n[1],10)-1;switch(t.next()){case".":return e.getCursor().line;case"$":return e.lastLine();case"'":var r=e.state.vim.marks[t.next()];if(r&&r.find())return r.find().line;throw new Error("Mark not set");default:return t.backUp(1),undefined}},parseCommandArgs_:function(e,t,n){if(e.eol())return;t.argString=e.match(/.*/)[0];var r=n.argDelimiter||/\s+/,i=ht(t.argString).split(r);i.length&&i[0]&&(t.args=i)},matchCommand_:function(e){for(var t=e.length;t>0;t--){var n=e.substring(0,t);if(this.commandMap_[n]){var r=this.commandMap_[n];if(r.name.indexOf(e)===0)return r}}return null},buildCommandMap_:function(){this.commandMap_={};for(var e=0;e<cn.length;e++){var t=cn[e],n=t.shortName||t.name;this.commandMap_[n]=t}},map:function(e,n,r){if(e!=":"&&e.charAt(0)==":"){if(r)throw Error("Mode not supported for ex mappings");var i=e.substring(1);n!=":"&&n.charAt(0)==":"?this.commandMap_[i]={name:i,type:"exToEx",toInput:n.substring(1),user:!0}:this.commandMap_[i]={name:i,type:"exToKey",toKeys:n,user:!0}}else if(n!=":"&&n.charAt(0)==":"){var s={keys:e,type:"keyToEx",exArgs:{input:n.substring(1)},user:!0};r&&(s.context=r),t.unshift(s)}else{var s={keys:e,type:"keyToKey",toKeys:n,user:!0};r&&(s.context=r),t.unshift(s)}},unmap:function(e,n){if(e!=":"&&e.charAt(0)==":"){if(n)throw Error("Mode not supported for ex mappings");var r=e.substring(1);if(this.commandMap_[r]&&this.commandMap_[r].user){delete this.commandMap_[r];return}}else{var i=e;for(var s=0;s<t.length;s++)if(i==t[s].keys&&t[s].context===n&&t[s].user){t.splice(s,1);return}}throw Error("No such mapping.")}};var pn={map:function(e,t,n){var r=t.args;if(!r||r.length<2){e&&Yt(e,"Invalid mapping: "+t.input);return}dn.map(r[0],r[1],n)},imap:function(e,t){this.map(e,t,"insert")},nmap:function(e,t){this.map(e,t,"normal")},vmap:function(e,t){this.map(e,t,"visual")},unmap:function(e,t,n){var r=t.args;if(!r||r.length<1){e&&Yt(e,"No such mapping: "+t.input);return}dn.unmap(r[0],n)},move:function(e,t){X.processCommand(e,e.state.vim,{type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!1,explicitRepeat:!0,linewise:!0},repeatOverride:t.line+1})},set:function(e,t){var n=t.args;if(!n||n.length<1){e&&Yt(e,"Invalid mapping: "+t.input);return}var r=n[0].split("="),i=r[0],s=r[1],o=!1;if(i.charAt(i.length-1)=="?"){if(s)throw Error("Trailing characters: "+t.argString);i=i.substring(0,i.length-1),o=!0}s===undefined&&i.substring(0,2)=="no"&&(i=i.substring(2),s=!1);var u=L[i]&&L[i].type=="boolean";u&&s==undefined&&(s=!0);if(!u&&!s||o){var a=M(i);a===!0||a===!1?Yt(e," "+(a?"":"no")+i):Yt(e,"  "+i+"="+a)}else O(i,s)},registers:function(e,t){var n=t.args,r=B.registerController.registers,i="----------Registers----------<br><br>";if(!n)for(var s in r){var o=r[s].toString();o.length&&(i+='"'+s+"    "+o+"<br>")}else{var s;n=n.join("");for(var u=0;u<n.length;u++){s=n.charAt(u);if(!B.registerController.isValidRegister(s))continue;var a=r[s]||new U;i+='"'+s+"    "+a.toString()+"<br>"}}Yt(e,i)},sort:function(t,r){function a(){if(r.argString){var t=new e.StringStream(r.argString);t.eat("!")&&(i=!0);if(t.eol())return;if(!t.eatSpace())return"Invalid arguments";var n=t.match(/[a-z]+/);if(n){n=n[0],s=n.indexOf("i")!=-1,o=n.indexOf("u")!=-1;var a=n.indexOf("d")!=-1&&1,f=n.indexOf("x")!=-1&&1,l=n.indexOf("o")!=-1&&1;if(a+f+l>1)return"Invalid arguments";u=a&&"decimal"||f&&"hex"||l&&"octal"}t.eatSpace()&&t.match(/\/.*\//)&&"patterns not supported"}}function w(e,t){if(i){var n;n=e,e=t,t=n}s&&(e=e.toLowerCase(),t=t.toLowerCase());var r=u&&v.exec(e),o=u&&v.exec(t);return r?(r=parseInt((r[1]+r[2]).toLowerCase(),m),o=parseInt((o[1]+o[2]).toLowerCase(),m),r-o):e<t?-1:1}var i,s,o,u,f=a();if(f){Yt(t,f+": "+r.argString);return}var l=r.line||t.firstLine(),c=r.lineEnd||r.line||t.lastLine();if(l==c)return;var h=n(l,0),p=n(c,lt(t,c)),d=t.getRange(h,p).split("\n"),v=u=="decimal"?/(-?)([\d]+)/:u=="hex"?/(-?)(?:0x)?([0-9a-f]+)/i:u=="octal"?/([0-7]+)/:null,m=u=="decimal"?10:u=="hex"?16:u=="octal"?8:null,g=[],y=[];if(u)for(var b=0;b<d.length;b++)v.exec(d[b])?g.push(d[b]):y.push(d[b]);else y=d;g.sort(w),y.sort(w),d=i?g.concat(y):y.concat(g);if(o){var E=d,S;d=[];for(var b=0;b<E.length;b++)E[b]!=S&&d.push(E[b]),S=E[b]}t.replaceRange(d.join("\n"),h,p)},global:function(e,t){var n=t.argString;if(!n){Yt(e,"Regular Expression missing from global");return}var r=t.line!==undefined?t.line:e.firstLine(),i=t.lineEnd||t.line||e.lastLine(),s=Vt(n),o=n,u;s.length&&(o=s[0],u=s.slice(1,s.length).join("/"));if(o)try{rn(e,o,!0,!0)}catch(a){Yt(e,"Invalid regex: "+o);return}var f=Wt(e).getQuery(),l=[],c="";for(var h=r;h<=i;h++){var p=f.test(e.getLine(h));p&&(l.push(h+1),c+=e.getLine(h)+"<br>")}if(!u){Yt(e,c);return}var d=0,v=function(){if(d<l.length){var t=l[d]+u;dn.processCommand(e,t,{callback:v})}d++};v()},substitute:function(e,t){if(!e.getSearchCursor)throw new Error("Search feature not available. Requires searchcursor.js or any other getSearchCursor implementation.");var r=t.argString,i=r?Vt(r):[],s,o="",u,a,f,l=!1,c=!1;if(i.length)s=i[0],o=i[1],o!==undefined&&(M("pcre")?o=Qt(o):o=Kt(o),B.lastSubstituteReplacePart=o),u=i[2]?i[2].split(" "):[];else if(r&&r.length){Yt(e,"Substitutions should be of the form :s/pattern/replace/");return}u&&(a=u[0],f=parseInt(u[1]),a&&(a.indexOf("c")!=-1&&(l=!0,a.replace("c","")),a.indexOf("g")!=-1&&(c=!0,a.replace("g","")),s=s+"/"+a));if(s)try{rn(e,s,!0,!0)}catch(h){Yt(e,"Invalid regex: "+s);return}o=o||B.lastSubstituteReplacePart;if(o===undefined){Yt(e,"No previous substitute regular expression");return}var p=Wt(e),d=p.getQuery(),v=t.line!==undefined?t.line:e.getCursor().line,m=t.lineEnd||v;f&&(v=m,m=v+f-1);var g=Q(e,n(v,0)),y=e.getSearchCursor(d,g);vn(e,l,c,v,m,y,d,o,t.callback)},redo:e.commands.redo,undo:e.commands.undo,write:function(t){e.commands.save?e.commands.save(t):t.save()},nohlsearch:function(e){an(e)},delmarks:function(t,n){if(!n.argString||!ht(n.argString)){Yt(t,"Argument required");return}var r=t.state.vim,i=new e.StringStream(ht(n.argString));while(!i.eol()){i.eatSpace();var s=i.pos;if(!i.match(/[a-zA-Z]/,!1)){Yt(t,"Invalid argument: "+n.argString.substring(s));return}var o=i.next();if(i.match("-",!0)){if(!i.match(/[a-zA-Z]/,!1)){Yt(t,"Invalid argument: "+n.argString.substring(s));return}var u=o,a=i.next();if(!(S(u)&&S(a)||N(u)&&N(a))){Yt(t,"Invalid argument: "+u+"-");return}var f=u.charCodeAt(0),l=a.charCodeAt(0);if(f>=l){Yt(t,"Invalid argument: "+n.argString.substring(s));return}for(var c=0;c<=l-f;c++){var h=String.fromCharCode(f+c);delete r.marks[h]}}else delete r.marks[o]}}},dn=new hn;return e.keyMap.vim={attach:o,detach:s,call:u},A("insertModeEscKeysTimeout",200,"number"),e.keyMap["vim-insert"]={"Ctrl-N":"autocomplete","Ctrl-P":"autocomplete",Enter:function(t){var n=e.commands.newlineAndIndentContinueComment||e.commands.newlineAndIndent;n(t)},fallthrough:["default"],attach:o,detach:s,call:u},e.keyMap["vim-replace"]={Backspace:"goCharLeft",fallthrough:["vim-insert"],attach:o,detach:s,call:u},j(),I};e.Vim=r()});