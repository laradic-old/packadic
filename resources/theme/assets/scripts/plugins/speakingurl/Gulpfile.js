var gulp=require("gulp"),plugin=require("gulp-load-plugins")(),fs=require("fs"),exec=require("child_process").exec,argv=require("minimist")(process.argv.slice(2)),path={rootdir:"./",lib:["./lib/**/*.js"],libdir:"./lib/",test:["./test/**/*.js"],testdir:"./test/",build:["package.json","component.json","bower.json","README.md","speakingurl.min.js"],json:["package.json","component.json","bower.json"],readme:"./README.md",target:"./speakingurl.min.js"},banner=["/**"," * <%= pkg.name %>"," * @version v<%= pkg.version %>"," * @link <%= pkg.homepage %>"," * @license <%= pkg.licenses[0].type %>"," * @author <%= pkg.author.name %>"," */"].join("\n");gulp.task("beautify",function(e){gulp.src(path.lib).pipe(plugin.jsbeautifier({config:".jsbeautifyrc",mode:"VERIFY_AND_WRITE"})).pipe(gulp.dest(path.libdir)),gulp.src(path.test).pipe(plugin.jsbeautifier({config:".jsbeautifyrc",mode:"VERIFY_AND_WRITE"})).pipe(gulp.dest(path.testdir)),gulp.src(path.json).pipe(plugin.jsbeautifier({config:".jsbeautifyrc",mode:"VERIFY_AND_WRITE"})).pipe(gulp.dest(path.rootdir)),e()}),gulp.task("test",function(){return gulp.src(path.test,{read:!1}).pipe(plugin.mocha({reporter:"spec",globals:{should:require("should")}}))}),gulp.task("jshint",["beautify"],function(){return gulp.src(path.lib,path.json).pipe(plugin.jshint(".jshintrc"),{verbose:!0}).pipe(plugin.jshint.reporter("jshint-stylish"))}),gulp.task("uglify",["jshint"],function(e){var t=JSON.parse(fs.readFileSync("./package.json","utf-8"));return gulp.src(path.lib).pipe(plugin.uglify()).pipe(plugin.header(banner,{pkg:t})).pipe(plugin.rename(path.target)).pipe(gulp.dest(path.rootdir))}),gulp.task("bumpup",["bumpup-version"],function(){var e=JSON.parse(fs.readFileSync("./package.json","utf-8"));return gulp.src(path.readme).pipe(plugin.replace(/cdnjs.cloudflare.com\/ajax\/libs\/speakingurl\/\d{1,1}\.\d{1,2}\.\d{1,2}\/speakingurl.min.js/g,"cdnjs.cloudflare.com/ajax/libs/speakingurl/"+e.version+"/speakingurl.min.js")).pipe(plugin.replace(/cdn.jsdelivr.net\/speakingurl\/\d{1,1}\.\d{1,2}\.\d{1,2}\/speakingurl.min.js/g,"cdn.jsdelivr.net/speakingurl/"+e.version+"/speakingurl.min.js")).pipe(gulp.dest(path.rootdir))}),gulp.task("bumpup-version",function(){return gulp.src(path.json).pipe(plugin.bump({type:argv.major?"major":argv.minor?"minor":"patch"})).pipe(gulp.dest(path.rootdir))}),gulp.task("release",function(e){var t=JSON.parse(fs.readFileSync("./package.json","utf-8")),n="v"+t.version,r="Release "+n,i=["npm rm speakingurl -g","npm install . -g","git add .",'git commit -m "Release '+n+'"',"git tag "+n+' -m "Release '+n+'"',"git push -u origin master","git push -u origin master --tags","npm publish"].join("\n");exec(i,e())}),gulp.task("watch",function(){gulp.watch([path.json,path.lib],["jshint","test"])}),gulp.task("default",["test","jshint","uglify"]);