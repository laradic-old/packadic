var path=require("path"),fs=require("fs"),marked=require("marked"),express=require("express"),less=require("less-file"),browserify=require("browserify-middleware"),CodeMirror=require("highlight-codemirror"),highlightJade=require("jade-highlighter"),jade=require("../"),version=require("../package.json").version,app=express(),filters=jade.filters;CodeMirror.loadMode("xml"),CodeMirror.loadMode("htmlmixed"),CodeMirror.loadMode("javascript"),CodeMirror.loadMode("css"),filters.jadesrc=highlightJade,filters.htmlsrc=function(e){return CodeMirror.highlight(e,{name:"htmlmixed"})},filters.jssrc=function(e){return CodeMirror.highlight(e,{name:"javascript"})},filters.csssrc=function(e){return CodeMirror.highlight(e,{name:"css"})},app.engine("jade",jade.renderFile),app.set("views",__dirname+"/views"),app.locals.doctypes=jade.doctypes,app.use(function(e,t,n){if(e.url.substr(0,version.length+2)==="/"+version+"/")e.url=e.url.substr(version.length+1),t.locals.path=function(e){return"/"+version+e};else{if(/^\/\d+\.\d+\.\d+\//.test(e.url)){t.send(404,"This page only exists on the live website");return}t.locals.path=function(e){return e}}n()}),app.get("/",function(e,t,n){t.render("home.jade")}),app.get("/reference",function(e,t,n){t.render("reference.jade",{section:"reference"})}),app.get("/reference/:name",function(e,t,n){t.render("reference/"+e.params.name+".jade",{section:"reference",currentDocumentation:e.params.name})}),app.get("/api",function(e,t,n){t.render("api.jade",{section:"api"})}),app.get("/command-line",function(e,t,n){t.render("command-line.jade",{section:"command-line"})}),app.get("/history",function(e,t,n){var r=/(\d+\.\d+\.\d+) *\/ *\d\d\d\d\-\d\d\-\d\d\<\/h2\>/g,i=JSON.parse(fs.readFileSync(__dirname+"/versions.json","utf8"));i.indexOf(version)===-1&&(i.push(version),fs.writeFileSync(__dirname+"/versions.json",JSON.stringify(i,null,"  ")));var s=marked(fs.readFileSync(__dirname+"/../History.md","utf8")).replace(/h1/g,"h2").replace(r,function(e,t){return i.indexOf(t)!==-1?e+'<p><a href="/'+t+'/reference" rel="nofollow">Documentation</a></p>':e});t.render("history.jade",{section:"history",history:s})}),app.get("/client.js",browserify(__dirname+"/client/index.js")),app.use("/style",less(__dirname+"/style/index.less")),app.use("/style",express.static(__dirname+"/style")),app.use(function(e,t,n,r){var i=e.stack||e.toString();console.error(i),n.statusCode<400&&(n.statusCode=500),e.status&&(n.statusCode=e.status),n.setHeader("Content-Type","text/plain"),n.setHeader("Content-Length",Buffer.byteLength(i));if("HEAD"==t.method)return n.end();n.end(i)}),module.exports=app.listen(3e3),module.exports.version=version;