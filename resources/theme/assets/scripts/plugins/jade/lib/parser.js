var Lexer=require("./lexer"),nodes=require("./nodes"),utils=require("./utils"),filters=require("./filters"),path=require("path"),constantinople=require("constantinople"),parseJSExpression=require("character-parser").parseMax,extname=path.extname,Parser=exports=module.exports=function(t,n,r){this.input=t.replace(/^\uFEFF/,""),this.lexer=new Lexer(this.input,n),this.filename=n,this.blocks={},this.mixins={},this.options=r,this.contexts=[this],this.inMixin=0,this.dependencies=[],this.inBlock=0};Parser.prototype={constructor:Parser,context:function(e){if(!e)return this.contexts.pop();this.contexts.push(e)},advance:function(){return this.lexer.advance()},peek:function(){return this.lookahead(1)},line:function(){return this.lexer.lineno},lookahead:function(e){return this.lexer.lookahead(e)},parse:function(){var e=new nodes.Block,t;e.line=0,e.filename=this.filename;while("eos"!=this.peek().type)if("newline"==this.peek().type)this.advance();else{var n=this.peek(),r=this.parseExpr();r.filename=r.filename||this.filename,r.line=n.line,e.push(r)}if(t=this.extending){this.context(t);var i=t.parse();this.context();for(var s in this.mixins)i.unshift(this.mixins[s]);return i}if(!this.extending&&!this.included&&Object.keys(this.blocks).length){var o=[];utils.walkAST(e,function(e){e.type==="Block"&&e.name&&o.push(e.name)}),Object.keys(this.blocks).forEach(function(e){o.indexOf(e)===-1&&!this.blocks[e].isSubBlock&&console.warn('Warning: Unexpected block "'+e+'" '+" on line "+this.blocks[e].line+" of "+this.blocks[e].filename+". This block is never used. This warning will be an error in v2.0.0")}.bind(this))}return e},expect:function(e){if(this.peek().type===e)return this.advance();throw new Error('expected "'+e+'", but got "'+this.peek().type+'"')},accept:function(e){if(this.peek().type===e)return this.advance()},parseExpr:function(){switch(this.peek().type){case"tag":return this.parseTag();case"mixin":return this.parseMixin();case"block":return this.parseBlock();case"mixin-block":return this.parseMixinBlock();case"case":return this.parseCase();case"extends":return this.parseExtends();case"include":return this.parseInclude();case"doctype":return this.parseDoctype();case"filter":return this.parseFilter();case"comment":return this.parseComment();case"text":return this.parseText();case"each":return this.parseEach();case"code":return this.parseCode();case"call":return this.parseCall();case"interpolation":return this.parseInterpolation();case"yield":this.advance();var e=new nodes.Block;return e.yield=!0,e;case"id":case"class":var t=this.advance();return this.lexer.defer(this.lexer.tok("tag","div")),this.lexer.defer(t),this.parseExpr();default:throw new Error('unexpected token "'+this.peek().type+'"')}},parseText:function(){var e=this.expect("text"),t=this.parseInlineTagsInText(e.val);if(t.length===1)return t[0];var n=new nodes.Block;for(var r=0;r<t.length;r++)n.push(t[r]);return n},parseBlockExpansion:function(){return":"==this.peek().type?(this.advance(),new nodes.Block(this.parseExpr())):this.block()},parseCase:function(){var e=this.expect("case").val,t=new nodes.Case(e);t.line=this.line();var n=new nodes.Block;n.line=this.line(),n.filename=this.filename,this.expect("indent");while("outdent"!=this.peek().type)switch(this.peek().type){case"comment":case"newline":this.advance();break;case"when":n.push(this.parseWhen());break;case"default":n.push(this.parseDefault());break;default:throw new Error('Unexpected token "'+this.peek().type+'", expected "when", "default" or "newline"')}return this.expect("outdent"),t.block=n,t},parseWhen:function(){var e=this.expect("when").val;return this.peek().type!=="newline"?new nodes.Case.When(e,this.parseBlockExpansion()):new nodes.Case.When(e)},parseDefault:function(){return this.expect("default"),new nodes.Case.When("default",this.parseBlockExpansion())},parseCode:function(e){var t=this.expect("code"),n=new nodes.Code(t.val,t.buffer,t.escape),r;n.line=this.line();if(t.isElse&&!t.hasIf)throw new Error("Unexpected else without if");return r="indent"==this.peek().type,r&&(n.block=this.block()),t.requiresBlock&&!r&&(n.block=new nodes.Block),t.isIf&&this.peek().isElse?this.peek().hasIf=!0:t.isIf&&this.peek().type==="newline"&&this.lookahead(2).isElse&&(this.lookahead(2).hasIf=!0),n},parseComment:function(){var e=this.expect("comment"),t,n;return(n=this.parseTextBlock())?t=new nodes.BlockComment(e.val,n,e.buffer):t=new nodes.Comment(e.val,e.buffer),t.line=this.line(),t},parseDoctype:function(){var e=this.expect("doctype"),t=new nodes.Doctype(e.val);return t.line=this.line(),t},parseFilter:function(){var e=this.expect("filter"),t=this.accept("attrs"),n;n=this.parseTextBlock()||new nodes.Block;var r={};t&&t.attrs.forEach(function(e){r[e.name]=constantinople.toConstant(e.val)});var i=new nodes.Filter(e.val,n,r);return i.line=this.line(),i},parseEach:function(){var e=this.expect("each"),t=new nodes.Each(e.code,e.val,e.key);return t.line=this.line(),t.block=this.block(),this.peek().type=="code"&&this.peek().val=="else"&&(this.advance(),t.alternative=this.block()),t},resolvePath:function(e,t){var n=require("path"),r=n.dirname,i=n.basename,s=n.join;if(e[0]!=="/"&&!this.filename)throw new Error('the "filename" option is required to use "'+t+'" with "relative" paths');if(e[0]==="/"&&!this.options.basedir)throw new Error('the "basedir" option is required to use "'+t+'" with "absolute" paths');return e=s(e[0]==="/"?this.options.basedir:r(this.filename),e),i(e).indexOf(".")===-1&&(e+=".jade"),e},parseExtends:function(){var e=require("fs"),t=this.resolvePath(this.expect("extends").val.trim(),"extends");".jade"!=t.substr(-5)&&(t+=".jade"),this.dependencies.push(t);var n=e.readFileSync(t,"utf8"),r=new this.constructor(n,t,this.options);return r.dependencies=this.dependencies,r.blocks=this.blocks,r.included=this.included,r.contexts=this.contexts,this.extending=r,new nodes.Literal("")},parseBlock:function(){var e=this.expect("block"),t=e.mode,n=e.val.trim(),r=e.line;this.inBlock++,e="indent"==this.peek().type?this.block():new nodes.Block(new nodes.Literal("")),this.inBlock--,e.name=n,e.line=r;var i=this.blocks[n]||{prepended:[],appended:[]};if(i.mode==="replace")return this.blocks[n]=i;var s=i.prepended.concat(e.nodes).concat(i.appended);switch(t){case"append":i.appended=i.parser===this?i.appended.concat(e.nodes):e.nodes.concat(i.appended);break;case"prepend":i.prepended=i.parser===this?e.nodes.concat(i.prepended):i.prepended.concat(e.nodes)}return e.nodes=s,e.appended=i.appended,e.prepended=i.prepended,e.mode=t,e.parser=this,e.isSubBlock=this.inBlock>0,this.blocks[n]=e},parseMixinBlock:function(){var e=this.expect("mixin-block");if(!this.inMixin)throw new Error("Anonymous blocks are not allowed unless they are part of a mixin.");return new nodes.MixinBlock},parseInclude:function(){var e=require("fs"),t=this.expect("include"),n=this.resolvePath(t.val.trim(),"include");this.dependencies.push(n);if(t.filter){var r=e.readFileSync(n,"utf8").replace(/\r/g,""),i={filename:n};return t.attrs&&t.attrs.attrs.forEach(function(e){i[e.name]=constantinople.toConstant(e.val)}),r=filters(t.filter,r,i),new nodes.Literal(r)}if(".jade"!=n.substr(-5)){var r=e.readFileSync(n,"utf8").replace(/\r/g,"");return new nodes.Literal(r)}var r=e.readFileSync(n,"utf8"),s=new this.constructor(r,n,this.options);s.dependencies=this.dependencies,s.blocks=utils.merge({},this.blocks),s.included=!0,s.mixins=this.mixins,this.context(s);var o=s.parse();return this.context(),o.filename=n,"indent"==this.peek().type&&o.includeBlock().push(this.block()),o},parseCall:function(){var e=this.expect("call"),t=e.val,n=e.args,r=new nodes.Mixin(t,n,new nodes.Block,!0);return this.tag(r),r.code&&(r.block.push(r.code),r.code=null),r.block.isEmpty()&&(r.block=null),r},parseMixin:function(){var e=this.expect("mixin"),t=e.val,n=e.args,r;return"indent"==this.peek().type?(this.inMixin++,r=new nodes.Mixin(t,n,this.block(),!1),this.mixins[t]=r,this.inMixin--,r):new nodes.Mixin(t,n,null,!0)},parseInlineTagsInText:function(e){var t=this.line(),n=/(\\)?#\[((?:.|\n)*)$/.exec(e);if(n){if(n[1]){var r=new nodes.Text(e.substr(0,n.index)+"#[");r.line=t;var i=this.parseInlineTagsInText(n[2]);return i[0].type==="Text"&&(r.val+=i[0].val,i.shift()),[r].concat(i)}var r=new nodes.Text(e.substr(0,n.index));r.line=t;var s=[r],i=n[2],o=parseJSExpression(i),u=new Parser(o.src,this.filename,this.options);return s.push(u.parse()),s.concat(this.parseInlineTagsInText(i.substr(o.end+1)))}var r=new nodes.Text(e);return r.line=t,[r]},parseTextBlock:function(){var e=new nodes.Block;e.line=this.line();var t=this.peek();if(t.type!=="pipeless-text")return;return this.advance(),e.nodes=t.val.reduce(function(e,t){return e.concat(this.parseInlineTagsInText(t))}.bind(this),[]),e},block:function(){var e=new nodes.Block;e.line=this.line(),e.filename=this.filename,this.expect("indent");while("outdent"!=this.peek().type)if("newline"==this.peek().type)this.advance();else{var t=this.parseExpr();t.filename=this.filename,e.push(t)}return this.expect("outdent"),e},parseInterpolation:function(){var e=this.advance(),t=new nodes.Tag(e.val);return t.buffer=!0,this.tag(t)},parseTag:function(){var e=this.advance(),t=new nodes.Tag(e.val);return t.selfClosing=e.selfClosing,this.tag(t)},tag:function(e){e.line=this.line();var t=!1;e:for(;;)switch(this.peek().type){case"id":case"class":var n=this.advance();e.setAttribute(n.type,"'"+n.val+"'");continue;case"attrs":t&&console.warn(this.filename+", line "+this.peek().line+":\nYou should not have jade tags with multiple attributes."),t=!0;var n=this.advance(),r=n.attrs;n.selfClosing&&(e.selfClosing=!0);for(var i=0;i<r.length;i++)e.setAttribute(r[i].name,r[i].val,r[i].escaped);continue;case"&attributes":var n=this.advance();e.addAttributes(n.val);break;default:break e}"dot"==this.peek().type&&(e.textOnly=!0,this.advance());switch(this.peek().type){case"text":e.block.push(this.parseText());break;case"code":e.code=this.parseCode();break;case":":this.advance(),e.block=new nodes.Block,e.block.push(this.parseExpr());break;case"newline":case"indent":case"outdent":case"eos":case"pipeless-text":break;default:throw new Error("Unexpected token `"+this.peek().type+"` expected `text`, `code`, `:`, `newline` or `eos`")}while("newline"==this.peek().type)this.advance();if(e.textOnly)e.block=this.parseTextBlock()||new nodes.Block;else if("indent"==this.peek().type){var s=this.block();for(var i=0,o=s.nodes.length;i<o;++i)e.block.push(s.nodes[i])}return e}};