function isConstant(e){return constantinople(e,{jade:runtime,jade_interp:undefined})}function toConstant(e){return constantinople.toConstant(e,{jade:runtime,jade_interp:undefined})}function errorAtNode(e,t){return t.line=e.line,t.filename=e.filename,t}var nodes=require("./nodes"),filters=require("./filters"),doctypes=require("./doctypes"),runtime=require("./runtime"),utils=require("./utils"),selfClosing=require("void-elements"),parseJSExpression=require("character-parser").parseMax,constantinople=require("constantinople"),Compiler=module.exports=function(t,n){this.options=n=n||{},this.node=t,this.hasCompiledDoctype=!1,this.hasCompiledTag=!1,this.pp=n.pretty||!1,this.pp&&typeof this.pp!="string"&&(this.pp="  "),this.debug=!1!==n.compileDebug,this.indents=0,this.parentIndents=0,this.terse=!1,this.mixins={},this.dynamicMixins=!1,n.doctype&&this.setDoctype(n.doctype)};Compiler.prototype={compile:function(){this.buf=[],this.pp&&this.buf.push("var jade_indent = [];"),this.lastBufferedIdx=-1,this.visit(this.node);if(!this.dynamicMixins){var e=Object.keys(this.mixins);for(var t=0;t<e.length;t++){var n=this.mixins[e[t]];if(!n.used)for(var r=0;r<n.instances.length;r++)for(var i=n.instances[r].start;i<n.instances[r].end;i++)this.buf[i]=""}}return this.buf.join("\n")},setDoctype:function(e){this.doctype=doctypes[e.toLowerCase()]||"<!DOCTYPE "+e+">",this.terse=this.doctype.toLowerCase()=="<!doctype html>",this.xml=0==this.doctype.indexOf("<?xml")},buffer:function(e,t){var n=this;if(t){var r=/(\\)?([#!]){((?:.|\n)*)$/.exec(e);if(r){this.buffer(e.substr(0,r.index),!1);if(r[1]){this.buffer(r[2]+"{",!1),this.buffer(r[3],!0);return}var i=r[3],s=parseJSExpression(i),o=("!"==r[2]?"":"jade.escape")+"((jade_interp = "+s.src+") == null ? '' : jade_interp)";this.bufferExpression(o),this.buffer(i.substr(s.end+1),!0);return}}e=utils.stringify(e),e=e.substr(1,e.length-2),this.lastBufferedIdx==this.buf.length?(this.lastBufferedType==="code"&&(this.lastBuffered+=' + "'),this.lastBufferedType="text",this.lastBuffered+=e,this.buf[this.lastBufferedIdx-1]="buf.push("+this.bufferStartChar+this.lastBuffered+'");'):(this.buf.push('buf.push("'+e+'");'),this.lastBufferedType="text",this.bufferStartChar='"',this.lastBuffered=e,this.lastBufferedIdx=this.buf.length)},bufferExpression:function(e){if(isConstant(e))return this.buffer(toConstant(e)+"",!1);this.lastBufferedIdx==this.buf.length?(this.lastBufferedType==="text"&&(this.lastBuffered+='"'),this.lastBufferedType="code",this.lastBuffered+=" + ("+e+")",this.buf[this.lastBufferedIdx-1]="buf.push("+this.bufferStartChar+this.lastBuffered+");"):(this.buf.push("buf.push("+e+");"),this.lastBufferedType="code",this.bufferStartChar="",this.lastBuffered="("+e+")",this.lastBufferedIdx=this.buf.length)},prettyIndent:function(e,t){e=e||0,t=t?"\n":"",this.buffer(t+Array(this.indents+e).join(this.pp)),this.parentIndents&&this.buf.push("buf.push.apply(buf, jade_indent);")},visit:function(e){var t=this.debug;t&&this.buf.push("jade_debug.unshift({ lineno: "+e.line+", filename: "+(e.filename?utils.stringify(e.filename):"jade_debug[0].filename")+" });"),!1===e.debug&&this.debug&&(this.buf.pop(),this.buf.pop()),this.visitNode(e),t&&this.buf.push("jade_debug.shift();")},visitNode:function(e){return this["visit"+e.type](e)},visitCase:function(e){var t=this.withinCase;this.withinCase=!0,this.buf.push("switch ("+e.expr+"){"),this.visit(e.block),this.buf.push("}"),this.withinCase=t},visitWhen:function(e){"default"==e.expr?this.buf.push("default:"):this.buf.push("case "+e.expr+":"),e.block&&(this.visit(e.block),this.buf.push("  break;"))},visitLiteral:function(e){this.buffer(e.str)},visitBlock:function(e){var t=e.nodes.length,n=this.escape,r=this.pp;r&&t>1&&!n&&e.nodes[0].isText&&e.nodes[1].isText&&this.prettyIndent(1,!0);for(var i=0;i<t;++i)r&&i>0&&!n&&e.nodes[i].isText&&e.nodes[i-1].isText&&this.prettyIndent(1,!1),this.visit(e.nodes[i]),e.nodes[i+1]&&e.nodes[i].isText&&e.nodes[i+1].isText&&this.buffer("\n")},visitMixinBlock:function(e){this.pp&&this.buf.push("jade_indent.push('"+Array(this.indents+1).join(this.pp)+"');"),this.buf.push("block && block();"),this.pp&&this.buf.push("jade_indent.pop();")},visitDoctype:function(e){e&&(e.val||!this.doctype)&&this.setDoctype(e.val||"default"),this.doctype&&this.buffer(this.doctype),this.hasCompiledDoctype=!0},visitMixin:function(e){var t="jade_mixins[",n=e.args||"",r=e.block,i=e.attrs,s=e.attributeBlocks.slice(),o=this.pp,u=e.name[0]==="#",a=e.name;u&&(this.dynamicMixins=!0),t+=(u?e.name.substr(2,e.name.length-3):'"'+e.name+'"')+"]",this.mixins[a]=this.mixins[a]||{used:!1,instances:[]};if(e.call){this.mixins[a].used=!0,o&&this.buf.push("jade_indent.push('"+Array(this.indents+1).join(o)+"');");if(r||i.length||s.length){this.buf.push(t+".call({");if(r){this.buf.push("block: function(){"),this.parentIndents++;var f=this.indents;this.indents=0,this.visit(e.block),this.indents=f,this.parentIndents--,i.length||s.length?this.buf.push("},"):this.buf.push("}")}if(s.length){if(i.length){var l=this.attrs(i);s.unshift(l)}this.buf.push("attributes: jade.merge(["+s.join(",")+"])")}else if(i.length){var l=this.attrs(i);this.buf.push("attributes: "+l)}n?this.buf.push("}, "+n+");"):this.buf.push("});")}else this.buf.push(t+"("+n+");");o&&this.buf.push("jade_indent.pop();")}else{var c=this.buf.length;n=n?n.split(","):[];var h;n.length&&/^\.\.\./.test(n[n.length-1].trim())&&(h=n.pop().trim().replace(/^\.\.\./,"")),this.buf.push(t+" = function("+n.join(",")+"){"),this.buf.push("var block = (this && this.block), attributes = (this && this.attributes) || {};"),h&&(this.buf.push("var "+h+" = [];"),this.buf.push("for (jade_interp = "+n.length+"; jade_interp < arguments.length; jade_interp++) {"),this.buf.push("  "+h+".push(arguments[jade_interp]);"),this.buf.push("}")),this.parentIndents++,this.visit(r),this.parentIndents--,this.buf.push("};");var p=this.buf.length;this.mixins[a].instances.push({start:c,end:p})}},visitTag:function(e){function i(){e.buffer?r.bufferExpression(t):r.buffer(t)}this.indents++;var t=e.name,n=this.pp,r=this;"pre"==e.name&&(this.escape=!0),this.hasCompiledTag||(!this.hasCompiledDoctype&&"html"==t&&this.visitDoctype(),this.hasCompiledTag=!0),n&&!e.isInline()&&this.prettyIndent(0,!0);if(e.selfClosing||!this.xml&&selfClosing[e.name]){this.buffer("<"),i(),this.visitAttributes(e.attrs,e.attributeBlocks.slice()),this.terse?this.buffer(">"):this.buffer("/>");if(e.block&&(e.block.type!=="Block"||e.block.nodes.length!==0)&&e.block.nodes.some(function(e){return e.type!=="Text"||!/^\s*$/.test(e.val)}))throw errorAtNode(e,new Error(t+" is self closing and should not have content."))}else this.buffer("<"),i(),this.visitAttributes(e.attrs,e.attributeBlocks.slice()),this.buffer(">"),e.code&&this.visitCode(e.code),this.visit(e.block),n&&!e.isInline()&&"pre"!=e.name&&!e.canInline()&&this.prettyIndent(0,!0),this.buffer("</"),i(),this.buffer(">");"pre"==e.name&&(this.escape=!1),this.indents--},visitFilter:function(e){var t=e.block.nodes.map(function(e){return e.val}).join("\n");e.attrs.filename=this.options.filename;try{this.buffer(filters(e.name,t,e.attrs),!0)}catch(n){throw errorAtNode(e,n)}},visitText:function(e){this.buffer(e.val,!0)},visitComment:function(e){if(!e.buffer)return;this.pp&&this.prettyIndent(1,!0),this.buffer("<!--"+e.val+"-->")},visitBlockComment:function(e){if(!e.buffer)return;this.pp&&this.prettyIndent(1,!0),this.buffer("<!--"+e.val),this.visit(e.block),this.pp&&this.prettyIndent(1,!0),this.buffer("-->")},visitCode:function(e){if(e.buffer){var t=e.val.trim();t="null == (jade_interp = "+t+') ? "" : jade_interp',e.escape&&(t="jade.escape("+t+")"),this.bufferExpression(t)}else this.buf.push(e.val);e.block&&(e.buffer||this.buf.push("{"),this.visit(e.block),e.buffer||this.buf.push("}"))},visitEach:function(e){this.buf.push("// iterate "+e.obj+"\n"+";(function(){\n"+"  var $$obj = "+e.obj+";\n"+"  if ('number' == typeof $$obj.length) {\n"),e.alternative&&this.buf.push("  if ($$obj.length) {"),this.buf.push("    for (var "+e.key+" = 0, $$l = $$obj.length; "+e.key+" < $$l; "+e.key+"++) {\n"+"      var "+e.val+" = $$obj["+e.key+"];\n"),this.visit(e.block),this.buf.push("    }\n"),e.alternative&&(this.buf.push("  } else {"),this.visit(e.alternative),this.buf.push("  }")),this.buf.push("  } else {\n    var $$l = 0;\n    for (var "+e.key+" in $$obj) {\n"+"      $$l++;"+"      var "+e.val+" = $$obj["+e.key+"];\n"),this.visit(e.block),this.buf.push("    }\n"),e.alternative&&(this.buf.push("    if ($$l === 0) {"),this.visit(e.alternative),this.buf.push("    }")),this.buf.push("  }\n}).call(this);\n")},visitAttributes:function(e,t){if(t.length){if(e.length){var n=this.attrs(e);t.unshift(n)}this.bufferExpression("jade.attrs(jade.merge(["+t.join(",")+"]), "+utils.stringify(this.terse)+")")}else e.length&&this.attrs(e,!0)},attrs:function(e,t){var n=[],r=[],i=[];return e.forEach(function(e){var s=e.name,o=e.escaped;if(s==="class")r.push(e.val),i.push(e.escaped);else if(isConstant(e.val))if(t)this.buffer(runtime.attr(s,toConstant(e.val),o,this.terse));else{var u=toConstant(e.val);s==="style"&&(u=runtime.style(u)),o&&(s.indexOf("data")!==0||typeof u=="string")&&(u=runtime.escape(u)),n.push(utils.stringify(s)+": "+utils.stringify(u))}else if(t)this.bufferExpression('jade.attr("'+s+'", '+e.val+", "+utils.stringify(o)+", "+utils.stringify(this.terse)+")");else{var u=e.val;s==="style"&&(u="jade.style("+u+")"),o&&s.indexOf("data")!==0?u="jade.escape("+u+")":o&&(u="(typeof (jade_interp = "+u+') == "string" ? jade.escape(jade_interp) : jade_interp)'),n.push(utils.stringify(s)+": "+u)}}.bind(this)),t?r.every(isConstant)?this.buffer(runtime.cls(r.map(toConstant),i)):this.bufferExpression("jade.cls(["+r.join(",")+"], "+utils.stringify(i)+")"):r.length&&(r.every(isConstant)?r=utils.stringify(runtime.joinClasses(r.map(toConstant).map(runtime.joinClasses).map(function(e,t){return i[t]?runtime.escape(e):e}))):r="(jade_interp = "+utils.stringify(i)+","+" jade.joinClasses(["+r.join(",")+"].map(jade.joinClasses).map(function (cls, i) {"+"   return jade_interp[i] ? jade.escape(cls) : cls"+" }))"+")",r.length&&n.push('"class": '+r)),"{"+n.join(",")+"}"}};