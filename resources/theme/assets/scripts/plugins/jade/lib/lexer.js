function assertExpression(e){Function("","return ("+e+")")}function assertNestingCorrect(e){var t=characterParser(e);if(t.isNesting())throw new Error("Nesting must match on expression `"+e+"`")}var utils=require("./utils"),characterParser=require("character-parser"),Lexer=module.exports=function(t,n){this.input=t.replace(/\r\n|\r/g,"\n"),this.filename=n,this.deferredTokens=[],this.lastIndents=0,this.lineno=1,this.stash=[],this.indentStack=[],this.indentRe=null,this.pipeless=!1};Lexer.prototype={tok:function(e,t){return{type:e,line:this.lineno,val:t}},consume:function(e){this.input=this.input.substr(e)},scan:function(e,t){var n;if(n=e.exec(this.input))return this.consume(n[0].length),this.tok(t,n[1])},defer:function(e){this.deferredTokens.push(e)},lookahead:function(e){var t=e-this.stash.length;while(t-->0)this.stash.push(this.next());return this.stash[--e]},bracketExpression:function(e){e=e||0;var t=this.input[e];if(t!="("&&t!="{"&&t!="[")throw new Error("unrecognized start character");var n={"(":")","{":"}","[":"]"}[t],r=characterParser.parseMax(this.input,{start:e+1});if(this.input[r.end]!==n)throw new Error("start character "+t+" does not match end character "+this.input[r.end]);return r},stashed:function(){return this.stash.length&&this.stash.shift()},deferred:function(){return this.deferredTokens.length&&this.deferredTokens.shift()},eos:function(){if(this.input.length)return;return this.indentStack.length?(this.indentStack.shift(),this.tok("outdent")):this.tok("eos")},blank:function(){var e;if(e=/^\n *\n/.exec(this.input))return this.consume(e[0].length-1),++this.lineno,this.pipeless?this.tok("text",""):this.next()},comment:function(){var e;if(e=/^\/\/(-)?([^\n]*)/.exec(this.input)){this.consume(e[0].length);var t=this.tok("comment",e[2]);return t.buffer="-"!=e[1],this.pipeless=!0,t}},interpolation:function(){if(/^#\{/.test(this.input)){var e=this.bracketExpression(1);return this.consume(e.end+1),this.tok("interpolation",e.src)}},tag:function(){var e;if(e=/^(\w[-:\w]*)(\/?)/.exec(this.input)){this.consume(e[0].length);var t,n=e[1];if(":"==n[n.length-1]){n=n.slice(0,-1),t=this.tok("tag",n),this.defer(this.tok(":")),this.input[0]!==" "&&console.warn("Warning: space required after `:` on line "+this.lineno+' of jade file "'+this.filename+'"');while(" "==this.input[0])this.input=this.input.substr(1)}else t=this.tok("tag",n);return t.selfClosing=!!e[2],t}},filter:function(){var e=this.scan(/^:([\w\-]+)/,"filter");if(e)return this.pipeless=!0,e},doctype:function(){if(this.scan(/^!!! *([^\n]+)?/,"doctype"))throw new Error("`!!!` is deprecated, you must now use `doctype`");var e=this.scan(/^(?:doctype) *([^\n]+)?/,"doctype");if(e&&e.val&&e.val.trim()==="5")throw new Error("`doctype 5` is deprecated, you must now use `doctype html`");return e},id:function(){return this.scan(/^#([\w-]+)/,"id")},className:function(){return this.scan(/^\.([\w-]+)/,"class")},text:function(){return this.scan(/^(?:\| ?| )([^\n]+)/,"text")||this.scan(/^\|?( )/,"text")||this.scan(/^(<[^\n]*)/,"text")},textFail:function(){var e;if(e=this.scan(/^([^\.\n][^\n]+)/,"text"))return console.warn("Warning: missing space before text for line "+this.lineno+' of jade file "'+this.filename+'"'),e},dot:function(){var e;if(e=this.scan(/^\./,"dot"))return this.pipeless=!0,e},"extends":function(){return this.scan(/^extends? +([^\n]+)/,"extends")},prepend:function(){var e;if(e=/^prepend +([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t="prepend",n=e[1],r=this.tok("block",n);return r.mode=t,r}},append:function(){var e;if(e=/^append +([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t="append",n=e[1],r=this.tok("block",n);return r.mode=t,r}},block:function(){var e;if(e=/^block\b *(?:(prepend|append) +)?([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t=e[1]||"replace",n=e[2],r=this.tok("block",n);return r.mode=t,r}},mixinBlock:function(){var e;if(e=/^block[ \t]*(\n|$)/.exec(this.input))return this.consume(e[0].length-e[1].length),this.tok("mixin-block")},yield:function(){return this.scan(/^yield */,"yield")},include:function(){return this.scan(/^include +([^\n]+)/,"include")},includeFiltered:function(){var e;if(e=/^include:([\w\-]+)([\( ])/.exec(this.input)){this.consume(e[0].length-1);var t=e[1],n=e[2]==="("?this.attrs():null;if(e[2]!==" "&&this.input[0]!==" ")throw new Error("expected space after include:filter but got "+utils.stringify(this.input[0]));e=/^ *([^\n]+)/.exec(this.input);if(!e||e[1].trim()==="")throw new Error("missing path for include:filter");this.consume(e[0].length);var r=e[1],i=this.tok("include",r);return i.filter=t,i.attrs=n,i}},"case":function(){return this.scan(/^case +([^\n]+)/,"case")},when:function(){return this.scan(/^when +([^:\n]+)/,"when")},"default":function(){return this.scan(/^default */,"default")},call:function(){var e,t;if(t=/^\+(\s*)(([-\w]+)|(#\{))/.exec(this.input)){if(t[3])this.consume(t[0].length),e=this.tok("call",t[3]);else{var n=this.bracketExpression(2+t[1].length);this.consume(n.end+1),assertExpression(n.src),e=this.tok("call","#{"+n.src+"}")}if(t=/^ *\(/.exec(this.input)){var r=this.bracketExpression(t[0].length-1);/^\s*[-\w]+ *=/.test(r.src)||(this.consume(r.end+1),e.args=r.src),e.args&&assertExpression("["+e.args+"]")}return e}},mixin:function(){var e;if(e=/^mixin +([-\w]+)(?: *\((.*)\))? */.exec(this.input)){this.consume(e[0].length);var t=this.tok("mixin",e[1]);return t.args=e[2],t}},conditional:function(){var e;if(e=/^(if|unless|else if|else)\b([^\n]*)/.exec(this.input)){this.consume(e[0].length);var t=e[1],n=e[2],r=!1,i=!1;switch(t){case"if":assertExpression(n),n="if ("+n+")",r=!0;break;case"unless":assertExpression(n),n="if (!("+n+"))",r=!0;break;case"else if":assertExpression(n),n="else if ("+n+")",r=!0,i=!0;break;case"else":if(n&&n.trim())throw new Error("`else` cannot have a condition, perhaps you meant `else if`");n="else",i=!0}var s=this.tok("code",n);return s.isElse=i,s.isIf=r,s.requiresBlock=!0,s}},"while":function(){var e;if(e=/^while +([^\n]+)/.exec(this.input)){this.consume(e[0].length),assertExpression(e[1]);var t=this.tok("code","while ("+e[1]+")");return t.requiresBlock=!0,t}},each:function(){var e;if(e=/^(?:- *)?(?:each|for) +([a-zA-Z_$][\w$]*)(?: *, *([a-zA-Z_$][\w$]*))? * in *([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t=this.tok("each",e[1]);return t.key=e[2]||"$index",assertExpression(e[3]),t.code=e[3],t}},code:function(){var e;if(e=/^(!?=|-)[ \t]*([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t=e[1];e[1]=e[2];var n=this.tok("code",e[1]);return n.escape=t.charAt(0)==="=",n.buffer=t.charAt(0)==="="||t.charAt(1)==="=",n.buffer&&assertExpression(e[1]),n}},attrs:function(){if("("==this.input.charAt(0)){var e=this.bracketExpression().end,t=this.input.substr(1,e-1),n=this.tok("attrs");assertNestingCorrect(t);var r="",i=function(e){return e.replace(/(\\)?#\{(.+)/g,function(e,t,n){if(t)return e;try{var s=characterParser.parseMax(n);return n[s.end]!=="}"?e.substr(0,2)+i(e.substr(2)):(assertExpression(s.src),r+" + ("+s.src+") + "+r+i(n.substr(s.end+1)))}catch(o){return e.substr(0,2)+i(e.substr(2))}})};this.consume(e+1),n.attrs=[];var s=!0,o="",u="",a="",f=characterParser.defaultState(),l="key",c=function(e){if(o.trim()==="")return!1;if(e===t.length)return!0;if(l==="key"){if(t[e]===" "||t[e]==="\n")for(var n=e;n<t.length;n++)if(t[n]!=" "&&t[n]!="\n")return t[n]==="="||t[n]==="!"||t[n]===","?!1:!0;return t[e]===","}if(l==="value"&&!f.isNesting())try{assertExpression(u);if(t[e]===" "||t[e]==="\n")for(var n=e;n<t.length;n++)if(t[n]!=" "&&t[n]!="\n")return characterParser.isPunctuator(t[n])&&t[n]!='"'&&t[n]!="'"?!1:!0;return t[e]===","}catch(r){return!1}};this.lineno+=t.split("\n").length-1;for(var h=0;h<=t.length;h++)if(c(h))u=u.trim(),u&&assertExpression(u),o=o.trim(),o=o.replace(/^['"]|['"]$/g,""),n.attrs.push({name:o,val:""==u?!0:u,escaped:s}),o=u="",l="key",s=!1;else switch(l){case"key-char":if(t[h]===r){l="key";if(h+1<t.length&&[" ",",","!","=","\n"].indexOf(t[h+1])===-1)throw new Error("Unexpected character "+t[h+1]+" expected ` `, `\\n`, `,`, `!` or `=`")}else o+=t[h];break;case"key":if(o!==""||t[h]!=='"'&&t[h]!=="'")if(t[h]==="!"||t[h]==="="){s=t[h]!=="!",t[h]==="!"&&h++;if(t[h]!=="=")throw new Error("Unexpected character "+t[h]+" expected `=`");l="value",f=characterParser.defaultState()}else o+=t[h];else l="key-char",r=t[h];break;case"value":f=characterParser.parseChar(t[h],f),f.isString()?(l="string",r=t[h],a=t[h]):u+=t[h];break;case"string":f=characterParser.parseChar(t[h],f),a+=t[h],f.isString()||(l="value",u+=i(a))}return"/"==this.input.charAt(0)&&(this.consume(1),n.selfClosing=!0),n}},attributesBlock:function(){var e;if(/^&attributes\b/.test(this.input)){this.consume(11);var t=this.bracketExpression();return this.consume(t.end+1),this.tok("&attributes",t.src)}},indent:function(){var e,t;this.indentRe?e=this.indentRe.exec(this.input):(t=/^\n(\t*) */,e=t.exec(this.input),e&&!e[1].length&&(t=/^\n( *)/,e=t.exec(this.input)),e&&e[1].length&&(this.indentRe=t));if(e){var n,r=e[1].length;++this.lineno,this.consume(r+1);if(" "==this.input[0]||"	"==this.input[0])throw new Error("Invalid indentation, you can use tabs or spaces but not both");if("\n"==this.input[0])return this.pipeless=!1,this.tok("newline");if(this.indentStack.length&&r<this.indentStack[0]){while(this.indentStack.length&&this.indentStack[0]>r)this.stash.push(this.tok("outdent")),this.indentStack.shift();n=this.stash.pop()}else r&&r!=this.indentStack[0]?(this.indentStack.unshift(r),n=this.tok("indent",r)):n=this.tok("newline");return this.pipeless=!1,n}},pipelessText:function(){if(!this.pipeless)return;var e,t;this.indentRe?e=this.indentRe.exec(this.input):(t=/^\n(\t*) */,e=t.exec(this.input),e&&!e[1].length&&(t=/^\n( *)/,e=t.exec(this.input)),e&&e[1].length&&(this.indentRe=t));var n=e&&e[1].length;if(n&&(this.indentStack.length===0||n>this.indentStack[0])){var r=e[1],i,s=[],o;do{var u=this.input.substr(1).indexOf("\n");-1==u&&(u=this.input.length-1);var a=this.input.substr(1,u);o=a.substr(0,r.length)===r||!a.trim(),o&&(this.consume(a.length+1),s.push(a.substr(r.length)))}while(this.input.length&&o);while(this.input.length===0&&s[s.length-1]==="")s.pop();return this.tok("pipeless-text",s)}},colon:function(){var e=/^: +/.test(this.input),t=this.scan(/^: */,":");return t&&!e&&console.warn("Warning: space required after `:` on line "+this.lineno+' of jade file "'+this.filename+'"'),t},fail:function(){throw new Error("unexpected text "+this.input.substr(0,5))},advance:function(){return this.stashed()||this.next()},next:function(){return this.deferred()||this.blank()||this.eos()||this.pipelessText()||this.yield()||this.doctype()||this.interpolation()||this["case"]()||this.when()||this["default"]()||this["extends"]()||this.append()||this.prepend()||this.block()||this.mixinBlock()||this.include()||this.includeFiltered()||this.mixin()||this.call()||this.conditional()||this.each()||this["while"]()||this.tag()||this.filter()||this.code()||this.id()||this.className()||this.attrs()||this.attributesBlock()||this.indent()||this.text()||this.comment()||this.colon()||this.dot()||this.textFail()||this.fail()}};