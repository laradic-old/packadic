function getRunner(){var e=__dirname+"/../bin/jade.js";return isIstanbul?["istanbul","cover","--print","none","--report","none","--root",process.cwd(),"--dir",process.cwd()+"/cov-pt"+covCount++,e,"--"]:["node",e]}function run(e,t,n){arguments.length===2&&(n=t,t=null);var r=getRunner().join(" ");cp.exec((t||"")+r+" "+e,{cwd:__dirname+"/temp"},n)}function timing(e){isIstanbul?(e.timeout(2e4),e.slow(3e3)):(e.timeout(12500),e.slow(2e3))}var fs=require("fs"),path=require("path"),assert=require("assert"),cp=require("child_process"),covCount=1,isIstanbul=process.env.running_under_istanbul;try{fs.mkdirSync(__dirname+"/temp")}catch(ex){if(ex.code!=="EEXIST")throw ex}describe("command line",function(){timing(this),it("jade --version",function(e){run("-V",function(t,n){t&&e(t),assert.equal(n.trim(),require("../package.json").version),run("--version",function(t,n){t&&e(t),assert.equal(n.trim(),require("../package.json").version),e()})})}),it("jade --help",function(e){run("-h",function(t,n){t&&e(t),run("--help",function(t,n){t&&e(t),e()})})})}),describe("command line with HTML output",function(){timing(this),it("jade --no-debug input.jade",function(e){fs.writeFileSync(__dirname+"/temp/input.jade",".foo bar"),fs.writeFileSync(__dirname+"/temp/input.html","<p>output not written</p>"),run("--no-debug input.jade",function(t){if(t)return e(t);var n=fs.readFileSync(__dirname+"/temp/input.html","utf8");assert(n==='<div class="foo">bar</div>'),e()})}),it("jade --no-debug -E special-html input.jade",function(e){fs.writeFileSync(__dirname+"/temp/input.jade",".foo bar"),fs.writeFileSync(__dirname+"/temp/input.special-html","<p>output not written</p>"),run("--no-debug -E special-html input.jade",function(t){if(t)return e(t);var n=fs.readFileSync(__dirname+"/temp/input.special-html","utf8");assert(n==='<div class="foo">bar</div>'),e()})}),it("jade --no-debug --obj \"{'loc':'str'}\" input.jade",function(e){fs.writeFileSync(__dirname+"/temp/input.jade",".foo= loc"),fs.writeFileSync(__dirname+"/temp/input.html","<p>output not written</p>"),run("--no-debug --obj \"{'loc':'str'}\" input.jade",function(t){if(t)return e(t);var n=fs.readFileSync(__dirname+"/temp/input.html","utf8");assert(n==='<div class="foo">str</div>'),e()})}),it('jade --no-debug --obj "obj.json" input.jade',function(e){fs.writeFileSync(__dirname+"/temp/obj.json",'{"loc":"str"}'),fs.writeFileSync(__dirname+"/temp/input.jade",".foo= loc"),fs.writeFileSync(__dirname+"/temp/input.html","<p>output not written</p>"),run('--no-debug --obj "'+__dirname+'/temp/obj.json" input.jade',function(t){if(t)return e(t);var n=fs.readFileSync(__dirname+"/temp/input.html","utf8");assert(n==='<div class="foo">str</div>'),e()})}),it("cat input.jade | jade --no-debug",function(e){fs.writeFileSync(__dirname+"/temp/input.jade",".foo bar"),run("--no-debug","cat input.jade | ",function(t,n,r){if(t)return e(t);assert(n==='<div class="foo">bar</div>'),e()})})}),describe("command line with client JS output",function(){timing(this),it("jade --no-debug --client --name myTemplate input.jade",function(e){fs.writeFileSync(__dirname+"/temp/input.jade",".foo bar"),fs.writeFileSync(__dirname+"/temp/input.js",'throw new Error("output not written");'),run("--no-debug --client --name myTemplate input.jade",function(t){if(t)return e(t);var n=Function("",fs.readFileSync(__dirname+"/temp/input.js","utf8")+";return myTemplate;")();assert(n()==='<div class="foo">bar</div>'),e()})}),it("jade --no-debug --client -E special-js --name myTemplate input.jade",function(e){fs.writeFileSync(__dirname+"/temp/input.jade",".foo bar"),fs.writeFileSync(__dirname+"/temp/input.special-js",'throw new Error("output not written");'),run("--no-debug --client -E special-js --name myTemplate input.jade",function(t){if(t)return e(t);var n=Function("",fs.readFileSync(__dirname+"/temp/input.special-js","utf8")+";return myTemplate;")();assert(n()==='<div class="foo">bar</div>'),e()})}),it("cat input.jade | jade --no-debug --client --name myTemplate",function(e){fs.writeFileSync(__dirname+"/temp/input.jade",".foo bar"),fs.writeFileSync(__dirname+"/temp/input.js",'throw new Error("output not written");'),run("--no-debug --client --name myTemplate","cat input.jade | ",function(t,n){if(t)return e(t);var r=Function("",n+";return myTemplate;")();assert(r()==='<div class="foo">bar</div>'),e()})}),it("jade --no-debug --client --name-after-file input-file.jade",function(e){fs.writeFileSync(__dirname+"/temp/input-file.jade",".foo bar"),fs.writeFileSync(__dirname+"/temp/input-file.js",'throw new Error("output not written");'),run("--no-debug --client --name-after-file input-file.jade",function(t,n,r){if(t)return e(t);var i=Function("",fs.readFileSync(__dirname+"/temp/input-file.js","utf8")+";return inputFileTemplate;")();return assert(i()==='<div class="foo">bar</div>'),e()})}),it("jade --no-debug --client --name-after-file _InPuTwIthWEiRdNaMME.jade",function(e){fs.writeFileSync(__dirname+"/temp/_InPuTwIthWEiRdNaMME.jade",".foo bar"),fs.writeFileSync(__dirname+"/temp/_InPuTwIthWEiRdNaMME.js",'throw new Error("output not written");'),run("--no-debug --client --name-after-file _InPuTwIthWEiRdNaMME.jade",function(t,n,r){if(t)return e(t);var i=Function("",fs.readFileSync(__dirname+"/temp/_InPuTwIthWEiRdNaMME.js","utf8")+";return InputwithweirdnammeTemplate;")();return assert(i()==='<div class="foo">bar</div>'),e()})})}),describe("command line watch mode",function(){var e,t="";after(function(){if(!e)return;e.stderr.removeAllListeners("data"),e.stdout.removeAllListeners("data"),e.removeAllListeners("error"),e.removeAllListeners("close"),e.kill("SIGINT")}),afterEach(function(e){setTimeout(e,1e3)}),it("jade --no-debug --client --name-after-file --watch input-file.jade (pass 1)",function(n){timing(this),fs.writeFileSync(__dirname+"/temp/input-file.jade",".foo bar"),fs.writeFileSync(__dirname+"/temp/input-file.js",'throw new Error("output not written (pass 1)");');var r=getRunner();r.push.apply(r,["--no-debug","--client","--name-after-file","--watch","input-file.jade"]),e=cp.spawn(r[0],r.slice(1),{cwd:__dirname+"/temp"}),e.stdout.setEncoding("utf8"),e.stderr.setEncoding("utf8"),e.on("error",n).stdout.on("data",function(r){t+=r;if(/.*rendered.*/.test(t)){t="";var i=Function("",fs.readFileSync(__dirname+"/temp/input-file.js","utf8")+";return inputFileTemplate;")();return assert(i()==='<div class="foo">bar</div>'),e.stdout.removeAllListeners("data"),e.removeAllListeners("error"),n()}})}),it("jade --no-debug --client --name-after-file --watch input-file.jade (pass 2)",function(n){e.stdout.removeAllListeners("data"),e.removeAllListeners("error"),fs.writeFileSync(__dirname+"/temp/input-file.js",'throw new Error("output not written (pass 2)");'),fs.writeFileSync(__dirname+"/temp/input-file.jade",".foo baz"),e.on("error",n).stdout.on("data",function(r){t+=r;if(/.*rendered.*/.test(t)){t="";var i=Function("",fs.readFileSync(__dirname+"/temp/input-file.js","utf8")+";return inputFileTemplate;")();return assert(i()==='<div class="foo">baz</div>'),e.stdout.removeAllListeners("data"),e.removeAllListeners("error"),n()}})}),it("jade --no-debug --client --name-after-file --watch input-file.jade (intentional errors in the jade file)",function(n){e.stdout.removeAllListeners("data"),e.removeAllListeners("error");var r="",i=!1;e.on("error",n).on("close",function(){return i=!0,n(new Error("Jade should not terminate in watch mode"))}).stdout.on("data",function(e){t+=e;if(/.*rendered.*/.test(t))return t="",n(new Error("Jade compiles an erroneous file w/o error"))}),e.stderr.on("data",function(t){r+=t;if(!/.*Invalid indentation.*/.test(r))return;r="";var s=Function("",fs.readFileSync(__dirname+"/temp/input-file.js","utf8")+";return inputFileTemplate;")();assert(s()==='<div class="foo">baz</div>'),e.stderr.removeAllListeners("data"),e.stdout.removeAllListeners("data"),e.removeAllListeners("error"),e.removeAllListeners("exit"),setTimeout(function(){i||n()},100)}),fs.writeFileSync(__dirname+"/temp/input-file.jade",fs.readFileSync(__dirname+"/anti-cases/tabs-and-spaces.jade"))})});